var rs=Object.create;var Lt=Object.defineProperty;var is=Object.getOwnPropertyDescriptor;var as=Object.getOwnPropertyNames;var ss=Object.getPrototypeOf,us=Object.prototype.hasOwnProperty;var cs=(n,t,e)=>t in n?Lt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var Pe=(n=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(n,{get:(t,e)=>(typeof require!="undefined"?require:t)[e]}):n)(function(n){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+n+'" is not supported')});var ls=(n,t)=>()=>(t||n((t={exports:{}}).exports,t),t.exports),et=(n,t)=>{for(var e in t)Lt(n,e,{get:t[e],enumerable:!0})},ps=(n,t,e,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of as(t))!us.call(n,r)&&r!==e&&Lt(n,r,{get:()=>t[r],enumerable:!(o=is(t,r))||o.enumerable});return n};var ei=(n,t,e)=>(e=n!=null?rs(ss(n)):{},ps(t||!n||!n.__esModule?Lt(e,"default",{value:n,enumerable:!0}):e,n));var p=(n,t,e)=>(cs(n,typeof t!="symbol"?t+"":t,e),e),ti=(n,t,e)=>{if(!t.has(n))throw TypeError("Cannot "+e)};var ni=(n,t,e)=>(ti(n,t,"read from private field"),e?e.call(n):t.get(n)),oi=(n,t,e)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,e)},ri=(n,t,e,o)=>(ti(n,t,"write to private field"),o?o.call(n,e):t.set(n,e),e);var Mr=ls((qg,Er)=>{"use strict";var g={};g.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)};g.localCName=g.generateIdentifier();g.splitLines=function(n){return n.trim().split(`
`).map(t=>t.trim())};g.splitSections=function(n){return n.split(`
m=`).map((e,o)=>(o>0?"m="+e:e).trim()+`\r
`)};g.getDescription=function(n){let t=g.splitSections(n);return t&&t[0]};g.getMediaSections=function(n){let t=g.splitSections(n);return t.shift(),t};g.matchPrefix=function(n,t){return g.splitLines(n).filter(e=>e.indexOf(t)===0)};g.parseCandidate=function(n){let t;n.indexOf("a=candidate:")===0?t=n.substring(12).split(" "):t=n.substring(10).split(" ");let e={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let o=8;o<t.length;o+=2)switch(t[o]){case"raddr":e.relatedAddress=t[o+1];break;case"rport":e.relatedPort=parseInt(t[o+1],10);break;case"tcptype":e.tcpType=t[o+1];break;case"ufrag":e.ufrag=t[o+1],e.usernameFragment=t[o+1];break;default:e[t[o]]===void 0&&(e[t[o]]=t[o+1]);break}return e};g.writeCandidate=function(n){let t=[];t.push(n.foundation);let e=n.component;e==="rtp"?t.push(1):e==="rtcp"?t.push(2):t.push(e),t.push(n.protocol.toUpperCase()),t.push(n.priority),t.push(n.address||n.ip),t.push(n.port);let o=n.type;return t.push("typ"),t.push(o),o!=="host"&&n.relatedAddress&&n.relatedPort&&(t.push("raddr"),t.push(n.relatedAddress),t.push("rport"),t.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(t.push("tcptype"),t.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(t.push("ufrag"),t.push(n.usernameFragment||n.ufrag)),"candidate:"+t.join(" ")};g.parseIceOptions=function(n){return n.substr(14).split(" ")};g.parseRtpMap=function(n){let t=n.substr(9).split(" "),e={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),e.name=t[0],e.clockRate=parseInt(t[1],10),e.channels=t.length===3?parseInt(t[2],10):1,e.numChannels=e.channels,e};g.writeRtpMap=function(n){let t=n.payloadType;n.preferredPayloadType!==void 0&&(t=n.preferredPayloadType);let e=n.channels||n.numChannels||1;return"a=rtpmap:"+t+" "+n.name+"/"+n.clockRate+(e!==1?"/"+e:"")+`\r
`};g.parseExtmap=function(n){let t=n.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}};g.writeExtmap=function(n){return"a=extmap:"+(n.id||n.preferredId)+(n.direction&&n.direction!=="sendrecv"?"/"+n.direction:"")+" "+n.uri+`\r
`};g.parseFmtp=function(n){let t={},e,o=n.substr(n.indexOf(" ")+1).split(";");for(let r=0;r<o.length;r++)e=o[r].trim().split("="),t[e[0].trim()]=e[1];return t};g.writeFmtp=function(n){let t="",e=n.payloadType;if(n.preferredPayloadType!==void 0&&(e=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){let o=[];Object.keys(n.parameters).forEach(r=>{n.parameters[r]!==void 0?o.push(r+"="+n.parameters[r]):o.push(r)}),t+="a=fmtp:"+e+" "+o.join(";")+`\r
`}return t};g.parseRtcpFb=function(n){let t=n.substr(n.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}};g.writeRtcpFb=function(n){let t="",e=n.payloadType;return n.preferredPayloadType!==void 0&&(e=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach(o=>{t+="a=rtcp-fb:"+e+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),t};g.parseSsrcMedia=function(n){let t=n.indexOf(" "),e={ssrc:parseInt(n.substr(7,t-7),10)},o=n.indexOf(":",t);return o>-1?(e.attribute=n.substr(t+1,o-t-1),e.value=n.substr(o+1)):e.attribute=n.substr(t+1),e};g.parseSsrcGroup=function(n){let t=n.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(e=>parseInt(e,10))}};g.getMid=function(n){let t=g.matchPrefix(n,"a=mid:")[0];if(t)return t.substr(6)};g.parseFingerprint=function(n){let t=n.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}};g.getDtlsParameters=function(n,t){let e=g.matchPrefix(n+t,"a=fingerprint:");return{role:"auto",fingerprints:e.map(g.parseFingerprint)}};g.writeDtlsParameters=function(n,t){let e="a=setup:"+t+`\r
`;return n.fingerprints.forEach(o=>{e+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),e};g.parseCryptoLine=function(n){let t=n.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}};g.writeCryptoLine=function(n){return"a=crypto:"+n.tag+" "+n.cryptoSuite+" "+(typeof n.keyParams=="object"?g.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+`\r
`};g.parseCryptoKeyParams=function(n){if(n.indexOf("inline:")!==0)return null;let t=n.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}};g.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")};g.getCryptoParameters=function(n,t){return g.matchPrefix(n+t,"a=crypto:").map(g.parseCryptoLine)};g.getIceParameters=function(n,t){let e=g.matchPrefix(n+t,"a=ice-ufrag:")[0],o=g.matchPrefix(n+t,"a=ice-pwd:")[0];return e&&o?{usernameFragment:e.substr(12),password:o.substr(10)}:null};g.writeIceParameters=function(n){let t="a=ice-ufrag:"+n.usernameFragment+`\r
a=ice-pwd:`+n.password+`\r
`;return n.iceLite&&(t+=`a=ice-lite\r
`),t};g.parseRtpParameters=function(n){let t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},o=g.splitLines(n)[0].split(" ");for(let r=3;r<o.length;r++){let i=o[r],a=g.matchPrefix(n,"a=rtpmap:"+i+" ")[0];if(a){let s=g.parseRtpMap(a),u=g.matchPrefix(n,"a=fmtp:"+i+" ");switch(s.parameters=u.length?g.parseFmtp(u[0]):{},s.rtcpFeedback=g.matchPrefix(n,"a=rtcp-fb:"+i+" ").map(g.parseRtcpFb),t.codecs.push(s),s.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(s.name.toUpperCase());break;default:break}}}return g.matchPrefix(n,"a=extmap:").forEach(r=>{t.headerExtensions.push(g.parseExtmap(r))}),t};g.writeRtpDescription=function(n,t){let e="";e+="m="+n+" ",e+=t.codecs.length>0?"9":"0",e+=" UDP/TLS/RTP/SAVPF ",e+=t.codecs.map(r=>r.preferredPayloadType!==void 0?r.preferredPayloadType:r.payloadType).join(" ")+`\r
`,e+=`c=IN IP4 0.0.0.0\r
`,e+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,t.codecs.forEach(r=>{e+=g.writeRtpMap(r),e+=g.writeFmtp(r),e+=g.writeRtcpFb(r)});let o=0;return t.codecs.forEach(r=>{r.maxptime>o&&(o=r.maxptime)}),o>0&&(e+="a=maxptime:"+o+`\r
`),t.headerExtensions&&t.headerExtensions.forEach(r=>{e+=g.writeExtmap(r)}),e};g.parseRtpEncodingParameters=function(n){let t=[],e=g.parseRtpParameters(n),o=e.fecMechanisms.indexOf("RED")!==-1,r=e.fecMechanisms.indexOf("ULPFEC")!==-1,i=g.matchPrefix(n,"a=ssrc:").map(l=>g.parseSsrcMedia(l)).filter(l=>l.attribute==="cname"),a=i.length>0&&i[0].ssrc,s,u=g.matchPrefix(n,"a=ssrc-group:FID").map(l=>l.substr(17).split(" ").map(h=>parseInt(h,10)));u.length>0&&u[0].length>1&&u[0][0]===a&&(s=u[0][1]),e.codecs.forEach(l=>{if(l.name.toUpperCase()==="RTX"&&l.parameters.apt){let F={ssrc:a,codecPayloadType:parseInt(l.parameters.apt,10)};a&&s&&(F.rtx={ssrc:s}),t.push(F),o&&(F=JSON.parse(JSON.stringify(F)),F.fec={ssrc:a,mechanism:r?"red+ulpfec":"red"},t.push(F))}}),t.length===0&&a&&t.push({ssrc:a});let c=g.matchPrefix(n,"b=");return c.length&&(c[0].indexOf("b=TIAS:")===0?c=parseInt(c[0].substr(7),10):c[0].indexOf("b=AS:")===0?c=parseInt(c[0].substr(5),10)*1e3*.95-50*40*8:c=void 0,t.forEach(l=>{l.maxBitrate=c})),t};g.parseRtcpParameters=function(n){let t={},e=g.matchPrefix(n,"a=ssrc:").map(i=>g.parseSsrcMedia(i)).filter(i=>i.attribute==="cname")[0];e&&(t.cname=e.value,t.ssrc=e.ssrc);let o=g.matchPrefix(n,"a=rtcp-rsize");t.reducedSize=o.length>0,t.compound=o.length===0;let r=g.matchPrefix(n,"a=rtcp-mux");return t.mux=r.length>0,t};g.writeRtcpParameters=function(n){let t="";return n.reducedSize&&(t+=`a=rtcp-rsize\r
`),n.mux&&(t+=`a=rtcp-mux\r
`),n.ssrc!==void 0&&n.cname&&(t+="a=ssrc:"+n.ssrc+" cname:"+n.cname+`\r
`),t};g.parseMsid=function(n){let t,e=g.matchPrefix(n,"a=msid:");if(e.length===1)return t=e[0].substr(7).split(" "),{stream:t[0],track:t[1]};let o=g.matchPrefix(n,"a=ssrc:").map(r=>g.parseSsrcMedia(r)).filter(r=>r.attribute==="msid");if(o.length>0)return t=o[0].value.split(" "),{stream:t[0],track:t[1]}};g.parseSctpDescription=function(n){let t=g.parseMLine(n),e=g.matchPrefix(n,"a=max-message-size:"),o;e.length>0&&(o=parseInt(e[0].substr(19),10)),isNaN(o)&&(o=65536);let r=g.matchPrefix(n,"a=sctp-port:");if(r.length>0)return{port:parseInt(r[0].substr(12),10),protocol:t.fmt,maxMessageSize:o};let i=g.matchPrefix(n,"a=sctpmap:");if(i.length>0){let a=i[0].substr(10).split(" ");return{port:parseInt(a[0],10),protocol:a[1],maxMessageSize:o}}};g.writeSctpDescription=function(n,t){let e=[];return n.protocol!=="DTLS/SCTP"?e=["m="+n.kind+" 9 "+n.protocol+" "+t.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+t.port+`\r
`]:e=["m="+n.kind+" 9 "+n.protocol+" "+t.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+t.port+" "+t.protocol+` 65535\r
`],t.maxMessageSize!==void 0&&e.push("a=max-message-size:"+t.maxMessageSize+`\r
`),e.join("")};g.generateSessionId=function(){return Math.random().toString().substr(2,21)};g.writeSessionBoilerplate=function(n,t,e){let o,r=t!==void 0?t:2;return n?o=n:o=g.generateSessionId(),`v=0\r
o=`+(e||"thisisadapterortc")+" "+o+" "+r+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`};g.getDirection=function(n,t){let e=g.splitLines(n);for(let o=0;o<e.length;o++)switch(e[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return e[o].substr(2);default:}return t?g.getDirection(t):"sendrecv"};g.getKind=function(n){return g.splitLines(n)[0].split(" ")[0].substr(2)};g.isRejected=function(n){return n.split(" ",2)[1]==="0"};g.parseMLine=function(n){let e=g.splitLines(n)[0].substr(2).split(" ");return{kind:e[0],port:parseInt(e[1],10),protocol:e[2],fmt:e.slice(3).join(" ")}};g.parseOLine=function(n){let e=g.matchPrefix(n,"o=")[0].substr(2).split(" ");return{username:e[0],sessionId:e[1],sessionVersion:parseInt(e[2],10),netType:e[3],addressType:e[4],address:e[5]}};g.isValidSDP=function(n){if(typeof n!="string"||n.length===0)return!1;let t=g.splitLines(n);for(let e=0;e<t.length;e++)if(t[e].length<2||t[e].charAt(1)!=="=")return!1;return!0};typeof Er=="object"&&(Er.exports=g)});function Fs(n){return n}function ii(n,t,e){let o=0,r=n.length,i=Math.floor((o+r)/2),a=!1;for(;o<r&&i<n.length;){let s=n[i],u=T(s)?null:e(s);d(u)&&t<u?r=i:(t===u&&(a=!0),o=i+1),i=Math.floor((o+r)/2)}return a||(i+=.5),i}function Ro(n,t,e){e=e||Fs;let o=e(t);return ii(n,o,e)}function tt(n,t){return n.splice(t,1)[0]}function ue(n){return n.splice(0)}function ai(n,t){for(let e=0;e<n.length;++e)if(n[e]!==t[e])return e;return-1}function Bt(n,t,e){n.splice(e,0,t)}function ee(n,t){let e=n.indexOf(t);return e>-1?(tt(n,e),!0):!1}function si(n,...t){for(let e of t)for(let o of n)if(e(o))return o;return null}function ui(n,t,e,o){let r;return W(e)?r=e:O(e)&&(o=e),T(o)&&(o=!0),ms(n,t,r,o)}function ms(n,t,e,o){let r=Ro(n,t,e),i=r%1===0;return r=r|0,(!i||o)&&Bt(n,t,r),r}var nt=class{constructor(t){this.value=t;p(this,"_forward",new Array);p(this,"_reverse",new Array)}connectSorted(t,e){d(e)?(ui(this._forward,t,o=>e(o.value)),t._reverse.push(this)):this.connectTo(t)}connectTo(t){this.connectAt(t,this._forward.length)}connectAt(t,e){Bt(this._forward,t,e),t._reverse.push(this)}disconnectFrom(t){ee(this._forward,t),ee(t._reverse,this)}isConnectedTo(t){return this._forward.indexOf(t)>=0||this._reverse.indexOf(t)>=0}flatten(){let t=new Set,e=[this];for(;e.length>0;){let o=e.shift();d(o)&&!t.has(o)&&(t.add(o),e.push(...o._forward))}return Array.from(t)}get _isEntryPoint(){return this._reverse.length===0}get _isExitPoint(){return this._forward.length===0}get isDisconnected(){return this._isEntryPoint&&this._isExitPoint}get isConnected(){return!this._isExitPoint||!this._isEntryPoint}get isTerminus(){return this._isEntryPoint||this._isExitPoint}get isInternal(){return!this._isEntryPoint&&!this._isExitPoint}};var Rt=class extends nt{connectTo(t){super.connectTo(t)}connectAt(t,e){super.connectAt(t,e)}connectSorted(t,e){super.connectSorted(t,e)}disconnectFrom(t){super.disconnectFrom(t)}isConnectedTo(t){return super.isConnectedTo(t)}flatten(){return super.flatten()}get connections(){return this._forward}get isEntryPoint(){return this._isEntryPoint}get isExitPoint(){return this._isExitPoint}};var ci=class{constructor(t){p(this,"items",new Map);p(this,"defaultItems",new Array);if(d(t))for(let[e,o]of t)this.add(e,o)}add(t,e){if(T(t))this.defaultItems.push(e);else{let o=this.items.get(t);T(o)&&this.items.set(t,o=[]),o.push(e)}return this}entries(){return this.items.entries()}[Symbol.iterator](){return this.entries()}keys(){return this.items.keys()}*values(){for(let t of this.defaultItems)yield t;for(let t of this.items.values())for(let e of t)yield e}has(t){return d(t)?this.items.has(t):this.defaultItems.length>0}get(t){return T(t)?this.defaultItems:this.items.get(t)||[]}count(t){if(T(t))return this.defaultItems.length;let e=this.get(t);return d(e)?e.length:0}get size(){let t=this.defaultItems.length;for(let e of this.items.values())t+=e.length;return t}delete(t){return T(t)?ue(this.defaultItems).length>0:this.items.delete(t)}remove(t,e){if(T(t))ee(this.defaultItems,e);else{let o=this.items.get(t);d(o)&&(ee(o,e),o.length===0&&this.items.delete(t))}}clear(){this.items.clear(),ue(this.defaultItems)}};var Pt=class{constructor(){p(this,"listeners",new Map);p(this,"listenerOptions",new Map)}addEventListener(t,e,o){if(W(e)){let r=this.listeners.get(t);r||(r=new Array,this.listeners.set(t,r)),r.find(i=>i===e)||(r.push(e),o&&this.listenerOptions.set(e,o))}}removeEventListener(t,e){if(W(e)){let o=this.listeners.get(t);o&&this.removeListener(o,e)}}clearEventListeners(t){for(let[e,o]of this.listeners)if(T(t)||t===e){for(let r of o)this.removeEventListener(t,r);ue(o),this.listeners.delete(e)}}removeListener(t,e){let o=t.findIndex(r=>r===e);o>=0&&(tt(t,o),this.listenerOptions.has(e)&&this.listenerOptions.delete(e))}dispatchEvent(t){let e=this.listeners.get(t.type);if(e)for(let o of e){let r=this.listenerOptions.get(o);d(r)&&!O(r)&&r.once&&this.removeListener(e,o),o.call(this,t)}return!t.defaultPrevented}},Ee=class extends Event{get type(){return super.type}constructor(t){super(t)}},j=class extends Pt{constructor(){super(...arguments);p(this,"bubblers",new Set);p(this,"scopes",new WeakMap)}addBubbler(e){this.bubblers.add(e)}removeBubbler(e){this.bubblers.delete(e)}addEventListener(e,o,r){super.addEventListener(e,o,r)}removeEventListener(e,o){super.removeEventListener(e,o)}clearEventListeners(e){return super.clearEventListeners(e)}addScopedEventListener(e,o,r,i){this.scopes.has(e)||this.scopes.set(e,[]),this.scopes.get(e).push([o,r]),this.addEventListener(o,r,i)}removeScope(e){let o=this.scopes.get(e);if(o){this.scopes.delete(e);for(let[r,i]of o)this.removeEventListener(r,i)}}dispatchEvent(e){if(!super.dispatchEvent(e))return!1;for(let o of this.bubblers)if(!o.dispatchEvent(e))return!1;return!0}};var ce=class{constructor(t,e,o=!0){p(this,"promise");p(this,"_resolve",null);p(this,"_reject",null);p(this,"_result",null);p(this,"_error",null);p(this,"_started",!1);p(this,"_finished",!1);p(this,"resolve",null);p(this,"reject",null);let r=_t,i=_t;W(t)&&(r=t),W(e)&&(i=e),O(t)?o=t:O(e)&&(o=e),this.resolve=a=>{d(this._resolve)&&this._resolve(a)},this.reject=a=>{d(this._reject)&&this._reject(a)},this.promise=new Promise((a,s)=>{this._resolve=u=>{r(u)&&(this._result=u,this._finished=!0,a(u))},this._reject=u=>{i(u)&&(this._error=u,this._finished=!0,s(u))}}),o&&this.start()}get result(){if(d(this.error))throw this.error;return this._result}get error(){return this._error}get started(){return this._started}get finished(){return this._finished}start(){this._started=!0}get[Symbol.toStringTag](){return this.promise.toString()}then(t,e){return this.promise.then(t,e)}catch(t){return this.promise.catch(t)}finally(t){return this.promise.finally(t)}};var li=class{constructor(t,e,o){p(this,"promise");p(this,"callback",null);this.promise=new Promise((r,i)=>{this.callback=(...a)=>{t(...a)?r(e(...a)):i(o(...a))}})}get[Symbol.toStringTag](){return this.promise.toString()}then(t,e){return this.promise.then(t,e)}catch(t){return this.promise.catch(t)}finally(t){return this.promise.finally(t)}};function Po(n){let t=new ce(n),e=setInterval(()=>{n()&&(clearInterval(e),t.resolve())},100);return t}var gs=/OculusBrowser\/(\d+)\.(\d+)\.(\d+)/i,At=navigator.userAgent.match(gs),Ht=!!At,Ep=Ht&&{major:parseFloat(At[1]),minor:parseFloat(At[2]),patch:parseFloat(At[3])},Mp=Ht&&/pacific/i.test(navigator.userAgent),bp=Ht&&/quest/i.test(navigator.userAgent),Cp=Ht&&/quest 2/i.test(navigator.userAgent);var Dp=!("Document"in globalThis);var fs=298.257223563,xs=6378137;var _o=1/fs,Ot=1-_o,k=_o/(2-_o),vp=xs/(1+k)*(1+k*k/4+k*k*k*k/64),Wt=Math.sqrt(1-Ot*Ot),K=1-Ot*Ot,Lp=Wt*Wt/(1-Wt*Wt),Bp=1-K*(.25+K*(3/64+5*K/256)),Rp=K*(3/8+K*(3/32+45*K/1024)),Pp=K*K*(15/256+K*45/1024),_p=K*K*K*(35/3072),Ip=[k/2-2*k*k/3+37*k*k*k/96,k*k/48+k*k*k/15,17*k*k*k/480],Ap=[2*k-2*k*k/3,7*k*k/3-8*k*k*k/5,56*k*k*k/15];var Nt=1e-6,ot=typeof Float32Array!="undefined"?Float32Array:Array,Io=Math.random;var Wp=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var n=0,t=arguments.length;t--;)n+=arguments[t]*arguments[t];return Math.sqrt(n)});var _={};et(_,{add:()=>Ms,angle:()=>Ks,bezier:()=>Ws,ceil:()=>bs,clone:()=>ws,copy:()=>ks,create:()=>pi,cross:()=>Is,dist:()=>eu,distance:()=>gi,div:()=>Zs,divide:()=>hi,dot:()=>Si,equals:()=>Ys,exactEquals:()=>Js,floor:()=>Cs,forEach:()=>ru,fromValues:()=>Ts,hermite:()=>Hs,inverse:()=>Ps,len:()=>nu,length:()=>Fi,lerp:()=>As,max:()=>ys,min:()=>Ds,mul:()=>Xs,multiply:()=>di,negate:()=>Rs,normalize:()=>_s,random:()=>Os,rotateX:()=>Vs,rotateY:()=>Gs,rotateZ:()=>js,round:()=>vs,scale:()=>Ls,scaleAndAdd:()=>Bs,set:()=>Es,sqrDist:()=>tu,sqrLen:()=>ou,squaredDistance:()=>fi,squaredLength:()=>xi,str:()=>qs,sub:()=>Qs,subtract:()=>mi,transformMat3:()=>Us,transformMat4:()=>Ns,transformQuat:()=>zs,zero:()=>$s});function pi(){var n=new ot(3);return ot!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function ws(n){var t=new ot(3);return t[0]=n[0],t[1]=n[1],t[2]=n[2],t}function Fi(n){var t=n[0],e=n[1],o=n[2];return Math.hypot(t,e,o)}function Ts(n,t,e){var o=new ot(3);return o[0]=n,o[1]=t,o[2]=e,o}function ks(n,t){return n[0]=t[0],n[1]=t[1],n[2]=t[2],n}function Es(n,t,e,o){return n[0]=t,n[1]=e,n[2]=o,n}function Ms(n,t,e){return n[0]=t[0]+e[0],n[1]=t[1]+e[1],n[2]=t[2]+e[2],n}function mi(n,t,e){return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n[2]=t[2]-e[2],n}function di(n,t,e){return n[0]=t[0]*e[0],n[1]=t[1]*e[1],n[2]=t[2]*e[2],n}function hi(n,t,e){return n[0]=t[0]/e[0],n[1]=t[1]/e[1],n[2]=t[2]/e[2],n}function bs(n,t){return n[0]=Math.ceil(t[0]),n[1]=Math.ceil(t[1]),n[2]=Math.ceil(t[2]),n}function Cs(n,t){return n[0]=Math.floor(t[0]),n[1]=Math.floor(t[1]),n[2]=Math.floor(t[2]),n}function Ds(n,t,e){return n[0]=Math.min(t[0],e[0]),n[1]=Math.min(t[1],e[1]),n[2]=Math.min(t[2],e[2]),n}function ys(n,t,e){return n[0]=Math.max(t[0],e[0]),n[1]=Math.max(t[1],e[1]),n[2]=Math.max(t[2],e[2]),n}function vs(n,t){return n[0]=Math.round(t[0]),n[1]=Math.round(t[1]),n[2]=Math.round(t[2]),n}function Ls(n,t,e){return n[0]=t[0]*e,n[1]=t[1]*e,n[2]=t[2]*e,n}function Bs(n,t,e,o){return n[0]=t[0]+e[0]*o,n[1]=t[1]+e[1]*o,n[2]=t[2]+e[2]*o,n}function gi(n,t){var e=t[0]-n[0],o=t[1]-n[1],r=t[2]-n[2];return Math.hypot(e,o,r)}function fi(n,t){var e=t[0]-n[0],o=t[1]-n[1],r=t[2]-n[2];return e*e+o*o+r*r}function xi(n){var t=n[0],e=n[1],o=n[2];return t*t+e*e+o*o}function Rs(n,t){return n[0]=-t[0],n[1]=-t[1],n[2]=-t[2],n}function Ps(n,t){return n[0]=1/t[0],n[1]=1/t[1],n[2]=1/t[2],n}function _s(n,t){var e=t[0],o=t[1],r=t[2],i=e*e+o*o+r*r;return i>0&&(i=1/Math.sqrt(i)),n[0]=t[0]*i,n[1]=t[1]*i,n[2]=t[2]*i,n}function Si(n,t){return n[0]*t[0]+n[1]*t[1]+n[2]*t[2]}function Is(n,t,e){var o=t[0],r=t[1],i=t[2],a=e[0],s=e[1],u=e[2];return n[0]=r*u-i*s,n[1]=i*a-o*u,n[2]=o*s-r*a,n}function As(n,t,e,o){var r=t[0],i=t[1],a=t[2];return n[0]=r+o*(e[0]-r),n[1]=i+o*(e[1]-i),n[2]=a+o*(e[2]-a),n}function Hs(n,t,e,o,r,i){var a=i*i,s=a*(2*i-3)+1,u=a*(i-2)+i,c=a*(i-1),l=a*(3-2*i);return n[0]=t[0]*s+e[0]*u+o[0]*c+r[0]*l,n[1]=t[1]*s+e[1]*u+o[1]*c+r[1]*l,n[2]=t[2]*s+e[2]*u+o[2]*c+r[2]*l,n}function Ws(n,t,e,o,r,i){var a=1-i,s=a*a,u=i*i,c=s*a,l=3*i*s,F=3*u*a,h=u*i;return n[0]=t[0]*c+e[0]*l+o[0]*F+r[0]*h,n[1]=t[1]*c+e[1]*l+o[1]*F+r[1]*h,n[2]=t[2]*c+e[2]*l+o[2]*F+r[2]*h,n}function Os(n,t){t=t||1;var e=Io()*2*Math.PI,o=Io()*2-1,r=Math.sqrt(1-o*o)*t;return n[0]=Math.cos(e)*r,n[1]=Math.sin(e)*r,n[2]=o*t,n}function Ns(n,t,e){var o=t[0],r=t[1],i=t[2],a=e[3]*o+e[7]*r+e[11]*i+e[15];return a=a||1,n[0]=(e[0]*o+e[4]*r+e[8]*i+e[12])/a,n[1]=(e[1]*o+e[5]*r+e[9]*i+e[13])/a,n[2]=(e[2]*o+e[6]*r+e[10]*i+e[14])/a,n}function Us(n,t,e){var o=t[0],r=t[1],i=t[2];return n[0]=o*e[0]+r*e[3]+i*e[6],n[1]=o*e[1]+r*e[4]+i*e[7],n[2]=o*e[2]+r*e[5]+i*e[8],n}function zs(n,t,e){var o=e[0],r=e[1],i=e[2],a=e[3],s=t[0],u=t[1],c=t[2],l=r*c-i*u,F=i*s-o*c,h=o*u-r*s,f=r*h-i*F,x=i*l-o*h,w=o*F-r*l,C=a*2;return l*=C,F*=C,h*=C,f*=2,x*=2,w*=2,n[0]=s+l+f,n[1]=u+F+x,n[2]=c+h+w,n}function Vs(n,t,e,o){var r=[],i=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],i[0]=r[0],i[1]=r[1]*Math.cos(o)-r[2]*Math.sin(o),i[2]=r[1]*Math.sin(o)+r[2]*Math.cos(o),n[0]=i[0]+e[0],n[1]=i[1]+e[1],n[2]=i[2]+e[2],n}function Gs(n,t,e,o){var r=[],i=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],i[0]=r[2]*Math.sin(o)+r[0]*Math.cos(o),i[1]=r[1],i[2]=r[2]*Math.cos(o)-r[0]*Math.sin(o),n[0]=i[0]+e[0],n[1]=i[1]+e[1],n[2]=i[2]+e[2],n}function js(n,t,e,o){var r=[],i=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],i[0]=r[0]*Math.cos(o)-r[1]*Math.sin(o),i[1]=r[0]*Math.sin(o)+r[1]*Math.cos(o),i[2]=r[2],n[0]=i[0]+e[0],n[1]=i[1]+e[1],n[2]=i[2]+e[2],n}function Ks(n,t){var e=n[0],o=n[1],r=n[2],i=t[0],a=t[1],s=t[2],u=Math.sqrt(e*e+o*o+r*r),c=Math.sqrt(i*i+a*a+s*s),l=u*c,F=l&&Si(n,t)/l;return Math.acos(Math.min(Math.max(F,-1),1))}function $s(n){return n[0]=0,n[1]=0,n[2]=0,n}function qs(n){return"vec3("+n[0]+", "+n[1]+", "+n[2]+")"}function Js(n,t){return n[0]===t[0]&&n[1]===t[1]&&n[2]===t[2]}function Ys(n,t){var e=n[0],o=n[1],r=n[2],i=t[0],a=t[1],s=t[2];return Math.abs(e-i)<=Nt*Math.max(1,Math.abs(e),Math.abs(i))&&Math.abs(o-a)<=Nt*Math.max(1,Math.abs(o),Math.abs(a))&&Math.abs(r-s)<=Nt*Math.max(1,Math.abs(r),Math.abs(s))}var Qs=mi,Xs=di,Zs=hi,eu=gi,tu=fi,nu=Fi,ou=xi,ru=function(){var n=pi();return function(t,e,o,r,i,a){var s,u;for(e||(e=3),o||(o=0),r?u=Math.min(r*e+o,t.length):u=t.length,s=o;s<u;s+=e)n[0]=t[s],n[1]=t[s+1],n[2]=t[s+2],i(n,n,a),t[s]=n[0],t[s+1]=n[1],t[s+2]=n[2];return t}}();function _t(){return!0}var Ho=2*Math.PI;function wi(n){return(n%Ho+Ho)%Ho}function Wo(n,t,e){return Math.min(e,Math.max(t,n))}function Ao(n){return n*Math.PI/180}function Oo(n,t,e){return n*(e-t)+t}function Ti(n,t,e){return(1-e)*n+e*t}var rt=class extends j{constructor(){super(...arguments);p(this,"attached",new Array);p(this,"soFar",null);p(this,"total",null);p(this,"msg",null);p(this,"est",null)}get p(){return this.total>0?this.soFar/this.total:0}report(e,o,r,i){this.soFar=e,this.total=o,this.msg=r,this.est=i;for(let a of this.attached)a.report(e,o,r,i)}attach(e){this.attached.push(e),e.report(this.soFar,this.total,this.msg,this.est)}clear(){this.report(0,0),this._clear()}start(e){this.report(0,1,e||"starting")}end(e){this.report(1,1,e||"done"),this._clear()}_clear(){this.soFar=null,this.total=null,this.msg=null,this.est=null,ue(this.attached)}};var it=class extends rt{constructor(e,o){super();this.i=e;this.prog=o}report(e,o,r,i){super.report(e,o,r,i),this.prog.update(this.i,e,o,r)}};var at=class{constructor(t){this.prog=t;p(this,"weightTotal",0);p(this,"start");p(this,"subProgressCallbacks",new Array);p(this,"subProgressWeights",new Array);p(this,"subProgressValues",new Array);this.start=performance.now();for(let e=0;e<this.subProgressWeights.length;++e)this.subProgressValues[e]=0,this.subProgressCallbacks[e]=new it(e,this)}addSubProgress(t){t=t||1,this.weightTotal+=t,this.subProgressWeights.push(t),this.subProgressValues.push(0);let e=new it(this.subProgressCallbacks.length,this);return this.subProgressCallbacks.push(e),e}update(t,e,o,r){if(this.prog){this.subProgressValues[t]=e/o;let i=0;for(let c=0;c<this.subProgressWeights.length;++c)i+=this.subProgressValues[c]*this.subProgressWeights[c];let a=performance.now(),s=a-this.start,u=this.start-a+s*this.weightTotal/i;this.prog.report(i,this.weightTotal,r,u)}}};function Uo(n,t){return new No(t,n).subProgressCallbacks}var No=class extends at{constructor(t,e){super(e);for(let o of t)this.addSubProgress(o)}};async function au(n,t){let e=new Array(t.length),o=new Array(t.length);for(let a=0;a<t.length;++a){let s=t[a];e[a]=s[0],o[a]=s[1]}let r=Uo(n,e),i=new Array(t.length);for(let a=0;a<t.length;++a)i[a]=o[a](r[a]);return await Promise.all(i)}function ki(n,...t){let e=t.map(o=>[1,o]);return au(n,e)}function Ut(n,t,e){return typeof n===t||n instanceof e}function W(n){return Ut(n,"function",Function)}function O(n){return Ut(n,"boolean",Boolean)}function N(n){return Ut(n,"number",Number)}function ge(n){return d(n)&&Ut(n,"object",Object)}function Me(n){return n instanceof Array}function _e(n,t){throw new Error((t||"Unexpected object: ")+n)}function T(n){return n==null}function d(n){return!T(n)}function Ei(n){return n&&typeof ArrayBuffer!="undefined"&&(n instanceof ArrayBuffer||n.constructor&&n.constructor.name==="ArrayBuffer")}function le(n,t){let e=globalThis,o=e[n];if(T(o)){if(T(t))throw new Error(`No value ${n} found`);o=t(),e[n]=o}return o}var zo=class{constructor(){p(this,"t",0);p(this,"dt",0);p(this,"sdt",0);p(this,"fps",0)}set(t,e){this.t=t,this.dt=e,this.sdt=Ti(this.sdt,e,.01),e>0&&(this.fps=1e3/e)}},zt=class extends zo{constructor(){super(),Object.seal(this)}};var st,Ie=class{constructor(t){p(this,"timer",null);p(this,"onTick");p(this,"lt",-1);p(this,"tickHandlers",new Array);oi(this,st,null);this.targetFPS=t;let e=new zt,o=0;this.onTick=r=>{this.lt>=0&&(o=r-this.lt,e.set(r,o),this.tick(e)),this.lt=r}}get targetFPS(){return ni(this,st)}set targetFPS(t){ri(this,st,t)}addTickHandler(t){this.tickHandlers.push(t)}removeTickHandler(t){ee(this.tickHandlers,t)}tick(t){for(let e of this.tickHandlers)e(t)}restart(){this.stop(),this.start()}get isRunning(){return this.timer!=null}stop(){this.timer=null,this.lt=-1}get targetFrameTime(){return 1e3/this.targetFPS}};st=new WeakMap;var Vt=class extends Ie{constructor(t){super(t)}start(){this.timer=setInterval(()=>this.onTick(performance.now()),this.targetFrameTime)}stop(){this.timer&&(clearInterval(this.timer),super.stop())}get targetFPS(){return super.targetFPS}set targetFPS(t){super.targetFPS=t,this.isRunning&&this.restart()}};function Vo(n){return d(n)&&n.length>0?parseFloat(n):null}var Mi=class{constructor(t,e){p(this,"_url",null);p(this,"_base");p(this,"_protocol",null);p(this,"_host",null);p(this,"_hostName",null);p(this,"_userName",null);p(this,"_password",null);p(this,"_port",null);p(this,"_pathName",null);p(this,"_hash",null);p(this,"_query",new Map);t!==void 0&&(this._url=new URL(t,e),this.rehydrate())}rehydrate(){d(this._protocol)&&this._protocol!==this._url.protocol&&(this._url.protocol=this._protocol),d(this._host)&&this._host!==this._url.host&&(this._url.host=this._host),d(this._hostName)&&this._hostName!==this._url.hostname&&(this._url.hostname=this._hostName),d(this._userName)&&this._userName!==this._url.username&&(this._url.username=this._userName),d(this._password)&&this._password!==this._url.password&&(this._url.password=this._password),d(this._port)&&this._port.toFixed(0)!==this._url.port&&(this._url.port=this._port.toFixed(0)),d(this._pathName)&&this._pathName!==this._url.pathname&&(this._url.pathname=this._pathName),d(this._hash)&&this._hash!==this._url.hash&&(this._url.hash=this._hash);for(let[t,e]of this._query)this._url.searchParams.set(t,e);this._protocol=this._url.protocol,this._host=this._url.host,this._hostName=this._url.hostname,this._userName=this._url.username,this._password=this._url.password,this._port=Vo(this._url.port),this._pathName=this._url.pathname,this._hash=this._url.hash,this._url.searchParams.forEach((t,e)=>this._query.set(e,t))}refresh(){if(this._url===null){if(d(this._protocol)&&(d(this._host)||d(this._hostName))){if(d(this._host))return this._url=new URL(`${this._protocol}//${this._host}`,this._base),this._port=Vo(this._url.port),this.rehydrate(),!1;if(d(this._hostName))return this._url=new URL(`${this._protocol}//${this._hostName}`,this._base),this.rehydrate(),!1}else if(d(this._pathName)&&d(this._base))return this._url=new URL(this._pathName,this._base),this.rehydrate(),!1}return d(this._url)}base(t){if(this._url!==null)throw new Error("Cannot redefine base after defining the protocol and domain");return this._base=t,this.refresh(),this}protocol(t){return this._protocol=t,this.refresh()&&(this._url.protocol=t),this}host(t){return this._host=t,this.refresh()&&(this._url.host=t,this._hostName=this._url.hostname,this._port=Vo(this._url.port)),this}hostName(t){return this._hostName=t,this.refresh()&&(this._url.hostname=t,this._host=`${this._url.hostname}:${this._url.port}`),this}port(t){return this._port=t,this.refresh()&&(this._url.port=t.toFixed(0),this._host=`${this._url.hostname}:${this._url.port}`),this}userName(t){return this._userName=t,this.refresh()&&(this._url.username=t),this}password(t){return this._password=t,this.refresh()&&(this._url.password=t),this}path(t){return this._pathName=t,this.refresh()&&(this._url.pathname=t),this}pathPop(t){return t=t||/\/[^\/]+\/?$/,this.path(this._pathName.replace(t,""))}pathPush(t){let e=this._pathName;return e.endsWith("/")||(e+="/"),e+=t,this.path(e)}query(t,e){return this._query.set(t,e),this.refresh()&&this._url.searchParams.set(t,e),this}hash(t){return this._hash=t,this.refresh()&&(this._url.hash=t),this}toURL(){return this._url}toString(){return this._url.href}[Symbol.toStringTag](){return this.toString()}};function Go(n){let t=new Map;for(let[e,o]of n)t.set(o,e);return t}var su=new Map([[1,"KiB"],[2,"MiB"],[3,"GiB"],[4,"TiB"]]),uu=new Map([[1,"KB"],[2,"MB"],[3,"GB"],[4,"TB"]]),cd=Go(su),ld=Go(uu);var bi=304.79999999999995,Fd=bi*3,cu=10*100,lu=bi*16.5,pu=lu*40,md=cu*1e3,dd=pu*8,Ci=2.54*4,Di=Ci*3,hd=Di*3,Fu=Di*16.5,mu=Fu*40,gd=100*1e3,fd=mu*8,jo=4*3,du=jo*3,Ko=100/2.54,hu=jo*16.5,gu=hu*40,xd=Ko*1e3,Sd=gu*8,wd=3*3,fu=100/Ci,xu=3*16.5,Su=xu*40,Td=fu*1e3,kd=Su*8,yi=Ko/jo,wu=16.5*40,Ed=yi*1e3,Md=wu*8,Tu=Ko/du,ku=16.5/3,Eu=ku*40,bd=Tu*1e3,Cd=Eu*8,vi=16.5/yi,Li=vi*40,Dd=Li*8,yd=1e3/vi,vd=40*8,Mu=1e3/Li,Ld=8/Mu;function $o(n,...t){if(!ge(n))return!1;n=n;for(let e of t){if(!(e in n))return!1;let o=n[e];if(!W(o))return!1}return!0}function bu(n){return $o(n,"dispose")}function Cu(n){return $o(n,"destroy")}function Du(n){return $o(n,"close")}function Bi(n){bu(n)&&n.dispose(),Du(n)&&n.close(),Cu(n)&&n.destroy()}var yu="AudioContext"in globalThis,Pi=yu&&"AudioListener"in globalThis,sh=Pi&&"setPosition"in AudioListener.prototype,uh=Pi&&"positionX"in AudioListener.prototype,ch=W(HTMLMediaElement.prototype.captureStream)||W(HTMLMediaElement.prototype.mozCaptureStream);function _i(n){return d(n)&&n.node instanceof AudioNode}function Ii(n){return d(n)&&n.input instanceof AudioNode&&n.output instanceof AudioNode}var fe=le("Juniper:Audio:connections",()=>new Map),qo=le("Juniper:Audio:names",()=>new Map);function Ai(n){return Ii(n)?n.output:_i(n)?n.node:n}function Hi(n){if(T(n))return;let t=null;Me(n)?n.length===2?t=n[1]:t=n[2]:t=n;let e=null;return Ii(t)?e=t.input:_i(t)?e=t.node:e=t,e}function Wi(n){return Me(n)?n.length===2?[n[0]]:[n[0],n[1]]:[]}function vu(n){return d(n)&&d(n.context)}function Lu(n,t){qo.set(t,n)}function Gt(n){qo.delete(n),vu(n)&&Bu(n)}function ut(n,t){let e=Ai(n),o=Hi(t),r=Wi(t);if(T(o))throw new Error("Must have a target to connect to");o instanceof AudioParam?e.connect(o,r[0]):o instanceof AudioNode?e.connect(o,r[0],r[1]):_e(o),fe.has(e)||fe.set(e,new Set);let i=fe.get(e);return i.has(o)?!1:(i.add(o),!0)}function Bu(n,t){let e=Ai(n),o=Hi(t),r=Wi(t);if(T(o)?e.disconnect():o instanceof AudioParam?e.disconnect(o,r[0]):o instanceof AudioNode?e.disconnect(o,r[0],r[1]):_e(o),!fe.has(e))return!1;let i=fe.get(e),a=!1;return T(o)?(a=i.size>0,i.clear()):i.has(o)&&(a=!0,i.delete(o)),i.size===0&&fe.delete(e),a}function Ru(){let n=new Map;function t(e){n.has(e)||n.set(e,new Rt(e))}for(let e of qo.keys())t(e);for(let[e,o]of fe){t(e);for(let r of o)t(r)}for(let[e,o]of fe){let r=n.get(e);for(let i of o)n.has(i)&&r.connectTo(n.get(i))}return Array.from(n.values())}globalThis.getAudioGraph=Ru;function Oi(n,t,...e){Lu(n,t);for(let o of e)d(o)&&ut(t,o);return t}function Ni(n,t,e,...o){return Oi(n,new AnalyserNode(t,e),...o)}function Ui(n,t,e,...o){return Oi(n,t.createMediaStreamSource(e),...o)}var $=class extends Error{constructor(t,e){let o=new.target.prototype;super(`${t}: Status code '${e}'`),this.statusCode=e,this.__proto__=o}},xe=class extends Error{constructor(t="A timeout occurred."){let e=new.target.prototype;super(t),this.__proto__=e}},te=class extends Error{constructor(t="An abort occurred."){let e=new.target.prototype;super(t),this.__proto__=e}},jt=class extends Error{constructor(t,e){let o=new.target.prototype;super(t),this.transport=e,this.errorType="UnsupportedTransportError",this.__proto__=o}},Kt=class extends Error{constructor(t,e){let o=new.target.prototype;super(t),this.transport=e,this.errorType="DisabledTransportError",this.__proto__=o}},$t=class extends Error{constructor(t,e){let o=new.target.prototype;super(t),this.transport=e,this.errorType="FailedToStartTransportError",this.__proto__=o}},qt=class extends Error{constructor(t){let e=new.target.prototype;super(t),this.errorType="FailedToNegotiateWithServerError",this.__proto__=e}},Jt=class extends Error{constructor(t,e){let o=new.target.prototype;super(t),this.innerErrors=e,this.__proto__=o}};var Ae=class{constructor(t,e,o){this.statusCode=t,this.statusText=e,this.content=o}},Se=class{get(t,e){return this.send({...e,method:"GET",url:t})}post(t,e){return this.send({...e,method:"POST",url:t})}delete(t,e){return this.send({...e,method:"DELETE",url:t})}getCookieString(t){return""}};var m;(function(n){n[n.Trace=0]="Trace",n[n.Debug=1]="Debug",n[n.Information=2]="Information",n[n.Warning=3]="Warning",n[n.Error=4]="Error",n[n.Critical=5]="Critical",n[n.None=6]="None"})(m||(m={}));var ne=class{constructor(){}log(t,e){}};ne.instance=new ne;var Pu="6.0.5",b=class{static isRequired(t,e){if(t==null)throw new Error(`The '${e}' argument is required.`)}static isNotEmpty(t,e){if(!t||t.match(/^\s*$/))throw new Error(`The '${e}' argument should not be empty.`)}static isIn(t,e,o){if(!(t in e))throw new Error(`Unknown ${o} value: ${t}.`)}},y=class{static get isBrowser(){return typeof window=="object"&&typeof window.document=="object"}static get isWebWorker(){return typeof self=="object"&&"importScripts"in self}static get isReactNative(){return typeof window=="object"&&typeof window.document=="undefined"}static get isNode(){return!this.isBrowser&&!this.isWebWorker&&!this.isReactNative}};function we(n,t){let e="";return Qt(n)?(e=`Binary data of length ${n.byteLength}`,t&&(e+=`. Content: '${_u(n)}'`)):typeof n=="string"&&(e=`String data of length ${n.length}`,t&&(e+=`. Content: '${n}'`)),e}function _u(n){let t=new Uint8Array(n),e="";return t.forEach(o=>{e+=`0x${o<16?"0":""}${o.toString(16)} `}),e.substr(0,e.length-1)}function Qt(n){return n&&typeof ArrayBuffer!="undefined"&&(n instanceof ArrayBuffer||n.constructor&&n.constructor.name==="ArrayBuffer")}async function Xt(n,t,e,o,r,i,a){let s={};if(r){let h=await r();h&&(s={Authorization:`Bearer ${h}`})}let[u,c]=oe();s[u]=c,n.log(m.Trace,`(${t} transport) sending data. ${we(i,a.logMessageContent)}.`);let l=Qt(i)?"arraybuffer":"text",F=await e.post(o,{content:i,headers:{...s,...a.headers},responseType:l,timeout:a.timeout,withCredentials:a.withCredentials});n.log(m.Trace,`(${t} transport) request complete. Response status: ${F.statusCode}.`)}function zi(n){return n===void 0?new be(m.Information):n===null?ne.instance:n.log!==void 0?n:new be(n)}var Yt=class{constructor(t,e){this._subject=t,this._observer=e}dispose(){let t=this._subject.observers.indexOf(this._observer);t>-1&&this._subject.observers.splice(t,1),this._subject.observers.length===0&&this._subject.cancelCallback&&this._subject.cancelCallback().catch(e=>{})}},be=class{constructor(t){this._minLevel=t,this.out=console}log(t,e){if(t>=this._minLevel){let o=`[${new Date().toISOString()}] ${m[t]}: ${e}`;switch(t){case m.Critical:case m.Error:this.out.error(o);break;case m.Warning:this.out.warn(o);break;case m.Information:this.out.info(o);break;default:this.out.log(o);break}}}};function oe(){let n="X-SignalR-User-Agent";return y.isNode&&(n="User-Agent"),[n,Iu(Pu,Au(),Wu(),Hu())]}function Iu(n,t,e,o){let r="Microsoft SignalR/",i=n.split(".");return r+=`${i[0]}.${i[1]}`,r+=` (${n}; `,t&&t!==""?r+=`${t}; `:r+="Unknown OS; ",r+=`${e}`,o?r+=`; ${o}`:r+="; Unknown Runtime Version",r+=")",r}function Au(){if(y.isNode)switch(process.platform){case"win32":return"Windows NT";case"darwin":return"macOS";case"linux":return"Linux";default:return process.platform}else return""}function Hu(){if(y.isNode)return process.versions.node}function Wu(){return y.isNode?"NodeJS":"Browser"}function Jo(n){return n.stack?n.stack:n.message?n.message:`${n}`}function Vi(){if(typeof globalThis!="undefined")return globalThis;if(typeof self!="undefined")return self;if(typeof window!="undefined")return window;if(typeof global!="undefined")return global;throw new Error("could not find global")}var Zt=class extends Se{constructor(t){if(super(),this._logger=t,typeof fetch=="undefined"){let e=typeof __webpack_require__=="function"?__non_webpack_require__:Pe;this._jar=new(e("tough-cookie")).CookieJar,this._fetchType=e("node-fetch"),this._fetchType=e("fetch-cookie")(this._fetchType,this._jar)}else this._fetchType=fetch.bind(Vi());if(typeof AbortController=="undefined"){let e=typeof __webpack_require__=="function"?__non_webpack_require__:Pe;this._abortControllerType=e("abort-controller")}else this._abortControllerType=AbortController}async send(t){if(t.abortSignal&&t.abortSignal.aborted)throw new te;if(!t.method)throw new Error("No method defined.");if(!t.url)throw new Error("No url defined.");let e=new this._abortControllerType,o;t.abortSignal&&(t.abortSignal.onabort=()=>{e.abort(),o=new te});let r=null;if(t.timeout){let u=t.timeout;r=setTimeout(()=>{e.abort(),this._logger.log(m.Warning,"Timeout from HTTP request."),o=new xe},u)}let i;try{i=await this._fetchType(t.url,{body:t.content,cache:"no-cache",credentials:t.withCredentials===!0?"include":"same-origin",headers:{"Content-Type":"text/plain;charset=UTF-8","X-Requested-With":"XMLHttpRequest",...t.headers},method:t.method,mode:"cors",redirect:"follow",signal:e.signal})}catch(u){throw o||(this._logger.log(m.Warning,`Error from HTTP request. ${u}.`),u)}finally{r&&clearTimeout(r),t.abortSignal&&(t.abortSignal.onabort=null)}if(!i.ok){let u=await Gi(i,"text");throw new $(u||i.statusText,i.status)}let s=await Gi(i,t.responseType);return new Ae(i.status,i.statusText,s)}getCookieString(t){let e="";return y.isNode&&this._jar&&this._jar.getCookies(t,(o,r)=>e=r.join("; ")),e}};function Gi(n,t){let e;switch(t){case"arraybuffer":e=n.arrayBuffer();break;case"text":e=n.text();break;case"blob":case"document":case"json":throw new Error(`${t} is not supported.`);default:e=n.text();break}return e}var en=class extends Se{constructor(t){super(),this._logger=t}send(t){return t.abortSignal&&t.abortSignal.aborted?Promise.reject(new te):t.method?t.url?new Promise((e,o)=>{let r=new XMLHttpRequest;r.open(t.method,t.url,!0),r.withCredentials=t.withCredentials===void 0?!0:t.withCredentials,r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.setRequestHeader("Content-Type","text/plain;charset=UTF-8");let i=t.headers;i&&Object.keys(i).forEach(a=>{r.setRequestHeader(a,i[a])}),t.responseType&&(r.responseType=t.responseType),t.abortSignal&&(t.abortSignal.onabort=()=>{r.abort(),o(new te)}),t.timeout&&(r.timeout=t.timeout),r.onload=()=>{t.abortSignal&&(t.abortSignal.onabort=null),r.status>=200&&r.status<300?e(new Ae(r.status,r.statusText,r.response||r.responseText)):o(new $(r.response||r.responseText||r.statusText,r.status))},r.onerror=()=>{this._logger.log(m.Warning,`Error from HTTP request. ${r.status}: ${r.statusText}.`),o(new $(r.statusText,r.status))},r.ontimeout=()=>{this._logger.log(m.Warning,"Timeout from HTTP request."),o(new xe)},r.send(t.content||"")}):Promise.reject(new Error("No url defined.")):Promise.reject(new Error("No method defined."))}};var tn=class extends Se{constructor(t){if(super(),typeof fetch!="undefined"||y.isNode)this._httpClient=new Zt(t);else if(typeof XMLHttpRequest!="undefined")this._httpClient=new en(t);else throw new Error("No usable HttpClient found.")}send(t){return t.abortSignal&&t.abortSignal.aborted?Promise.reject(new te):t.method?t.url?this._httpClient.send(t):Promise.reject(new Error("No url defined.")):Promise.reject(new Error("No method defined."))}getCookieString(t){return this._httpClient.getCookieString(t)}};var I=class{static write(t){return`${t}${I.RecordSeparator}`}static parse(t){if(t[t.length-1]!==I.RecordSeparator)throw new Error("Message is incomplete.");let e=t.split(I.RecordSeparator);return e.pop(),e}};I.RecordSeparatorCode=30;I.RecordSeparator=String.fromCharCode(I.RecordSeparatorCode);var nn=class{writeHandshakeRequest(t){return I.write(JSON.stringify(t))}parseHandshakeResponse(t){let e,o;if(Qt(t)){let s=new Uint8Array(t),u=s.indexOf(I.RecordSeparatorCode);if(u===-1)throw new Error("Message is incomplete.");let c=u+1;e=String.fromCharCode.apply(null,Array.prototype.slice.call(s.slice(0,c))),o=s.byteLength>c?s.slice(c).buffer:null}else{let s=t,u=s.indexOf(I.RecordSeparator);if(u===-1)throw new Error("Message is incomplete.");let c=u+1;e=s.substring(0,c),o=s.length>c?s.substring(c):null}let r=I.parse(e),i=JSON.parse(r[0]);if(i.type)throw new Error("Expected a handshake response from the server.");return[o,i]}};var M;(function(n){n[n.Invocation=1]="Invocation",n[n.StreamItem=2]="StreamItem",n[n.Completion=3]="Completion",n[n.StreamInvocation=4]="StreamInvocation",n[n.CancelInvocation=5]="CancelInvocation",n[n.Ping=6]="Ping",n[n.Close=7]="Close"})(M||(M={}));var on=class{constructor(){this.observers=[]}next(t){for(let e of this.observers)e.next(t)}error(t){for(let e of this.observers)e.error&&e.error(t)}complete(){for(let t of this.observers)t.complete&&t.complete()}subscribe(t){return this.observers.push(t),new Yt(this,t)}};var Ou=30*1e3,Nu=15*1e3,E;(function(n){n.Disconnected="Disconnected",n.Connecting="Connecting",n.Connected="Connected",n.Disconnecting="Disconnecting",n.Reconnecting="Reconnecting"})(E||(E={}));var Ce=class{constructor(t,e,o,r){this._nextKeepAlive=0,this._freezeEventListener=()=>{this._logger.log(m.Warning,"The page is being frozen, this will likely lead to the connection being closed and messages being lost. For more information see the docs at https://docs.microsoft.com/aspnet/core/signalr/javascript-client#bsleep")},b.isRequired(t,"connection"),b.isRequired(e,"logger"),b.isRequired(o,"protocol"),this.serverTimeoutInMilliseconds=Ou,this.keepAliveIntervalInMilliseconds=Nu,this._logger=e,this._protocol=o,this.connection=t,this._reconnectPolicy=r,this._handshakeProtocol=new nn,this.connection.onreceive=i=>this._processIncomingData(i),this.connection.onclose=i=>this._connectionClosed(i),this._callbacks={},this._methods={},this._closedCallbacks=[],this._reconnectingCallbacks=[],this._reconnectedCallbacks=[],this._invocationId=0,this._receivedHandshakeResponse=!1,this._connectionState=E.Disconnected,this._connectionStarted=!1,this._cachedPingMessage=this._protocol.writeMessage({type:M.Ping})}static create(t,e,o,r){return new Ce(t,e,o,r)}get state(){return this._connectionState}get connectionId(){return this.connection&&this.connection.connectionId||null}get baseUrl(){return this.connection.baseUrl||""}set baseUrl(t){if(this._connectionState!==E.Disconnected&&this._connectionState!==E.Reconnecting)throw new Error("The HubConnection must be in the Disconnected or Reconnecting state to change the url.");if(!t)throw new Error("The HubConnection url must be a valid url.");this.connection.baseUrl=t}start(){return this._startPromise=this._startWithStateTransitions(),this._startPromise}async _startWithStateTransitions(){if(this._connectionState!==E.Disconnected)return Promise.reject(new Error("Cannot start a HubConnection that is not in the 'Disconnected' state."));this._connectionState=E.Connecting,this._logger.log(m.Debug,"Starting HubConnection.");try{await this._startInternal(),y.isBrowser&&window.document.addEventListener("freeze",this._freezeEventListener),this._connectionState=E.Connected,this._connectionStarted=!0,this._logger.log(m.Debug,"HubConnection connected successfully.")}catch(t){return this._connectionState=E.Disconnected,this._logger.log(m.Debug,`HubConnection failed to start successfully because of error '${t}'.`),Promise.reject(t)}}async _startInternal(){this._stopDuringStartError=void 0,this._receivedHandshakeResponse=!1;let t=new Promise((e,o)=>{this._handshakeResolver=e,this._handshakeRejecter=o});await this.connection.start(this._protocol.transferFormat);try{let e={protocol:this._protocol.name,version:this._protocol.version};if(this._logger.log(m.Debug,"Sending handshake request."),await this._sendMessage(this._handshakeProtocol.writeHandshakeRequest(e)),this._logger.log(m.Information,`Using HubProtocol '${this._protocol.name}'.`),this._cleanupTimeout(),this._resetTimeoutPeriod(),this._resetKeepAliveInterval(),await t,this._stopDuringStartError)throw this._stopDuringStartError}catch(e){throw this._logger.log(m.Debug,`Hub handshake failed with error '${e}' during start(). Stopping HubConnection.`),this._cleanupTimeout(),this._cleanupPingTimer(),await this.connection.stop(e),e}}async stop(){let t=this._startPromise;this._stopPromise=this._stopInternal(),await this._stopPromise;try{await t}catch{}}_stopInternal(t){return this._connectionState===E.Disconnected?(this._logger.log(m.Debug,`Call to HubConnection.stop(${t}) ignored because it is already in the disconnected state.`),Promise.resolve()):this._connectionState===E.Disconnecting?(this._logger.log(m.Debug,`Call to HttpConnection.stop(${t}) ignored because the connection is already in the disconnecting state.`),this._stopPromise):(this._connectionState=E.Disconnecting,this._logger.log(m.Debug,"Stopping HubConnection."),this._reconnectDelayHandle?(this._logger.log(m.Debug,"Connection stopped during reconnect delay. Done reconnecting."),clearTimeout(this._reconnectDelayHandle),this._reconnectDelayHandle=void 0,this._completeClose(),Promise.resolve()):(this._cleanupTimeout(),this._cleanupPingTimer(),this._stopDuringStartError=t||new Error("The connection was stopped before the hub handshake could complete."),this.connection.stop(t)))}stream(t,...e){let[o,r]=this._replaceStreamingParams(e),i=this._createStreamInvocation(t,e,r),a,s=new on;return s.cancelCallback=()=>{let u=this._createCancelInvocation(i.invocationId);return delete this._callbacks[i.invocationId],a.then(()=>this._sendWithProtocol(u))},this._callbacks[i.invocationId]=(u,c)=>{if(c){s.error(c);return}else u&&(u.type===M.Completion?u.error?s.error(new Error(u.error)):s.complete():s.next(u.item))},a=this._sendWithProtocol(i).catch(u=>{s.error(u),delete this._callbacks[i.invocationId]}),this._launchStreams(o,a),s}_sendMessage(t){return this._resetKeepAliveInterval(),this.connection.send(t)}_sendWithProtocol(t){return this._sendMessage(this._protocol.writeMessage(t))}send(t,...e){let[o,r]=this._replaceStreamingParams(e),i=this._sendWithProtocol(this._createInvocation(t,e,!0,r));return this._launchStreams(o,i),i}invoke(t,...e){let[o,r]=this._replaceStreamingParams(e),i=this._createInvocation(t,e,!1,r);return new Promise((s,u)=>{this._callbacks[i.invocationId]=(l,F)=>{if(F){u(F);return}else l&&(l.type===M.Completion?l.error?u(new Error(l.error)):s(l.result):u(new Error(`Unexpected message type: ${l.type}`)))};let c=this._sendWithProtocol(i).catch(l=>{u(l),delete this._callbacks[i.invocationId]});this._launchStreams(o,c)})}on(t,e){!t||!e||(t=t.toLowerCase(),this._methods[t]||(this._methods[t]=[]),this._methods[t].indexOf(e)===-1&&this._methods[t].push(e))}off(t,e){if(!t)return;t=t.toLowerCase();let o=this._methods[t];if(!!o)if(e){let r=o.indexOf(e);r!==-1&&(o.splice(r,1),o.length===0&&delete this._methods[t])}else delete this._methods[t]}onclose(t){t&&this._closedCallbacks.push(t)}onreconnecting(t){t&&this._reconnectingCallbacks.push(t)}onreconnected(t){t&&this._reconnectedCallbacks.push(t)}_processIncomingData(t){if(this._cleanupTimeout(),this._receivedHandshakeResponse||(t=this._processHandshakeResponse(t),this._receivedHandshakeResponse=!0),t){let e=this._protocol.parseMessages(t,this._logger);for(let o of e)switch(o.type){case M.Invocation:this._invokeClientMethod(o);break;case M.StreamItem:case M.Completion:{let r=this._callbacks[o.invocationId];if(r){o.type===M.Completion&&delete this._callbacks[o.invocationId];try{r(o)}catch(i){this._logger.log(m.Error,`Stream callback threw error: ${Jo(i)}`)}}break}case M.Ping:break;case M.Close:{this._logger.log(m.Information,"Close message received from server.");let r=o.error?new Error("Server returned an error on close: "+o.error):void 0;o.allowReconnect===!0?this.connection.stop(r):this._stopPromise=this._stopInternal(r);break}default:this._logger.log(m.Warning,`Invalid message type: ${o.type}.`);break}}this._resetTimeoutPeriod()}_processHandshakeResponse(t){let e,o;try{[o,e]=this._handshakeProtocol.parseHandshakeResponse(t)}catch(r){let i="Error parsing handshake response: "+r;this._logger.log(m.Error,i);let a=new Error(i);throw this._handshakeRejecter(a),a}if(e.error){let r="Server returned handshake error: "+e.error;this._logger.log(m.Error,r);let i=new Error(r);throw this._handshakeRejecter(i),i}else this._logger.log(m.Debug,"Server handshake complete.");return this._handshakeResolver(),o}_resetKeepAliveInterval(){this.connection.features.inherentKeepAlive||(this._nextKeepAlive=new Date().getTime()+this.keepAliveIntervalInMilliseconds,this._cleanupPingTimer())}_resetTimeoutPeriod(){if((!this.connection.features||!this.connection.features.inherentKeepAlive)&&(this._timeoutHandle=setTimeout(()=>this.serverTimeout(),this.serverTimeoutInMilliseconds),this._pingServerHandle===void 0)){let t=this._nextKeepAlive-new Date().getTime();t<0&&(t=0),this._pingServerHandle=setTimeout(async()=>{if(this._connectionState===E.Connected)try{await this._sendMessage(this._cachedPingMessage)}catch{this._cleanupPingTimer()}},t)}}serverTimeout(){this.connection.stop(new Error("Server timeout elapsed without receiving a message from the server."))}_invokeClientMethod(t){let e=this._methods[t.target.toLowerCase()];if(e){try{e.forEach(o=>o.apply(this,t.arguments))}catch(o){this._logger.log(m.Error,`A callback for the method ${t.target.toLowerCase()} threw error '${o}'.`)}if(t.invocationId){let o="Server requested a response, which is not supported in this version of the client.";this._logger.log(m.Error,o),this._stopPromise=this._stopInternal(new Error(o))}}else this._logger.log(m.Warning,`No client method with the name '${t.target}' found.`)}_connectionClosed(t){this._logger.log(m.Debug,`HubConnection.connectionClosed(${t}) called while in state ${this._connectionState}.`),this._stopDuringStartError=this._stopDuringStartError||t||new Error("The underlying connection was closed before the hub handshake could complete."),this._handshakeResolver&&this._handshakeResolver(),this._cancelCallbacksWithError(t||new Error("Invocation canceled due to the underlying connection being closed.")),this._cleanupTimeout(),this._cleanupPingTimer(),this._connectionState===E.Disconnecting?this._completeClose(t):this._connectionState===E.Connected&&this._reconnectPolicy?this._reconnect(t):this._connectionState===E.Connected&&this._completeClose(t)}_completeClose(t){if(this._connectionStarted){this._connectionState=E.Disconnected,this._connectionStarted=!1,y.isBrowser&&window.document.removeEventListener("freeze",this._freezeEventListener);try{this._closedCallbacks.forEach(e=>e.apply(this,[t]))}catch(e){this._logger.log(m.Error,`An onclose callback called with error '${t}' threw error '${e}'.`)}}}async _reconnect(t){let e=Date.now(),o=0,r=t!==void 0?t:new Error("Attempting to reconnect due to a unknown error."),i=this._getNextRetryDelay(o++,0,r);if(i===null){this._logger.log(m.Debug,"Connection not reconnecting because the IRetryPolicy returned null on the first reconnect attempt."),this._completeClose(t);return}if(this._connectionState=E.Reconnecting,t?this._logger.log(m.Information,`Connection reconnecting because of error '${t}'.`):this._logger.log(m.Information,"Connection reconnecting."),this._reconnectingCallbacks.length!==0){try{this._reconnectingCallbacks.forEach(a=>a.apply(this,[t]))}catch(a){this._logger.log(m.Error,`An onreconnecting callback called with error '${t}' threw error '${a}'.`)}if(this._connectionState!==E.Reconnecting){this._logger.log(m.Debug,"Connection left the reconnecting state in onreconnecting callback. Done reconnecting.");return}}for(;i!==null;){if(this._logger.log(m.Information,`Reconnect attempt number ${o} will start in ${i} ms.`),await new Promise(a=>{this._reconnectDelayHandle=setTimeout(a,i)}),this._reconnectDelayHandle=void 0,this._connectionState!==E.Reconnecting){this._logger.log(m.Debug,"Connection left the reconnecting state during reconnect delay. Done reconnecting.");return}try{if(await this._startInternal(),this._connectionState=E.Connected,this._logger.log(m.Information,"HubConnection reconnected successfully."),this._reconnectedCallbacks.length!==0)try{this._reconnectedCallbacks.forEach(a=>a.apply(this,[this.connection.connectionId]))}catch(a){this._logger.log(m.Error,`An onreconnected callback called with connectionId '${this.connection.connectionId}; threw error '${a}'.`)}return}catch(a){if(this._logger.log(m.Information,`Reconnect attempt failed because of error '${a}'.`),this._connectionState!==E.Reconnecting){this._logger.log(m.Debug,`Connection moved to the '${this._connectionState}' from the reconnecting state during reconnect attempt. Done reconnecting.`),this._connectionState===E.Disconnecting&&this._completeClose();return}r=a instanceof Error?a:new Error(a.toString()),i=this._getNextRetryDelay(o++,Date.now()-e,r)}}this._logger.log(m.Information,`Reconnect retries have been exhausted after ${Date.now()-e} ms and ${o} failed attempts. Connection disconnecting.`),this._completeClose()}_getNextRetryDelay(t,e,o){try{return this._reconnectPolicy.nextRetryDelayInMilliseconds({elapsedMilliseconds:e,previousRetryCount:t,retryReason:o})}catch(r){return this._logger.log(m.Error,`IRetryPolicy.nextRetryDelayInMilliseconds(${t}, ${e}) threw error '${r}'.`),null}}_cancelCallbacksWithError(t){let e=this._callbacks;this._callbacks={},Object.keys(e).forEach(o=>{let r=e[o];try{r(null,t)}catch(i){this._logger.log(m.Error,`Stream 'error' callback called with '${t}' threw error: ${Jo(i)}`)}})}_cleanupPingTimer(){this._pingServerHandle&&(clearTimeout(this._pingServerHandle),this._pingServerHandle=void 0)}_cleanupTimeout(){this._timeoutHandle&&clearTimeout(this._timeoutHandle)}_createInvocation(t,e,o,r){if(o)return r.length!==0?{arguments:e,streamIds:r,target:t,type:M.Invocation}:{arguments:e,target:t,type:M.Invocation};{let i=this._invocationId;return this._invocationId++,r.length!==0?{arguments:e,invocationId:i.toString(),streamIds:r,target:t,type:M.Invocation}:{arguments:e,invocationId:i.toString(),target:t,type:M.Invocation}}}_launchStreams(t,e){if(t.length!==0){e||(e=Promise.resolve());for(let o in t)t[o].subscribe({complete:()=>{e=e.then(()=>this._sendWithProtocol(this._createCompletionMessage(o)))},error:r=>{let i;r instanceof Error?i=r.message:r&&r.toString?i=r.toString():i="Unknown error",e=e.then(()=>this._sendWithProtocol(this._createCompletionMessage(o,i)))},next:r=>{e=e.then(()=>this._sendWithProtocol(this._createStreamItemMessage(o,r)))}})}}_replaceStreamingParams(t){let e=[],o=[];for(let r=0;r<t.length;r++){let i=t[r];if(this._isObservable(i)){let a=this._invocationId;this._invocationId++,e[a]=i,o.push(a.toString()),t.splice(r,1)}}return[e,o]}_isObservable(t){return t&&t.subscribe&&typeof t.subscribe=="function"}_createStreamInvocation(t,e,o){let r=this._invocationId;return this._invocationId++,o.length!==0?{arguments:e,invocationId:r.toString(),streamIds:o,target:t,type:M.StreamInvocation}:{arguments:e,invocationId:r.toString(),target:t,type:M.StreamInvocation}}_createCancelInvocation(t){return{invocationId:t,type:M.CancelInvocation}}_createStreamItemMessage(t,e){return{invocationId:t,item:e,type:M.StreamItem}}_createCompletionMessage(t,e,o){return e?{error:e,invocationId:t,type:M.Completion}:{invocationId:t,result:o,type:M.Completion}}};var Uu=[0,2e3,1e4,3e4,null],ct=class{constructor(t){this._retryDelays=t!==void 0?[...t,null]:Uu}nextRetryDelayInMilliseconds(t){return this._retryDelays[t.previousRetryCount]}};var q=class{};q.Authorization="Authorization";q.Cookie="Cookie";var L;(function(n){n[n.None=0]="None",n[n.WebSockets=1]="WebSockets",n[n.ServerSentEvents=2]="ServerSentEvents",n[n.LongPolling=4]="LongPolling"})(L||(L={}));var B;(function(n){n[n.Text=1]="Text",n[n.Binary=2]="Binary"})(B||(B={}));var rn=class{constructor(){this._isAborted=!1,this.onabort=null}abort(){this._isAborted||(this._isAborted=!0,this.onabort&&this.onabort())}get signal(){return this}get aborted(){return this._isAborted}};var lt=class{constructor(t,e,o,r){this._httpClient=t,this._accessTokenFactory=e,this._logger=o,this._pollAbort=new rn,this._options=r,this._running=!1,this.onreceive=null,this.onclose=null}get pollAborted(){return this._pollAbort.aborted}async connect(t,e){if(b.isRequired(t,"url"),b.isRequired(e,"transferFormat"),b.isIn(e,B,"transferFormat"),this._url=t,this._logger.log(m.Trace,"(LongPolling transport) Connecting."),e===B.Binary&&typeof XMLHttpRequest!="undefined"&&typeof new XMLHttpRequest().responseType!="string")throw new Error("Binary protocols over XmlHttpRequest not implementing advanced features are not supported.");let[o,r]=oe(),i={[o]:r,...this._options.headers},a={abortSignal:this._pollAbort.signal,headers:i,timeout:1e5,withCredentials:this._options.withCredentials};e===B.Binary&&(a.responseType="arraybuffer");let s=await this._getAccessToken();this._updateHeaderToken(a,s);let u=`${t}&_=${Date.now()}`;this._logger.log(m.Trace,`(LongPolling transport) polling: ${u}.`);let c=await this._httpClient.get(u,a);c.statusCode!==200?(this._logger.log(m.Error,`(LongPolling transport) Unexpected response code: ${c.statusCode}.`),this._closeError=new $(c.statusText||"",c.statusCode),this._running=!1):this._running=!0,this._receiving=this._poll(this._url,a)}async _getAccessToken(){return this._accessTokenFactory?await this._accessTokenFactory():null}_updateHeaderToken(t,e){if(t.headers||(t.headers={}),e){t.headers[q.Authorization]=`Bearer ${e}`;return}t.headers[q.Authorization]&&delete t.headers[q.Authorization]}async _poll(t,e){try{for(;this._running;){let o=await this._getAccessToken();this._updateHeaderToken(e,o);try{let r=`${t}&_=${Date.now()}`;this._logger.log(m.Trace,`(LongPolling transport) polling: ${r}.`);let i=await this._httpClient.get(r,e);i.statusCode===204?(this._logger.log(m.Information,"(LongPolling transport) Poll terminated by server."),this._running=!1):i.statusCode!==200?(this._logger.log(m.Error,`(LongPolling transport) Unexpected response code: ${i.statusCode}.`),this._closeError=new $(i.statusText||"",i.statusCode),this._running=!1):i.content?(this._logger.log(m.Trace,`(LongPolling transport) data received. ${we(i.content,this._options.logMessageContent)}.`),this.onreceive&&this.onreceive(i.content)):this._logger.log(m.Trace,"(LongPolling transport) Poll timed out, reissuing.")}catch(r){this._running?r instanceof xe?this._logger.log(m.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this._closeError=r,this._running=!1):this._logger.log(m.Trace,`(LongPolling transport) Poll errored after shutdown: ${r.message}`)}}}finally{this._logger.log(m.Trace,"(LongPolling transport) Polling complete."),this.pollAborted||this._raiseOnClose()}}async send(t){return this._running?Xt(this._logger,"LongPolling",this._httpClient,this._url,this._accessTokenFactory,t,this._options):Promise.reject(new Error("Cannot send until the transport is connected"))}async stop(){this._logger.log(m.Trace,"(LongPolling transport) Stopping polling."),this._running=!1,this._pollAbort.abort();try{await this._receiving,this._logger.log(m.Trace,`(LongPolling transport) sending DELETE request to ${this._url}.`);let t={},[e,o]=oe();t[e]=o;let r={headers:{...t,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials},i=await this._getAccessToken();this._updateHeaderToken(r,i),await this._httpClient.delete(this._url,r),this._logger.log(m.Trace,"(LongPolling transport) DELETE request sent.")}finally{this._logger.log(m.Trace,"(LongPolling transport) Stop finished."),this._raiseOnClose()}}_raiseOnClose(){if(this.onclose){let t="(LongPolling transport) Firing onclose event.";this._closeError&&(t+=" Error: "+this._closeError),this._logger.log(m.Trace,t),this.onclose(this._closeError)}}};var an=class{constructor(t,e,o,r){this._httpClient=t,this._accessTokenFactory=e,this._logger=o,this._options=r,this.onreceive=null,this.onclose=null}async connect(t,e){if(b.isRequired(t,"url"),b.isRequired(e,"transferFormat"),b.isIn(e,B,"transferFormat"),this._logger.log(m.Trace,"(SSE transport) Connecting."),this._url=t,this._accessTokenFactory){let o=await this._accessTokenFactory();o&&(t+=(t.indexOf("?")<0?"?":"&")+`access_token=${encodeURIComponent(o)}`)}return new Promise((o,r)=>{let i=!1;if(e!==B.Text){r(new Error("The Server-Sent Events transport only supports the 'Text' transfer format"));return}let a;if(y.isBrowser||y.isWebWorker)a=new this._options.EventSource(t,{withCredentials:this._options.withCredentials});else{let s=this._httpClient.getCookieString(t),u={};u.Cookie=s;let[c,l]=oe();u[c]=l,a=new this._options.EventSource(t,{withCredentials:this._options.withCredentials,headers:{...u,...this._options.headers}})}try{a.onmessage=s=>{if(this.onreceive)try{this._logger.log(m.Trace,`(SSE transport) data received. ${we(s.data,this._options.logMessageContent)}.`),this.onreceive(s.data)}catch(u){this._close(u);return}},a.onerror=s=>{i?this._close():r(new Error("EventSource failed to connect. The connection could not be found on the server, either the connection ID is not present on the server, or a proxy is refusing/buffering the connection. If you have multiple servers check that sticky sessions are enabled."))},a.onopen=()=>{this._logger.log(m.Information,`SSE connected to ${this._url}`),this._eventSource=a,i=!0,o()}}catch(s){r(s);return}})}async send(t){return this._eventSource?Xt(this._logger,"SSE",this._httpClient,this._url,this._accessTokenFactory,t,this._options):Promise.reject(new Error("Cannot send until the transport is connected"))}stop(){return this._close(),Promise.resolve()}_close(t){this._eventSource&&(this._eventSource.close(),this._eventSource=void 0,this.onclose&&this.onclose(t))}};var sn=class{constructor(t,e,o,r,i,a){this._logger=o,this._accessTokenFactory=e,this._logMessageContent=r,this._webSocketConstructor=i,this._httpClient=t,this.onreceive=null,this.onclose=null,this._headers=a}async connect(t,e){if(b.isRequired(t,"url"),b.isRequired(e,"transferFormat"),b.isIn(e,B,"transferFormat"),this._logger.log(m.Trace,"(WebSockets transport) Connecting."),this._accessTokenFactory){let o=await this._accessTokenFactory();o&&(t+=(t.indexOf("?")<0?"?":"&")+`access_token=${encodeURIComponent(o)}`)}return new Promise((o,r)=>{t=t.replace(/^http/,"ws");let i,a=this._httpClient.getCookieString(t),s=!1;if(y.isNode){let u={},[c,l]=oe();u[c]=l,a&&(u[q.Cookie]=`${a}`),i=new this._webSocketConstructor(t,void 0,{headers:{...u,...this._headers}})}i||(i=new this._webSocketConstructor(t)),e===B.Binary&&(i.binaryType="arraybuffer"),i.onopen=u=>{this._logger.log(m.Information,`WebSocket connected to ${t}.`),this._webSocket=i,s=!0,o()},i.onerror=u=>{let c=null;typeof ErrorEvent!="undefined"&&u instanceof ErrorEvent?c=u.error:c="There was an error with the transport",this._logger.log(m.Information,`(WebSockets transport) ${c}.`)},i.onmessage=u=>{if(this._logger.log(m.Trace,`(WebSockets transport) data received. ${we(u.data,this._logMessageContent)}.`),this.onreceive)try{this.onreceive(u.data)}catch(c){this._close(c);return}},i.onclose=u=>{if(s)this._close(u);else{let c=null;typeof ErrorEvent!="undefined"&&u instanceof ErrorEvent?c=u.error:c="WebSocket failed to connect. The connection could not be found on the server, either the endpoint may not be a SignalR endpoint, the connection ID is not present on the server, or there is a proxy blocking WebSockets. If you have multiple servers check that sticky sessions are enabled.",r(new Error(c))}}})}send(t){return this._webSocket&&this._webSocket.readyState===this._webSocketConstructor.OPEN?(this._logger.log(m.Trace,`(WebSockets transport) sending data. ${we(t,this._logMessageContent)}.`),this._webSocket.send(t),Promise.resolve()):Promise.reject("WebSocket is not in the OPEN state")}stop(){return this._webSocket&&this._close(void 0),Promise.resolve()}_close(t){this._webSocket&&(this._webSocket.onclose=()=>{},this._webSocket.onmessage=()=>{},this._webSocket.onerror=()=>{},this._webSocket.close(),this._webSocket=void 0),this._logger.log(m.Trace,"(WebSockets transport) socket closed."),this.onclose&&(this._isCloseEvent(t)&&(t.wasClean===!1||t.code!==1e3)?this.onclose(new Error(`WebSocket closed with status code: ${t.code} (${t.reason||"no reason given"}).`)):t instanceof Error?this.onclose(t):this.onclose())}_isCloseEvent(t){return t&&typeof t.wasClean=="boolean"&&typeof t.code=="number"}};var ji=100,un=class{constructor(t,e={}){if(this._stopPromiseResolver=()=>{},this.features={},this._negotiateVersion=1,b.isRequired(t,"url"),this._logger=zi(e.logger),this.baseUrl=this._resolveUrl(t),e=e||{},e.logMessageContent=e.logMessageContent===void 0?!1:e.logMessageContent,typeof e.withCredentials=="boolean"||e.withCredentials===void 0)e.withCredentials=e.withCredentials===void 0?!0:e.withCredentials;else throw new Error("withCredentials option was not a 'boolean' or 'undefined' value");e.timeout=e.timeout===void 0?100*1e3:e.timeout;let o=null,r=null;if(y.isNode&&typeof Pe!="undefined"){let i=typeof __webpack_require__=="function"?__non_webpack_require__:Pe;o=i("ws"),r=i("eventsource")}!y.isNode&&typeof WebSocket!="undefined"&&!e.WebSocket?e.WebSocket=WebSocket:y.isNode&&!e.WebSocket&&o&&(e.WebSocket=o),!y.isNode&&typeof EventSource!="undefined"&&!e.EventSource?e.EventSource=EventSource:y.isNode&&!e.EventSource&&typeof r!="undefined"&&(e.EventSource=r),this._httpClient=e.httpClient||new tn(this._logger),this._connectionState="Disconnected",this._connectionStarted=!1,this._options=e,this.onreceive=null,this.onclose=null}async start(t){if(t=t||B.Binary,b.isIn(t,B,"transferFormat"),this._logger.log(m.Debug,`Starting connection with transfer format '${B[t]}'.`),this._connectionState!=="Disconnected")return Promise.reject(new Error("Cannot start an HttpConnection that is not in the 'Disconnected' state."));if(this._connectionState="Connecting",this._startInternalPromise=this._startInternal(t),await this._startInternalPromise,this._connectionState==="Disconnecting"){let e="Failed to start the HttpConnection before stop() was called.";return this._logger.log(m.Error,e),await this._stopPromise,Promise.reject(new Error(e))}else if(this._connectionState!=="Connected"){let e="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!";return this._logger.log(m.Error,e),Promise.reject(new Error(e))}this._connectionStarted=!0}send(t){return this._connectionState!=="Connected"?Promise.reject(new Error("Cannot send data if the connection is not in the 'Connected' State.")):(this._sendQueue||(this._sendQueue=new pt(this.transport)),this._sendQueue.send(t))}async stop(t){if(this._connectionState==="Disconnected")return this._logger.log(m.Debug,`Call to HttpConnection.stop(${t}) ignored because the connection is already in the disconnected state.`),Promise.resolve();if(this._connectionState==="Disconnecting")return this._logger.log(m.Debug,`Call to HttpConnection.stop(${t}) ignored because the connection is already in the disconnecting state.`),this._stopPromise;this._connectionState="Disconnecting",this._stopPromise=new Promise(e=>{this._stopPromiseResolver=e}),await this._stopInternal(t),await this._stopPromise}async _stopInternal(t){this._stopError=t;try{await this._startInternalPromise}catch{}if(this.transport){try{await this.transport.stop()}catch(e){this._logger.log(m.Error,`HttpConnection.transport.stop() threw error '${e}'.`),this._stopConnection()}this.transport=void 0}else this._logger.log(m.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed.")}async _startInternal(t){let e=this.baseUrl;this._accessTokenFactory=this._options.accessTokenFactory;try{if(this._options.skipNegotiation)if(this._options.transport===L.WebSockets)this.transport=this._constructTransport(L.WebSockets),await this._startTransport(e,t);else throw new Error("Negotiation can only be skipped when using the WebSocket transport directly.");else{let o=null,r=0;do{if(o=await this._getNegotiationResponse(e),this._connectionState==="Disconnecting"||this._connectionState==="Disconnected")throw new Error("The connection was stopped during negotiation.");if(o.error)throw new Error(o.error);if(o.ProtocolVersion)throw new Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");if(o.url&&(e=o.url),o.accessToken){let i=o.accessToken;this._accessTokenFactory=()=>i}r++}while(o.url&&r<ji);if(r===ji&&o.url)throw new Error("Negotiate redirection limit exceeded.");await this._createTransport(e,this._options.transport,o,t)}this.transport instanceof lt&&(this.features.inherentKeepAlive=!0),this._connectionState==="Connecting"&&(this._logger.log(m.Debug,"The HttpConnection connected successfully."),this._connectionState="Connected")}catch(o){return this._logger.log(m.Error,"Failed to start the connection: "+o),this._connectionState="Disconnected",this.transport=void 0,this._stopPromiseResolver(),Promise.reject(o)}}async _getNegotiationResponse(t){let e={};if(this._accessTokenFactory){let a=await this._accessTokenFactory();a&&(e[q.Authorization]=`Bearer ${a}`)}let[o,r]=oe();e[o]=r;let i=this._resolveNegotiateUrl(t);this._logger.log(m.Debug,`Sending negotiation request: ${i}.`);try{let a=await this._httpClient.post(i,{content:"",headers:{...e,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials});if(a.statusCode!==200)return Promise.reject(new Error(`Unexpected status code returned from negotiate '${a.statusCode}'`));let s=JSON.parse(a.content);return(!s.negotiateVersion||s.negotiateVersion<1)&&(s.connectionToken=s.connectionId),s}catch(a){let s="Failed to complete negotiation with the server: "+a;return a instanceof $&&a.statusCode===404&&(s=s+" Either this is not a SignalR endpoint or there is a proxy blocking the connection."),this._logger.log(m.Error,s),Promise.reject(new qt(s))}}_createConnectUrl(t,e){return e?t+(t.indexOf("?")===-1?"?":"&")+`id=${e}`:t}async _createTransport(t,e,o,r){let i=this._createConnectUrl(t,o.connectionToken);if(this._isITransport(e)){this._logger.log(m.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=e,await this._startTransport(i,r),this.connectionId=o.connectionId;return}let a=[],s=o.availableTransports||[],u=o;for(let c of s){let l=this._resolveTransportOrError(c,e,r);if(l instanceof Error)a.push(`${c.transport} failed:`),a.push(l);else if(this._isITransport(l)){if(this.transport=l,!u){try{u=await this._getNegotiationResponse(t)}catch(F){return Promise.reject(F)}i=this._createConnectUrl(t,u.connectionToken)}try{await this._startTransport(i,r),this.connectionId=u.connectionId;return}catch(F){if(this._logger.log(m.Error,`Failed to start the transport '${c.transport}': ${F}`),u=void 0,a.push(new $t(`${c.transport} failed: ${F}`,L[c.transport])),this._connectionState!=="Connecting"){let h="Failed to select transport before stop() was called.";return this._logger.log(m.Debug,h),Promise.reject(new Error(h))}}}}return a.length>0?Promise.reject(new Jt(`Unable to connect to the server with any of the available transports. ${a.join(" ")}`,a)):Promise.reject(new Error("None of the transports supported by the client are supported by the server."))}_constructTransport(t){switch(t){case L.WebSockets:if(!this._options.WebSocket)throw new Error("'WebSocket' is not supported in your environment.");return new sn(this._httpClient,this._accessTokenFactory,this._logger,this._options.logMessageContent,this._options.WebSocket,this._options.headers||{});case L.ServerSentEvents:if(!this._options.EventSource)throw new Error("'EventSource' is not supported in your environment.");return new an(this._httpClient,this._accessTokenFactory,this._logger,this._options);case L.LongPolling:return new lt(this._httpClient,this._accessTokenFactory,this._logger,this._options);default:throw new Error(`Unknown transport: ${t}.`)}}_startTransport(t,e){return this.transport.onreceive=this.onreceive,this.transport.onclose=o=>this._stopConnection(o),this.transport.connect(t,e)}_resolveTransportOrError(t,e,o){let r=L[t.transport];if(r==null)return this._logger.log(m.Debug,`Skipping transport '${t.transport}' because it is not supported by this client.`),new Error(`Skipping transport '${t.transport}' because it is not supported by this client.`);if(zu(e,r))if(t.transferFormats.map(a=>B[a]).indexOf(o)>=0){if(r===L.WebSockets&&!this._options.WebSocket||r===L.ServerSentEvents&&!this._options.EventSource)return this._logger.log(m.Debug,`Skipping transport '${L[r]}' because it is not supported in your environment.'`),new jt(`'${L[r]}' is not supported in your environment.`,r);this._logger.log(m.Debug,`Selecting transport '${L[r]}'.`);try{return this._constructTransport(r)}catch(a){return a}}else return this._logger.log(m.Debug,`Skipping transport '${L[r]}' because it does not support the requested transfer format '${B[o]}'.`),new Error(`'${L[r]}' does not support ${B[o]}.`);else return this._logger.log(m.Debug,`Skipping transport '${L[r]}' because it was disabled by the client.`),new Kt(`'${L[r]}' is disabled by the client.`,r)}_isITransport(t){return t&&typeof t=="object"&&"connect"in t}_stopConnection(t){if(this._logger.log(m.Debug,`HttpConnection.stopConnection(${t}) called while in state ${this._connectionState}.`),this.transport=void 0,t=this._stopError||t,this._stopError=void 0,this._connectionState==="Disconnected"){this._logger.log(m.Debug,`Call to HttpConnection.stopConnection(${t}) was ignored because the connection is already in the disconnected state.`);return}if(this._connectionState==="Connecting")throw this._logger.log(m.Warning,`Call to HttpConnection.stopConnection(${t}) was ignored because the connection is still in the connecting state.`),new Error(`HttpConnection.stopConnection(${t}) was called while the connection is still in the connecting state.`);if(this._connectionState==="Disconnecting"&&this._stopPromiseResolver(),t?this._logger.log(m.Error,`Connection disconnected with error '${t}'.`):this._logger.log(m.Information,"Connection disconnected."),this._sendQueue&&(this._sendQueue.stop().catch(e=>{this._logger.log(m.Error,`TransportSendQueue.stop() threw error '${e}'.`)}),this._sendQueue=void 0),this.connectionId=void 0,this._connectionState="Disconnected",this._connectionStarted){this._connectionStarted=!1;try{this.onclose&&this.onclose(t)}catch(e){this._logger.log(m.Error,`HttpConnection.onclose(${t}) threw error '${e}'.`)}}}_resolveUrl(t){if(t.lastIndexOf("https://",0)===0||t.lastIndexOf("http://",0)===0)return t;if(!y.isBrowser)throw new Error(`Cannot resolve '${t}'.`);let e=window.document.createElement("a");return e.href=t,this._logger.log(m.Information,`Normalizing '${t}' to '${e.href}'.`),e.href}_resolveNegotiateUrl(t){let e=t.indexOf("?"),o=t.substring(0,e===-1?t.length:e);return o[o.length-1]!=="/"&&(o+="/"),o+="negotiate",o+=e===-1?"":t.substring(e),o.indexOf("negotiateVersion")===-1&&(o+=e===-1?"?":"&",o+="negotiateVersion="+this._negotiateVersion),o}};function zu(n,t){return!n||(t&n)!==0}var pt=class{constructor(t){this._transport=t,this._buffer=[],this._executing=!0,this._sendBufferedData=new He,this._transportResult=new He,this._sendLoopPromise=this._sendLoop()}send(t){return this._bufferData(t),this._transportResult||(this._transportResult=new He),this._transportResult.promise}stop(){return this._executing=!1,this._sendBufferedData.resolve(),this._sendLoopPromise}_bufferData(t){if(this._buffer.length&&typeof this._buffer[0]!=typeof t)throw new Error(`Expected data to be of type ${typeof this._buffer} but was of type ${typeof t}`);this._buffer.push(t),this._sendBufferedData.resolve()}async _sendLoop(){for(;;){if(await this._sendBufferedData.promise,!this._executing){this._transportResult&&this._transportResult.reject("Connection stopped.");break}this._sendBufferedData=new He;let t=this._transportResult;this._transportResult=void 0;let e=typeof this._buffer[0]=="string"?this._buffer.join(""):pt._concatBuffers(this._buffer);this._buffer.length=0;try{await this._transport.send(e),t.resolve()}catch(o){t.reject(o)}}}static _concatBuffers(t){let e=t.map(i=>i.byteLength).reduce((i,a)=>i+a),o=new Uint8Array(e),r=0;for(let i of t)o.set(new Uint8Array(i),r),r+=i.byteLength;return o.buffer}},He=class{constructor(){this.promise=new Promise((t,e)=>[this._resolver,this._rejecter]=[t,e])}resolve(){this._resolver()}reject(t){this._rejecter(t)}};var Vu="json",cn=class{constructor(){this.name=Vu,this.version=1,this.transferFormat=B.Text}parseMessages(t,e){if(typeof t!="string")throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!t)return[];e===null&&(e=ne.instance);let o=I.parse(t),r=[];for(let i of o){let a=JSON.parse(i);if(typeof a.type!="number")throw new Error("Invalid payload.");switch(a.type){case M.Invocation:this._isInvocationMessage(a);break;case M.StreamItem:this._isStreamItemMessage(a);break;case M.Completion:this._isCompletionMessage(a);break;case M.Ping:break;case M.Close:break;default:e.log(m.Information,"Unknown message type '"+a.type+"' ignored.");continue}r.push(a)}return r}writeMessage(t){return I.write(JSON.stringify(t))}_isInvocationMessage(t){this._assertNotEmptyString(t.target,"Invalid payload for Invocation message."),t.invocationId!==void 0&&this._assertNotEmptyString(t.invocationId,"Invalid payload for Invocation message.")}_isStreamItemMessage(t){if(this._assertNotEmptyString(t.invocationId,"Invalid payload for StreamItem message."),t.item===void 0)throw new Error("Invalid payload for StreamItem message.")}_isCompletionMessage(t){if(t.result&&t.error)throw new Error("Invalid payload for Completion message.");!t.result&&t.error&&this._assertNotEmptyString(t.error,"Invalid payload for Completion message."),this._assertNotEmptyString(t.invocationId,"Invalid payload for Completion message.")}_assertNotEmptyString(t,e){if(typeof t!="string"||t==="")throw new Error(e)}};var Gu={trace:m.Trace,debug:m.Debug,info:m.Information,information:m.Information,warn:m.Warning,warning:m.Warning,error:m.Error,critical:m.Critical,none:m.None};function ju(n){let t=Gu[n.toLowerCase()];if(typeof t!="undefined")return t;throw new Error(`Unknown log level: ${n}`)}var Ft=class{configureLogging(t){if(b.isRequired(t,"logging"),Ku(t))this.logger=t;else if(typeof t=="string"){let e=ju(t);this.logger=new be(e)}else this.logger=new be(t);return this}withUrl(t,e){return b.isRequired(t,"url"),b.isNotEmpty(t,"url"),this.url=t,typeof e=="object"?this.httpConnectionOptions={...this.httpConnectionOptions,...e}:this.httpConnectionOptions={...this.httpConnectionOptions,transport:e},this}withHubProtocol(t){return b.isRequired(t,"protocol"),this.protocol=t,this}withAutomaticReconnect(t){if(this.reconnectPolicy)throw new Error("A reconnectPolicy has already been set.");return t?Array.isArray(t)?this.reconnectPolicy=new ct(t):this.reconnectPolicy=t:this.reconnectPolicy=new ct,this}build(){let t=this.httpConnectionOptions||{};if(t.logger===void 0&&(t.logger=this.logger),!this.url)throw new Error("The 'HubConnectionBuilder.withUrl' method must be called before building the connection.");let e=new un(this.url,t);return Ce.create(e,this.logger||ne.instance,this.protocol||new cn,this.reconnectPolicy)}};function Ku(n){return n.log!==void 0}var $i=!0,qi=!0;function mt(n,t,e){let o=n.match(t);return o&&o.length>=e&&parseInt(o[e],10)}function pe(n,t,e){if(!n.RTCPeerConnection)return;let o=n.RTCPeerConnection.prototype,r=o.addEventListener;o.addEventListener=function(a,s){if(a!==t)return r.apply(this,arguments);let u=c=>{let l=e(c);l&&(s.handleEvent?s.handleEvent(l):s(l))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(s,u),r.apply(this,[a,u])};let i=o.removeEventListener;o.removeEventListener=function(a,s){if(a!==t||!this._eventMap||!this._eventMap[t])return i.apply(this,arguments);if(!this._eventMap[t].has(s))return i.apply(this,arguments);let u=this._eventMap[t].get(s);return this._eventMap[t].delete(s),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,i.apply(this,[a,u])},Object.defineProperty(o,"on"+t,{get(){return this["_on"+t]},set(a){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),a&&this.addEventListener(t,this["_on"+t]=a)},enumerable:!0,configurable:!0})}function Ji(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):($i=n,n?"adapter.js logging disabled":"adapter.js logging enabled")}function Yi(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(qi=!n,"adapter.js deprecation warnings "+(n?"disabled":"enabled"))}function ln(){if(typeof window=="object"){if($i)return;typeof console!="undefined"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function We(n,t){!qi||console.warn(n+" is deprecated, please use "+t+" instead.")}function Qi(n){let t={browser:null,version:null};if(typeof n=="undefined"||!n.navigator)return t.browser="Not a browser.",t;let{navigator:e}=n;if(e.mozGetUserMedia)t.browser="firefox",t.version=mt(e.userAgent,/Firefox\/(\d+)\./,1);else if(e.webkitGetUserMedia||n.isSecureContext===!1&&n.webkitRTCPeerConnection&&!n.RTCIceGatherer)t.browser="chrome",t.version=mt(e.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(n.RTCPeerConnection&&e.userAgent.match(/AppleWebKit\/(\d+)\./))t.browser="safari",t.version=mt(e.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=n.RTCRtpTransceiver&&"currentDirection"in n.RTCRtpTransceiver.prototype;else return t.browser="Not a supported browser.",t;return t}function Ki(n){return Object.prototype.toString.call(n)==="[object Object]"}function Qo(n){return Ki(n)?Object.keys(n).reduce(function(t,e){let o=Ki(n[e]),r=o?Qo(n[e]):n[e],i=o&&!Object.keys(r).length;return r===void 0||i?t:Object.assign(t,{[e]:r})},{}):n}function Yo(n,t,e){!t||e.has(t.id)||(e.set(t.id,t),Object.keys(t).forEach(o=>{o.endsWith("Id")?Yo(n,n.get(t[o]),e):o.endsWith("Ids")&&t[o].forEach(r=>{Yo(n,n.get(r),e)})}))}function Xo(n,t,e){let o=e?"outbound-rtp":"inbound-rtp",r=new Map;if(t===null)return r;let i=[];return n.forEach(a=>{a.type==="track"&&a.trackIdentifier===t.id&&i.push(a)}),i.forEach(a=>{n.forEach(s=>{s.type===o&&s.trackId===a.id&&Yo(n,s,r)})}),r}var mn={};et(mn,{fixNegotiationNeeded:()=>ir,shimAddTrackRemoveTrack:()=>rr,shimAddTrackRemoveTrackWithNative:()=>ea,shimGetDisplayMedia:()=>Zi,shimGetSendersWithDtmf:()=>tr,shimGetStats:()=>nr,shimGetUserMedia:()=>pn,shimMediaStream:()=>Zo,shimOnTrack:()=>er,shimPeerConnection:()=>Fn,shimSenderReceiverGetStats:()=>or});var Xi=ln;function pn(n,t){let e=n&&n.navigator;if(!e.mediaDevices)return;let o=function(s){if(typeof s!="object"||s.mandatory||s.optional)return s;let u={};return Object.keys(s).forEach(c=>{if(c==="require"||c==="advanced"||c==="mediaSource")return;let l=typeof s[c]=="object"?s[c]:{ideal:s[c]};l.exact!==void 0&&typeof l.exact=="number"&&(l.min=l.max=l.exact);let F=function(h,f){return h?h+f.charAt(0).toUpperCase()+f.slice(1):f==="deviceId"?"sourceId":f};if(l.ideal!==void 0){u.optional=u.optional||[];let h={};typeof l.ideal=="number"?(h[F("min",c)]=l.ideal,u.optional.push(h),h={},h[F("max",c)]=l.ideal,u.optional.push(h)):(h[F("",c)]=l.ideal,u.optional.push(h))}l.exact!==void 0&&typeof l.exact!="number"?(u.mandatory=u.mandatory||{},u.mandatory[F("",c)]=l.exact):["min","max"].forEach(h=>{l[h]!==void 0&&(u.mandatory=u.mandatory||{},u.mandatory[F(h,c)]=l[h])})}),s.advanced&&(u.optional=(u.optional||[]).concat(s.advanced)),u},r=function(s,u){if(t.version>=61)return u(s);if(s=JSON.parse(JSON.stringify(s)),s&&typeof s.audio=="object"){let c=function(l,F,h){F in l&&!(h in l)&&(l[h]=l[F],delete l[F])};s=JSON.parse(JSON.stringify(s)),c(s.audio,"autoGainControl","googAutoGainControl"),c(s.audio,"noiseSuppression","googNoiseSuppression"),s.audio=o(s.audio)}if(s&&typeof s.video=="object"){let c=s.video.facingMode;c=c&&(typeof c=="object"?c:{ideal:c});let l=t.version<66;if(c&&(c.exact==="user"||c.exact==="environment"||c.ideal==="user"||c.ideal==="environment")&&!(e.mediaDevices.getSupportedConstraints&&e.mediaDevices.getSupportedConstraints().facingMode&&!l)){delete s.video.facingMode;let F;if(c.exact==="environment"||c.ideal==="environment"?F=["back","rear"]:(c.exact==="user"||c.ideal==="user")&&(F=["front"]),F)return e.mediaDevices.enumerateDevices().then(h=>{h=h.filter(x=>x.kind==="videoinput");let f=h.find(x=>F.some(w=>x.label.toLowerCase().includes(w)));return!f&&h.length&&F.includes("back")&&(f=h[h.length-1]),f&&(s.video.deviceId=c.exact?{exact:f.deviceId}:{ideal:f.deviceId}),s.video=o(s.video),Xi("chrome: "+JSON.stringify(s)),u(s)})}s.video=o(s.video)}return Xi("chrome: "+JSON.stringify(s)),u(s)},i=function(s){return t.version>=64?s:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[s.name]||s.name,message:s.message,constraint:s.constraint||s.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},a=function(s,u,c){r(s,l=>{e.webkitGetUserMedia(l,u,F=>{c&&c(i(F))})})};if(e.getUserMedia=a.bind(e),e.mediaDevices.getUserMedia){let s=e.mediaDevices.getUserMedia.bind(e.mediaDevices);e.mediaDevices.getUserMedia=function(u){return r(u,c=>s(c).then(l=>{if(c.audio&&!l.getAudioTracks().length||c.video&&!l.getVideoTracks().length)throw l.getTracks().forEach(F=>{F.stop()}),new DOMException("","NotFoundError");return l},l=>Promise.reject(i(l))))}}}function Zi(n,t){if(!(n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices)&&!!n.navigator.mediaDevices){if(typeof t!="function"){console.error("shimGetDisplayMedia: getSourceId argument is not a function");return}n.navigator.mediaDevices.getDisplayMedia=function(o){return t(o).then(r=>{let i=o.video&&o.video.width,a=o.video&&o.video.height,s=o.video&&o.video.frameRate;return o.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,maxFrameRate:s||3}},i&&(o.video.mandatory.maxWidth=i),a&&(o.video.mandatory.maxHeight=a),n.navigator.mediaDevices.getUserMedia(o)})}}}function Zo(n){n.MediaStream=n.MediaStream||n.webkitMediaStream}function er(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("ontrack"in n.RTCPeerConnection.prototype)){Object.defineProperty(n.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});let t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=o=>{o.stream.addEventListener("addtrack",r=>{let i;n.RTCPeerConnection.prototype.getReceivers?i=this.getReceivers().find(s=>s.track&&s.track.id===r.track.id):i={track:r.track};let a=new Event("track");a.track=r.track,a.receiver=i,a.transceiver={receiver:i},a.streams=[o.stream],this.dispatchEvent(a)}),o.stream.getTracks().forEach(r=>{let i;n.RTCPeerConnection.prototype.getReceivers?i=this.getReceivers().find(s=>s.track&&s.track.id===r.id):i={track:r};let a=new Event("track");a.track=r,a.receiver=i,a.transceiver={receiver:i},a.streams=[o.stream],this.dispatchEvent(a)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else pe(n,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function tr(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("getSenders"in n.RTCPeerConnection.prototype)&&"createDTMFSender"in n.RTCPeerConnection.prototype){let t=function(r,i){return{track:i,get dtmf(){return this._dtmf===void 0&&(i.kind==="audio"?this._dtmf=r.createDTMFSender(i):this._dtmf=null),this._dtmf},_pc:r}};if(!n.RTCPeerConnection.prototype.getSenders){n.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let r=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(s,u){let c=r.apply(this,arguments);return c||(c=t(this,s),this._senders.push(c)),c};let i=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(s){i.apply(this,arguments);let u=this._senders.indexOf(s);u!==-1&&this._senders.splice(u,1)}}let e=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(i){this._senders=this._senders||[],e.apply(this,[i]),i.getTracks().forEach(a=>{this._senders.push(t(this,a))})};let o=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(i){this._senders=this._senders||[],o.apply(this,[i]),i.getTracks().forEach(a=>{let s=this._senders.find(u=>u.track===a);s&&this._senders.splice(this._senders.indexOf(s),1)})}}else if(typeof n=="object"&&n.RTCPeerConnection&&"getSenders"in n.RTCPeerConnection.prototype&&"createDTMFSender"in n.RTCPeerConnection.prototype&&n.RTCRtpSender&&!("dtmf"in n.RTCRtpSender.prototype)){let t=n.RTCPeerConnection.prototype.getSenders;n.RTCPeerConnection.prototype.getSenders=function(){let o=t.apply(this,[]);return o.forEach(r=>r._pc=this),o},Object.defineProperty(n.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function nr(n){if(!n.RTCPeerConnection)return;let t=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){let[o,r,i]=arguments;if(arguments.length>0&&typeof o=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof o!="function"))return t.apply(this,[]);let a=function(u){let c={};return u.result().forEach(F=>{let h={id:F.id,timestamp:F.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[F.type]||F.type};F.names().forEach(f=>{h[f]=F.stat(f)}),c[h.id]=h}),c},s=function(u){return new Map(Object.keys(u).map(c=>[c,u[c]]))};if(arguments.length>=2){let u=function(c){r(s(a(c)))};return t.apply(this,[u,o])}return new Promise((u,c)=>{t.apply(this,[function(l){u(s(a(l)))},c])}).then(r,i)}}function or(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender&&n.RTCRtpReceiver))return;if(!("getStats"in n.RTCRtpSender.prototype)){let e=n.RTCPeerConnection.prototype.getSenders;e&&(n.RTCPeerConnection.prototype.getSenders=function(){let i=e.apply(this,[]);return i.forEach(a=>a._pc=this),i});let o=n.RTCPeerConnection.prototype.addTrack;o&&(n.RTCPeerConnection.prototype.addTrack=function(){let i=o.apply(this,arguments);return i._pc=this,i}),n.RTCRtpSender.prototype.getStats=function(){let i=this;return this._pc.getStats().then(a=>Xo(a,i.track,!0))}}if(!("getStats"in n.RTCRtpReceiver.prototype)){let e=n.RTCPeerConnection.prototype.getReceivers;e&&(n.RTCPeerConnection.prototype.getReceivers=function(){let r=e.apply(this,[]);return r.forEach(i=>i._pc=this),r}),pe(n,"track",o=>(o.receiver._pc=o.srcElement,o)),n.RTCRtpReceiver.prototype.getStats=function(){let r=this;return this._pc.getStats().then(i=>Xo(i,r.track,!1))}}if(!("getStats"in n.RTCRtpSender.prototype&&"getStats"in n.RTCRtpReceiver.prototype))return;let t=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof n.MediaStreamTrack){let o=arguments[0],r,i,a;return this.getSenders().forEach(s=>{s.track===o&&(r?a=!0:r=s)}),this.getReceivers().forEach(s=>(s.track===o&&(i?a=!0:i=s),s.track===o)),a||r&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function ea(n){n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(a=>this._shimmedLocalStreams[a][0])};let t=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(a,s){if(!s)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let u=t.apply(this,arguments);return this._shimmedLocalStreams[s.id]?this._shimmedLocalStreams[s.id].indexOf(u)===-1&&this._shimmedLocalStreams[s.id].push(u):this._shimmedLocalStreams[s.id]=[s,u],u};let e=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(a){this._shimmedLocalStreams=this._shimmedLocalStreams||{},a.getTracks().forEach(c=>{if(this.getSenders().find(F=>F.track===c))throw new DOMException("Track already exists.","InvalidAccessError")});let s=this.getSenders();e.apply(this,arguments);let u=this.getSenders().filter(c=>s.indexOf(c)===-1);this._shimmedLocalStreams[a.id]=[a].concat(u)};let o=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[a.id],o.apply(this,arguments)};let r=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},a&&Object.keys(this._shimmedLocalStreams).forEach(s=>{let u=this._shimmedLocalStreams[s].indexOf(a);u!==-1&&this._shimmedLocalStreams[s].splice(u,1),this._shimmedLocalStreams[s].length===1&&delete this._shimmedLocalStreams[s]}),r.apply(this,arguments)}}function rr(n,t){if(!n.RTCPeerConnection)return;if(n.RTCPeerConnection.prototype.addTrack&&t.version>=65)return ea(n);let e=n.RTCPeerConnection.prototype.getLocalStreams;n.RTCPeerConnection.prototype.getLocalStreams=function(){let l=e.apply(this);return this._reverseStreams=this._reverseStreams||{},l.map(F=>this._reverseStreams[F.id])};let o=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(l){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},l.getTracks().forEach(F=>{if(this.getSenders().find(f=>f.track===F))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[l.id]){let F=new n.MediaStream(l.getTracks());this._streams[l.id]=F,this._reverseStreams[F.id]=l,l=F}o.apply(this,[l])};let r=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(l){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[l.id]||l]),delete this._reverseStreams[this._streams[l.id]?this._streams[l.id].id:l.id],delete this._streams[l.id]},n.RTCPeerConnection.prototype.addTrack=function(l,F){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let h=[].slice.call(arguments,1);if(h.length!==1||!h[0].getTracks().find(w=>w===l))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(w=>w.track===l))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let x=this._streams[F.id];if(x)x.addTrack(l),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{let w=new n.MediaStream([l]);this._streams[F.id]=w,this._reverseStreams[w.id]=F,this.addStream(w)}return this.getSenders().find(w=>w.track===l)};function i(c,l){let F=l.sdp;return Object.keys(c._reverseStreams||[]).forEach(h=>{let f=c._reverseStreams[h],x=c._streams[f.id];F=F.replace(new RegExp(x.id,"g"),f.id)}),new RTCSessionDescription({type:l.type,sdp:F})}function a(c,l){let F=l.sdp;return Object.keys(c._reverseStreams||[]).forEach(h=>{let f=c._reverseStreams[h],x=c._streams[f.id];F=F.replace(new RegExp(f.id,"g"),x.id)}),new RTCSessionDescription({type:l.type,sdp:F})}["createOffer","createAnswer"].forEach(function(c){let l=n.RTCPeerConnection.prototype[c],F={[c](){let h=arguments;return arguments.length&&typeof arguments[0]=="function"?l.apply(this,[x=>{let w=i(this,x);h[0].apply(null,[w])},x=>{h[1]&&h[1].apply(null,x)},arguments[2]]):l.apply(this,arguments).then(x=>i(this,x))}};n.RTCPeerConnection.prototype[c]=F[c]});let s=n.RTCPeerConnection.prototype.setLocalDescription;n.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?s.apply(this,arguments):(arguments[0]=a(this,arguments[0]),s.apply(this,arguments))};let u=Object.getOwnPropertyDescriptor(n.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(n.RTCPeerConnection.prototype,"localDescription",{get(){let c=u.get.apply(this);return c.type===""?c:i(this,c)}}),n.RTCPeerConnection.prototype.removeTrack=function(l){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!l._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(l._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let h;Object.keys(this._streams).forEach(f=>{this._streams[f].getTracks().find(w=>l.track===w)&&(h=this._streams[f])}),h&&(h.getTracks().length===1?this.removeStream(this._reverseStreams[h.id]):h.removeTrack(l.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Fn(n,t){!n.RTCPeerConnection&&n.webkitRTCPeerConnection&&(n.RTCPeerConnection=n.webkitRTCPeerConnection),!!n.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){let o=n.RTCPeerConnection.prototype[e],r={[e](){return arguments[0]=new(e==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};n.RTCPeerConnection.prototype[e]=r[e]})}function ir(n,t){pe(n,"negotiationneeded",e=>{let o=e.target;if(!((t.version<72||o.getConfiguration&&o.getConfiguration().sdpSemantics==="plan-b")&&o.signalingState!=="stable"))return e})}var gn={};et(gn,{shimAddTransceiver:()=>pr,shimCreateAnswer:()=>dr,shimCreateOffer:()=>mr,shimGetDisplayMedia:()=>ta,shimGetParameters:()=>Fr,shimGetUserMedia:()=>dn,shimOnTrack:()=>ar,shimPeerConnection:()=>hn,shimRTCDataChannel:()=>lr,shimReceiverGetStats:()=>ur,shimRemoveStream:()=>cr,shimSenderGetStats:()=>sr});function dn(n,t){let e=n&&n.navigator,o=n&&n.MediaStreamTrack;if(e.getUserMedia=function(r,i,a){We("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),e.mediaDevices.getUserMedia(r).then(i,a)},!(t.version>55&&"autoGainControl"in e.mediaDevices.getSupportedConstraints())){let r=function(a,s,u){s in a&&!(u in a)&&(a[u]=a[s],delete a[s])},i=e.mediaDevices.getUserMedia.bind(e.mediaDevices);if(e.mediaDevices.getUserMedia=function(a){return typeof a=="object"&&typeof a.audio=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a.audio,"autoGainControl","mozAutoGainControl"),r(a.audio,"noiseSuppression","mozNoiseSuppression")),i(a)},o&&o.prototype.getSettings){let a=o.prototype.getSettings;o.prototype.getSettings=function(){let s=a.apply(this,arguments);return r(s,"mozAutoGainControl","autoGainControl"),r(s,"mozNoiseSuppression","noiseSuppression"),s}}if(o&&o.prototype.applyConstraints){let a=o.prototype.applyConstraints;o.prototype.applyConstraints=function(s){return this.kind==="audio"&&typeof s=="object"&&(s=JSON.parse(JSON.stringify(s)),r(s,"autoGainControl","mozAutoGainControl"),r(s,"noiseSuppression","mozNoiseSuppression")),a.apply(this,[s])}}}}function ta(n,t){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||!n.navigator.mediaDevices||(n.navigator.mediaDevices.getDisplayMedia=function(o){if(!(o&&o.video)){let r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return o.video===!0?o.video={mediaSource:t}:o.video.mediaSource=t,n.navigator.mediaDevices.getUserMedia(o)})}function ar(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function hn(n,t){if(typeof n!="object"||!(n.RTCPeerConnection||n.mozRTCPeerConnection))return;!n.RTCPeerConnection&&n.mozRTCPeerConnection&&(n.RTCPeerConnection=n.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){let i=n.RTCPeerConnection.prototype[r],a={[r](){return arguments[0]=new(r==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};n.RTCPeerConnection.prototype[r]=a[r]});let e={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){let[i,a,s]=arguments;return o.apply(this,[i||null]).then(u=>{if(t.version<53&&!a)try{u.forEach(c=>{c.type=e[c.type]||c.type})}catch(c){if(c.name!=="TypeError")throw c;u.forEach((l,F)=>{u.set(F,Object.assign({},l,{type:e[l.type]||l.type}))})}return u}).then(a,s)}}function sr(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpSender.prototype)return;let t=n.RTCPeerConnection.prototype.getSenders;t&&(n.RTCPeerConnection.prototype.getSenders=function(){let r=t.apply(this,[]);return r.forEach(i=>i._pc=this),r});let e=n.RTCPeerConnection.prototype.addTrack;e&&(n.RTCPeerConnection.prototype.addTrack=function(){let r=e.apply(this,arguments);return r._pc=this,r}),n.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function ur(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpReceiver.prototype)return;let t=n.RTCPeerConnection.prototype.getReceivers;t&&(n.RTCPeerConnection.prototype.getReceivers=function(){let o=t.apply(this,[]);return o.forEach(r=>r._pc=this),o}),pe(n,"track",e=>(e.receiver._pc=e.srcElement,e)),n.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function cr(n){!n.RTCPeerConnection||"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(e){We("removeStream","removeTrack"),this.getSenders().forEach(o=>{o.track&&e.getTracks().includes(o.track)&&this.removeTrack(o)})})}function lr(n){n.DataChannel&&!n.RTCDataChannel&&(n.RTCDataChannel=n.DataChannel)}function pr(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;let t=n.RTCPeerConnection.prototype.addTransceiver;t&&(n.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let o=arguments[1],r=o&&"sendEncodings"in o;r&&o.sendEncodings.forEach(a=>{if("rid"in a&&!/^[a-z0-9]{0,16}$/i.test(a.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in a&&!(parseFloat(a.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in a&&!(parseFloat(a.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});let i=t.apply(this,arguments);if(r){let{sender:a}=i,s=a.getParameters();(!("encodings"in s)||s.encodings.length===1&&Object.keys(s.encodings[0]).length===0)&&(s.encodings=o.sendEncodings,a.sendEncodings=o.sendEncodings,this.setParametersPromises.push(a.setParameters(s).then(()=>{delete a.sendEncodings}).catch(()=>{delete a.sendEncodings})))}return i})}function Fr(n){if(!(typeof n=="object"&&n.RTCRtpSender))return;let t=n.RTCRtpSender.prototype.getParameters;t&&(n.RTCRtpSender.prototype.getParameters=function(){let o=t.apply(this,arguments);return"encodings"in o||(o.encodings=[].concat(this.sendEncodings||[{}])),o})}function mr(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;let t=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function dr(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;let t=n.RTCPeerConnection.prototype.createAnswer;n.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var fn={};et(fn,{shimAudioContext:()=>kr,shimCallbacksAPI:()=>fr,shimConstraints:()=>na,shimCreateOfferLegacy:()=>Tr,shimGetUserMedia:()=>xr,shimLocalStreamsAPI:()=>hr,shimRTCIceServerUrls:()=>Sr,shimRemoteStreamsAPI:()=>gr,shimTrackEventTransceiver:()=>wr});function hr(n){if(!(typeof n!="object"||!n.RTCPeerConnection)){if("getLocalStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in n.RTCPeerConnection.prototype)){let t=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addStream=function(o){this._localStreams||(this._localStreams=[]),this._localStreams.includes(o)||this._localStreams.push(o),o.getAudioTracks().forEach(r=>t.call(this,r,o)),o.getVideoTracks().forEach(r=>t.call(this,r,o))},n.RTCPeerConnection.prototype.addTrack=function(o,...r){return r&&r.forEach(i=>{this._localStreams?this._localStreams.includes(i)||this._localStreams.push(i):this._localStreams=[i]}),t.apply(this,arguments)}}"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);let o=this._localStreams.indexOf(e);if(o===-1)return;this._localStreams.splice(o,1);let r=e.getTracks();this.getSenders().forEach(i=>{r.includes(i.track)&&this.removeTrack(i)})})}}function gr(n){if(!(typeof n!="object"||!n.RTCPeerConnection)&&("getRemoteStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in n.RTCPeerConnection.prototype))){Object.defineProperty(n.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=o=>{o.streams.forEach(r=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(r))return;this._remoteStreams.push(r);let i=new Event("addstream");i.stream=r,this.dispatchEvent(i)})})}});let t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){let o=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(i=>{if(o._remoteStreams||(o._remoteStreams=[]),o._remoteStreams.indexOf(i)>=0)return;o._remoteStreams.push(i);let a=new Event("addstream");a.stream=i,o.dispatchEvent(a)})}),t.apply(o,arguments)}}}function fr(n){if(typeof n!="object"||!n.RTCPeerConnection)return;let t=n.RTCPeerConnection.prototype,e=t.createOffer,o=t.createAnswer,r=t.setLocalDescription,i=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(c,l){let F=arguments.length>=2?arguments[2]:arguments[0],h=e.apply(this,[F]);return l?(h.then(c,l),Promise.resolve()):h},t.createAnswer=function(c,l){let F=arguments.length>=2?arguments[2]:arguments[0],h=o.apply(this,[F]);return l?(h.then(c,l),Promise.resolve()):h};let s=function(u,c,l){let F=r.apply(this,[u]);return l?(F.then(c,l),Promise.resolve()):F};t.setLocalDescription=s,s=function(u,c,l){let F=i.apply(this,[u]);return l?(F.then(c,l),Promise.resolve()):F},t.setRemoteDescription=s,s=function(u,c,l){let F=a.apply(this,[u]);return l?(F.then(c,l),Promise.resolve()):F},t.addIceCandidate=s}function xr(n){let t=n&&n.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){let e=t.mediaDevices,o=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=r=>o(na(r))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(o,r,i){t.mediaDevices.getUserMedia(o).then(r,i)}.bind(t))}function na(n){return n&&n.video!==void 0?Object.assign({},n,{video:Qo(n.video)}):n}function Sr(n){if(!n.RTCPeerConnection)return;let t=n.RTCPeerConnection;n.RTCPeerConnection=function(o,r){if(o&&o.iceServers){let i=[];for(let a=0;a<o.iceServers.length;a++){let s=o.iceServers[a];!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")?(We("RTCIceServer.url","RTCIceServer.urls"),s=JSON.parse(JSON.stringify(s)),s.urls=s.url,delete s.url,i.push(s)):i.push(o.iceServers[a])}o.iceServers=i}return new t(o,r)},n.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(n.RTCPeerConnection,"generateCertificate",{get(){return t.generateCertificate}})}function wr(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Tr(n){let t=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(o){if(o){typeof o.offerToReceiveAudio!="undefined"&&(o.offerToReceiveAudio=!!o.offerToReceiveAudio);let r=this.getTransceivers().find(a=>a.receiver.track.kind==="audio");o.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):o.offerToReceiveAudio===!0&&!r&&this.addTransceiver("audio",{direction:"recvonly"}),typeof o.offerToReceiveVideo!="undefined"&&(o.offerToReceiveVideo=!!o.offerToReceiveVideo);let i=this.getTransceivers().find(a=>a.receiver.track.kind==="video");o.offerToReceiveVideo===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):o.offerToReceiveVideo===!0&&!i&&this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function kr(n){typeof n!="object"||n.AudioContext||(n.AudioContext=n.webkitAudioContext)}var br={};et(br,{removeExtmapAllowMixed:()=>Sn,shimAddIceCandidateNullOrEmpty:()=>xt,shimConnectionState:()=>xn,shimMaxMessageSize:()=>gt,shimParameterlessSetLocalDescription:()=>St,shimRTCIceCandidate:()=>ht,shimSendThrowTypeError:()=>ft});var dt=ei(Mr());function ht(n){if(!n.RTCIceCandidate||n.RTCIceCandidate&&"foundation"in n.RTCIceCandidate.prototype)return;let t=n.RTCIceCandidate;n.RTCIceCandidate=function(o){if(typeof o=="object"&&o.candidate&&o.candidate.indexOf("a=")===0&&(o=JSON.parse(JSON.stringify(o)),o.candidate=o.candidate.substr(2)),o.candidate&&o.candidate.length){let r=new t(o),i=dt.default.parseCandidate(o.candidate),a=Object.assign(r,i);return a.toJSON=function(){return{candidate:a.candidate,sdpMid:a.sdpMid,sdpMLineIndex:a.sdpMLineIndex,usernameFragment:a.usernameFragment}},a}return new t(o)},n.RTCIceCandidate.prototype=t.prototype,pe(n,"icecandidate",e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new n.RTCIceCandidate(e.candidate),writable:"false"}),e))}function gt(n,t){if(!n.RTCPeerConnection)return;"sctp"in n.RTCPeerConnection.prototype||Object.defineProperty(n.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp=="undefined"?null:this._sctp}});let e=function(s){if(!s||!s.sdp)return!1;let u=dt.default.splitSections(s.sdp);return u.shift(),u.some(c=>{let l=dt.default.parseMLine(c);return l&&l.kind==="application"&&l.protocol.indexOf("SCTP")!==-1})},o=function(s){let u=s.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(u===null||u.length<2)return-1;let c=parseInt(u[1],10);return c!==c?-1:c},r=function(s){let u=65536;return t.browser==="firefox"&&(t.version<57?s===-1?u=16384:u=2147483637:t.version<60?u=t.version===57?65535:65536:u=2147483637),u},i=function(s,u){let c=65536;t.browser==="firefox"&&t.version===57&&(c=65535);let l=dt.default.matchPrefix(s.sdp,"a=max-message-size:");return l.length>0?c=parseInt(l[0].substr(19),10):t.browser==="firefox"&&u!==-1&&(c=2147483637),c},a=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){let{sdpSemantics:u}=this.getConfiguration();u==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp=="undefined"?null:this._sctp},enumerable:!0,configurable:!0})}if(e(arguments[0])){let u=o(arguments[0]),c=r(u),l=i(arguments[0],u),F;c===0&&l===0?F=Number.POSITIVE_INFINITY:c===0||l===0?F=Math.max(c,l):F=Math.min(c,l);let h={};Object.defineProperty(h,"maxMessageSize",{get(){return F}}),this._sctp=h}return a.apply(this,arguments)}}function ft(n){if(!(n.RTCPeerConnection&&"createDataChannel"in n.RTCPeerConnection.prototype))return;function t(o,r){let i=o.send;o.send=function(){let s=arguments[0],u=s.length||s.size||s.byteLength;if(o.readyState==="open"&&r.sctp&&u>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return i.apply(o,arguments)}}let e=n.RTCPeerConnection.prototype.createDataChannel;n.RTCPeerConnection.prototype.createDataChannel=function(){let r=e.apply(this,arguments);return t(r,this),r},pe(n,"datachannel",o=>(t(o.channel,o.target),o))}function xn(n){if(!n.RTCPeerConnection||"connectionState"in n.RTCPeerConnection.prototype)return;let t=n.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{let o=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{let i=r.target;if(i._lastConnectionState!==i.connectionState){i._lastConnectionState=i.connectionState;let a=new Event("connectionstatechange",r);i.dispatchEvent(a)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),o.apply(this,arguments)}})}function Sn(n,t){if(!n.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;let e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){let i=r.sdp.split(`
`).filter(a=>a.trim()!=="a=extmap-allow-mixed").join(`
`);n.RTCSessionDescription&&r instanceof n.RTCSessionDescription?arguments[0]=new n.RTCSessionDescription({type:r.type,sdp:i}):r.sdp=i}return e.apply(this,arguments)}}function xt(n,t){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;let e=n.RTCPeerConnection.prototype.addIceCandidate;!e||e.length===0||(n.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function St(n,t){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;let e=n.RTCPeerConnection.prototype.setLocalDescription;!e||e.length===0||(n.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return e.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer";break}return r.sdp||r.type!=="offer"&&r.type!=="answer"?e.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(a=>e.apply(this,[a]))})}var $u=ei(Mr());function oa({window:n}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){let e=ln,o=Qi(n),r={browserDetails:o,commonShim:br,extractVersion:mt,disableLog:Ji,disableWarnings:Yi,sdp:$u};switch(o.browser){case"chrome":if(!mn||!Fn||!t.shimChrome)return e("Chrome shim is not included in this adapter release."),r;if(o.version===null)return e("Chrome shim can not determine version, not shimming."),r;e("adapter.js shimming chrome."),r.browserShim=mn,xt(n,o),St(n,o),pn(n,o),Zo(n,o),Fn(n,o),er(n,o),rr(n,o),tr(n,o),nr(n,o),or(n,o),ir(n,o),ht(n,o),xn(n,o),gt(n,o),ft(n,o),Sn(n,o);break;case"firefox":if(!gn||!hn||!t.shimFirefox)return e("Firefox shim is not included in this adapter release."),r;e("adapter.js shimming firefox."),r.browserShim=gn,xt(n,o),St(n,o),dn(n,o),hn(n,o),ar(n,o),cr(n,o),sr(n,o),ur(n,o),lr(n,o),pr(n,o),Fr(n,o),mr(n,o),dr(n,o),ht(n,o),xn(n,o),gt(n,o),ft(n,o);break;case"safari":if(!fn||!t.shimSafari)return e("Safari shim is not included in this adapter release."),r;e("adapter.js shimming safari."),r.browserShim=fn,xt(n,o),St(n,o),Sr(n,o),Tr(n,o),fr(n,o),hr(n,o),gr(n,o),wr(n,o),xr(n,o),kr(n,o),ht(n,o),gt(n,o),ft(n,o),Sn(n,o);break;default:e("Unsupported browser!");break}return r}var qu=oa({window:typeof window=="undefined"?void 0:window}),ra=qu;var wn=class{constructor(){this.t=0;this.p=_.create();this.f=_.set(_.create(),0,0,-1);this.u=_.set(_.create(),0,1,0);this.o=_.create();Object.seal(this)}set(t,e,o,r,i,a,s,u,c){this.setPosition(t,e,o),this.setOrientation(r,i,a,s,u,c)}setPosition(t,e,o){_.set(this.p,t,e,o)}setOrientation(t,e,o,r,i,a){_.set(this.f,t,e,o),_.set(this.u,r,i,a)}setOffset(t,e,o){_.set(this.o,t,e,o)}copy(t){_.copy(this.p,t.p),_.copy(this.f,t.f),_.copy(this.u,t.u),_.copy(this.o,t.o)}};var Oe=(S=>(S[S.LocalUser=0]="LocalUser",S[S.Mouse=1]="Mouse",S[S.Pen=2]="Pen",S[S.Touch0=3]="Touch0",S[S.Touch1=4]="Touch1",S[S.Touch2=5]="Touch2",S[S.Touch3=6]="Touch3",S[S.Touch4=7]="Touch4",S[S.Touch5=8]="Touch5",S[S.Touch6=9]="Touch6",S[S.Touch7=10]="Touch7",S[S.Touch8=11]="Touch8",S[S.Touch9=12]="Touch9",S[S.Touch10=13]="Touch10",S[S.Touches=14]="Touches",S[S.MotionController=15]="MotionController",S[S.MotionControllerLeft=16]="MotionControllerLeft",S[S.MotionControllerRight=17]="MotionControllerRight",S[S.RemoteUser=18]="RemoteUser",S))(Oe||{});var ye=class extends Event{constructor(e){super(e);this.eventType=e}},Tn=class extends ye{constructor(e){super("error");this.error=e}};var kn=class extends ye{constructor(){super("serverConnected")}},En=class extends ye{constructor(){super("serverDisconnected")}};var Mn=class extends ye{constructor(e,o){super(e);this.userID=o}},bn=class extends Mn{constructor(e,o){super("roomJoined",e);this.pose=o}},Cn=class extends Mn{constructor(t){super("roomLeft",t)}},Te=class extends ye{constructor(e,o){super(e);this.user=o}},Dn=class extends Te{constructor(e,o){super("userJoined",e);this.source=o}},Ne=class extends Te{constructor(t){super("userLeft",t)}};var yn=class extends Te{constructor(e,o,r){super(e,o);this.muted=r}},vn=class extends yn{constructor(t,e){super("audioMuteStatusChanged",t,e)}},Ln=class extends yn{constructor(t,e){super("videoMuteStatusChanged",t,e)}};var Bn=class extends Te{constructor(e,o,r,i,a){super(e,i);this.kind=o;this.op=r;this.stream=a}},Rn=class extends Bn{constructor(t,e,o,r){super(t,e,"added",o,r)}},Pn=class extends Bn{constructor(t,e,o,r){super(t,e,"removed",o,r)}},_n=class extends Rn{constructor(t,e){super("audioAdded","audio",t,e)}},In=class extends Pn{constructor(t,e){super("audioRemoved","audio",t,e)}},An=class extends Rn{constructor(t,e){super("videoAdded","video",t,e)}},Hn=class extends Pn{constructor(t,e){super("videoRemoved","video",t,e)}},Wn=class extends Te{constructor(e,o){super(e,o);p(this,"pose",new wn)}},On=class extends Wn{constructor(e){super("userPosed",e);p(this,"height",0)}},Nn=class extends Wn{constructor(e){super("userPointer",e);p(this,"name",18)}},Un=class extends Te{constructor(e,o){super("chat",e);this.text=o}};async function ia(n,t,e,o,r,i,a){t()===r?await Po(()=>t()===o):(t()===i&&await Po(()=>t()===a),t()===a&&await e())}function Cr(n,t,e){return ia(n,t,e,"Connected","Connecting","Disconnecting","Disconnected")}function Dr(n,t,e){return ia(n,t,e,"Disconnected","Disconnecting","Connecting","Connected")}var zn="local-user";var Ue=class{constructor(t,e){this.name=t;this._level=0;this.maxLevel=0;this.analyzer=Ni(this.name,e,{fftSize:32,minDecibels:-70}),this.buffer=new Uint8Array(this.analyzer.frequencyBinCount)}dispose(){Gt(this.analyzer)}get level(){return this.analyzer.getByteFrequencyData(this.buffer),this._level=Math.max(...this.buffer),isFinite(this._level)&&(this.maxLevel=Math.max(this.maxLevel,this._level),this.maxLevel>0&&(this._level/=this.maxLevel)),this._level}get input(){return this.analyzer}get output(){return this.analyzer}};var Vn=class{constructor(t,e,o,r,i,a,s,u,c,l,F){this.input=e;this.output=o;this.min=r;this.max=i;this.threshold=a;this.attack=s;this.decay=u;this.sustain=c;this.hold=l;this.release=F;p(this,"activity");p(this,"curLength",0);p(this,"timer",null);p(this,"_enabled",!0);p(this,"shouldRun",!1);this.activity=new Ue("remote-audio-activity",t),ut(this.input,this.activity),this.timer=new Vt(30),this.timer.addTickHandler(h=>this.update(h))}update(t){if(this.enabled){let e=this.activity.level;e>=this.threshold&&this.time>=this.length&&(this.time=0),this.time+=t.dt,this.time>this.length&&(this.time=this.length),e>=this.threshold&&this.holding&&(this.time=this.holdStart),this.output.gain.value=this.gain}}get enabled(){return this._enabled}setEnabled(t){this._enabled=t,this.refresh()}start(){this.shouldRun=!0,this.refresh()}stop(){this.shouldRun=!1,this.refresh()}refresh(){if(this.timer!=null){let t=this.shouldRun&&this.enabled;t!==this.timer.isRunning&&(t?this.timer.start():(this.timer.stop(),this.output.gain.value=1))}}get length(){return this.attack+this.decay+this.hold+this.release}get time(){return this.length-this.curLength}set time(t){this.curLength=this.length-t}get attackStart(){return 0}get attackEnd(){return this.attackStart+this.attack}get decayStart(){return this.attackEnd}get decayEnd(){return this.decayStart+this.decay}get holdStart(){return this.decayEnd}get holdEnd(){return this.holdStart+this.hold}get releaseStart(){return this.holdEnd}get releaseEnd(){return this.releaseStart+this.release}get attacking(){return this.attackStart<=this.time&&this.time<this.attackEnd}get decaying(){return this.decayStart<=this.time&&this.time<this.decayEnd}get holding(){return this.holdStart<=this.time&&this.time<this.holdEnd}get releasing(){return this.releaseStart<this.time&&this.time<this.releaseEnd}get pAttack(){return(this.time-this.attackStart)/this.attack}get pDecay(){return(this.time-this.decayStart)/this.decay}get pRelease(){return(this.time-this.releaseStart)/this.release}get value(){return this.attacking?1-this.pAttack:this.decaying?this.sustain*this.pDecay:this.holding?this.sustain:this.releasing?this.sustain+(1-this.sustain)*this.pRelease:1}get gain(){return Oo(this.value,this.min,this.max)}};var yr=class{constructor(){p(this,"locks",new Set)}isLocked(t){return this.locks.has(t)}isUnlocked(t){return!this.locks.has(t)}lock(t){this.locks.add(t)}unlock(t){this.locks.delete(t)}async withSkipLock(t,e){if(this.isUnlocked(t)){this.lock(t);try{await e()}finally{this.unlock(t)}}}},re=class extends Ee{constructor(e,o){super(e);this.user=o}},vr=class extends re{constructor(e,o){super("iceError",e);p(this,"address");p(this,"errorCode");p(this,"errorText");p(this,"port");p(this,"url");this.address=o.address,this.errorCode=o.errorCode,this.errorText=o.errorText,this.port=o.port,this.url=o.url,Object.seal(this)}},Lr=class extends re{constructor(e,o){super("iceCandidate",e);this.candidate=o}},Br=class extends re{constructor(e,o){super("offer",e);this.offer=o}},Rr=class extends re{constructor(e,o){super("answer",e);this.answer=o}},Pr=class extends re{constructor(t){super("streamNeeded",t)}},_r=class extends re{constructor(e,o,r){super("trackAdded",e);this.track=o;this.stream=r}},Ir=class extends re{constructor(e,o){super("trackMuted",e);this.track=o}},Ar=class extends re{constructor(e,o,r){super("trackRemoved",e);this.track=o;this.stream=r}},aa=new Set;var Gn=class extends j{constructor(e,o,r,i){super();this.userID=e;this.userName=o;this.confirmReceipt=i;p(this,"userPosedEvt",new On(this));p(this,"userPointerEvt",new Nn(this));p(this,"sendPoseBuffer",new Float32Array(12));p(this,"sendPointerBuffer",new Float32Array(12));p(this,"sendInvocationCompleteBuffer",new Float32Array(2));p(this,"transceivers",new Array);p(this,"invocationCount",0);p(this,"invocations",new Map);p(this,"locks",new yr);p(this,"connection");p(this,"channel",null);p(this,"gotOffer",!1);p(this,"disposed",!1);p(this,"trackSent",!1);this.sendPoseBuffer[0]=2,this.sendPointerBuffer[0]=1,this.sendInvocationCompleteBuffer[0]=3,this.connection=new RTCPeerConnection(r),this.connection.addEventListener("icecandidateerror",s=>{this.dispatchEvent(new vr(this,s))}),this.connection.addEventListener("icecandidate",async s=>{s.candidate&&this.dispatchEvent(new Lr(this,s.candidate))}),this.connection.addEventListener("negotiationneeded",async()=>{if(this.trackSent||this.gotOffer){let s=aa.has(this.userID),u=await this.connection.createOffer({iceRestart:s});s||aa.add(this.userID),await this.connection.setLocalDescription(u),this.dispatchEvent(new Br(this,this.connection.localDescription.toJSON()))}}),this.connection.addEventListener("datachannel",s=>{this.setChannel(s.channel)}),this.connection.addEventListener("track",async s=>{let u=s.transceiver,c=s.track,l=si(s.streams,f=>{let x=f.getTracks();for(let w of x)if(w===c)return!0;return!1});this.transceivers.indexOf(u)===-1&&this.transceivers.push(u);let F=()=>{this.dispatchEvent(new Ir(this,c))},h=()=>{c.removeEventListener("ended",h),c.removeEventListener("mute",F),ee(this.transceivers,u),this.dispatchEvent(new Ar(this,c,l))};c.addEventListener("ended",h),c.addEventListener("mute",F),this.dispatchEvent(new _r(this,c,l)),this.trackSent?this.setChannel(this.connection.createDataChannel("poses",{ordered:!1,maxRetransmits:0})):this.start()});let a=!1;this.connection.addEventListener("connectionstatechange",()=>{this.connection.connectionState==="failed"&&a?this.dispatchEvent(new Ne(this)):this.connection.connectionState==="connected"&&(a=!0)}),Object.seal(this)}dispose(){if(!this.disposed){this.channel&&(this.channel.close(),this.channel=null);for(let e of this.transceivers)e.stop();ue(this.transceivers),this.connection.close(),this.disposed=!0}}setChannel(e){this.channel=e,this.channel.binaryType="arraybuffer",this.channel.addEventListener("message",o=>{if(Ei(o.data)){let r=new Float32Array(o.data),i=r[0],a=r[1];if(i===3){let s=this.invocations.get(a);s&&s()}else this.channel&&this.channel.readyState==="open"&&(i===2?this.recvPose(r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10],r[11]):this.recvPointer(r[11],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10]),a>=0&&(this.sendInvocationCompleteBuffer[1]=a,this.channel.send(this.sendInvocationCompleteBuffer)))}})}recvPose(e,o,r,i,a,s,u,c,l,F){this.userPosedEvt.pose.set(e,o,r,i,a,s,u,c,l),this.userPosedEvt.height=F,this.dispatchEvent(this.userPosedEvt)}sendPose(e,o,r,i,a,s,u,c,l,F){return this.sendMessage(2,e,o,r,i,a,s,u,c,l,F)}recvPointer(e,o,r,i,a,s,u,c,l,F){this.userPointerEvt.name=e,this.userPointerEvt.pose.set(o,r,i,a,s,u,c,l,F),this.dispatchEvent(this.userPointerEvt)}sendPointer(e,o,r,i,a,s,u,c,l,F){return this.sendMessage(1,o,r,i,a,s,u,c,l,F,e)}async sendMessage(e,o,r,i,a,s,u,c,l,F,h){this.channel&&this.channel.readyState==="open"&&this.locks.withSkipLock(e,async()=>{let f=e===2?this.sendPoseBuffer:this.sendPointerBuffer,x=++this.invocationCount;if(f[1]=x,f[2]=o,f[3]=r,f[4]=i,f[5]=a,f[6]=s,f[7]=u,f[8]=c,f[9]=l,f[10]=F,f[11]=h,!this.confirmReceipt)this.channel.send(f);else{let w=new ce,C=setTimeout(w.reject,100,"timeout"),U=()=>{clearTimeout(C),w.resolve()};this.invocations.set(x,U),this.channel.send(f);try{await w}catch(P){P!=="timeout"&&console.error(P)}finally{this.invocations.delete(x)}}})}async addIceCandidate(e){await this.connection.addIceCandidate(e)}async acceptOffer(e){await this.connection.setRemoteDescription(e),this.gotOffer=!0;let o=await this.connection.createAnswer();await this.connection.setLocalDescription(o),this.dispatchEvent(new Rr(this,this.connection.localDescription.toJSON()))}async acceptAnswer(e){await this.connection.setRemoteDescription(e)}start(){this.trackSent||(this.trackSent=!0,this.dispatchEvent(new Pr(this)))}sendStream(e){for(let o of e.getTracks())this.trackSent?this.connection.addTrack(o,e):this.transceivers.push(this.connection.addTransceiver(o,{streams:[e]}))}};var Hr=window.location.hostname==="localhost"||/\bdebug\b/.test(window.location.search),Wr=le("Juniper:Sockets",()=>new Array);function Kn(...n){console.log("New connection",...n);let t=new WebSocket(...n);return Wr.push(t),t}Kn.CLOSED=WebSocket.CLOSED;Kn.CLOSING=WebSocket.CLOSING;Kn.CONNECTING=WebSocket.CONNECTING;Kn.OPEN=WebSocket.OPEN;Object.assign(window,{sockets:{list:()=>Wr,kill:()=>{for(let n of Wr)n.close()}}});var jn=class extends j{constructor(e,o,r=!0,i=!1){super();this.audio=e;this.signalRPath=o;this.autoSetPosition=r;this.needsVideoDevice=i;this._isAudioMuted=null;this._isVideoMuted=null;this._localUserID=zn;this._localUserName=null;this._roomName=null;this._conferenceState="Disconnected";this._hasAudioPermission=!1;this._hasVideoPermission=!1;this.lastRoom=null;this.lastUserID=null;this.users=new Map;this.localStreamIn=null;this._ready=null;this.disposed=!1;Hr&&console.log(ra);let a=new Ft().withAutomaticReconnect();a.withUrl(this.signalRPath,L.WebSockets),this.hub=a.build(),this.audio.devices.addEventListener("audioinputchanged",u=>this.onAudioInputChanged(u)),this.hub.onclose(()=>{this.lastRoom=null,this.lastUserID=null,this.setConferenceState("Disconnected")}),this.hub.onreconnecting(u=>{this.dispatchEvent(new Tn(u))}),this.hub.onreconnected(async()=>{this.lastRoom=null,this.lastUserID=null,this.setConferenceState("Disconnected"),await this.identify(this.localUserName),await this.join(this.roomName)}),this.hub.on("userJoined",this.onUserJoined.bind(this)),this.hub.on("iceReceived",this.onIceReceived.bind(this)),this.hub.on("offerReceived",this.onOfferReceived.bind(this)),this.hub.on("answerReceived",this.onAnswerReceived.bind(this)),this.hub.on("userLeft",u=>{let c=this.users.get(u);c&&this.onUserLeft(c)}),this.hub.on("userPosed",(u,c,l,F,h,f,x,w,C,U,P)=>{let S=this.users.get(u);S&&S.recvPose(c,l,F,h,f,x,w,C,U,P)}),this.hub.on("userPointer",(u,c,l,F,h,f,x,w,C,U,P)=>{let S=this.users.get(u);S&&S.recvPointer(c,l,F,h,f,x,w,C,U,P)}),this.hub.on("chat",(u,c)=>{let l=this.users.get(u);l&&this.dispatchEvent(new Un(l,c))}),this.remoteGainDecay=new Vn(this.audio.audioCtx,this.audio.audioDestination.remoteUserInput,this.audio.localAutoControlledGain,.05,1,.25,0,250,.25,1e3,250),this.remoteGainDecay.setEnabled(!this.audio.useHeadphones),this.audio.addEventListener("useheadphonestoggled",()=>{this.remoteGainDecay.setEnabled(!this.audio.useHeadphones),this.restartStream()});let s=()=>{this.conferenceState==="Connected"&&this.toRoom("leave")};window.addEventListener("beforeunload",s),window.addEventListener("unload",s),window.addEventListener("pagehide",s),this.localStream=this.audio.devices.currentStream,Object.seal(this)}toggleLogging(){Hr=!Hr}get isAudioMuted(){return this._isAudioMuted}get isVideoMuted(){return this._isVideoMuted}get localUserID(){return this._localUserID}get localUserName(){return this._localUserName}get roomName(){return this._roomName}get hasAudioPermission(){return this._hasAudioPermission}get hasVideoPermission(){return this._hasVideoPermission}get ready(){return this._ready===null&&(this._ready=this.startInternal()),this._ready}async startInternal(){await this.audio.ready,await this.audio.devices.startPreferredAudioInput(),this.localStream=this.audio.devices.currentStream}get connectionState(){switch(this.hub.state){case E.Connected:return"Connected";case E.Connecting:case E.Reconnecting:return"Connecting";case E.Disconnected:return"Disconnected";case E.Disconnecting:return"Disconnecting";default:_e(this.hub.state)}}get echoControl(){return this.remoteGainDecay}get isConnected(){return this.connectionState==="Connected"}get conferenceState(){return this._conferenceState}get isConferenced(){return this.conferenceState==="Connected"}setConferenceState(e){this._conferenceState=e}dispose(){this.disposed||(this.leave(),this.disconnect(),this.disposed=!0)}err(e,...o){console.warn(e,...o)}async toServer(e,...o){return await this.hub.invoke(e,...o)}async toRoom(e,...o){this.isConnected&&await this.hub.invoke(e,this.localUserID,this.roomName,...o)}async toUser(e,o,...r){this.isConnected&&await this.hub.invoke(e,this.localUserID,o,...r)}async connect(){await this.ready,await Cr("Connecting",()=>this.connectionState,async()=>{await this.hub.start(),this.dispatchEvent(new kn)})}async join(e){this.lastRoom!==null&&e!==this.lastRoom&&await this.leave(),await Cr(`Joining room ${e}`,()=>this.conferenceState,async()=>{this.setConferenceState("Connecting"),this._roomName=e,await this.toServer("join",this.roomName),this.lastRoom=this.roomName,this.setConferenceState("Connected");let o=this.audio.setLocalUserID(this.localUserID);this.dispatchEvent(new bn(this.localUserID,o.pose)),await this.toRoom("greetEveryone",this.localUserName)})}async identify(e){this.localUserID===zn&&(this._localUserID=null),this._localUserID=this.localUserID||await this.toServer("getNewUserID"),this._localUserName=e,this.localUserID&&this.localUserID!==this.lastUserID&&this.isConnected&&(this.lastUserID=this.localUserID,await this.toServer("identify",this.localUserID))}async leave(){await Dr(`Leaving room ${this.lastRoom}`,()=>this.conferenceState,async()=>{this.setConferenceState("Disconnecting"),await this.toRoom("leave")});for(let e of this.users.values())this.onUserLeft(e);this._roomName=this.lastRoom=null,this.setConferenceState("Disconnected"),this.dispatchEvent(new Cn(this.localUserID))}async disconnect(){this.conferenceState!=="Disconnected"&&await this.leave(),await Dr("Disconnecting",()=>this.connectionState,async()=>{await this.hub.stop(),this._localUserID=this.lastUserID=zn,this.audio.setLocalUserID(this.localUserID),this.dispatchEvent(new En)})}async onUserJoined(e,o){if(this.users.has(e))this.users.get(e).start();else{this.users.size===0&&this.remoteGainDecay.start();let r=await this.getRTCConfiguration(),i=new Gn(e,o,r,!0);this.users.set(i.userID,i),i.addEventListener("iceError",this.onIceError.bind(this)),i.addEventListener("iceCandidate",this.onIceCandidate.bind(this)),i.addEventListener("offer",this.onOfferCreated.bind(this)),i.addEventListener("answer",this.onAnswerCreated.bind(this)),i.addEventListener("streamNeeded",this.onStreamNeeded.bind(this)),i.addEventListener("trackAdded",this.onTrackAdded.bind(this)),i.addEventListener("trackMuted",this.onTrackMuted.bind(this)),i.addEventListener("trackRemoved",this.onTrackRemoved.bind(this)),i.addEventListener("userLeft",s=>this.onUserLeft(s.user)),i.addEventListener("userPosed",s=>{this.onRemoteUserPosed(s);let{p:u,f:c,u:l}=s.pose;this.audio.setUserPose(s.user.userID,u[0],u[1],u[2],c[0],c[1],c[2],l[0],l[1],l[2])}),i.addEventListener("userPointer",s=>this.onRemoteUserPosed(s)),this.toUser("greet",i.userID,this.localUserName);let a=this.audio.createUser(i.userID,i.userName);this.dispatchEvent(new Dn(i,a))}}async getRTCConfiguration(){return await this.toServer("getRTCConfiguration",this.localUserID)}onIceError(e){this.err("icecandidateerror",this.localUserName,e.user.userName,`${e.url} [${e.errorCode}]: ${e.errorText}`)}async onIceCandidate(e){await this.sendIce(e.user.userID,e.candidate)}async onIceReceived(e,o){try{let r=this.users.get(e);if(r){let i=JSON.parse(o);await r.addIceCandidate(i)}}catch(r){this.err("iceReceived",`${r.message} [${e}] (${o})`)}}async onOfferCreated(e){await this.sendOffer(e.user.userID,e.offer)}async onOfferReceived(e,o){try{let r=this.users.get(e);if(r){let i=JSON.parse(o);await r.acceptOffer(i)}}catch(r){this.err("offerReceived",r.message)}}async onAnswerCreated(e){await this.sendAnswer(e.user.userID,e.answer)}async onAnswerReceived(e,o){try{let r=this.users.get(e);if(r){let i=JSON.parse(o);await r.acceptAnswer(i)}}catch(r){this.err("answerReceived",r.message)}}onStreamNeeded(e){e.user.sendStream(this.audio.output.stream)}onTrackAdded(e){e.track.kind==="audio"?(this.audio.setUserStream(e.user.userID,e.user.userName,e.stream),this.dispatchEvent(new _n(e.user,e.stream))):e.track.kind==="video"&&this.dispatchEvent(new An(e.user,e.stream))}onTrackMuted(e){e.track.kind==="audio"?this.dispatchEvent(new vn(e.user,e.track.muted)):e.track.kind==="video"&&this.dispatchEvent(new Ln(e.user,e.track.muted))}onTrackRemoved(e){e.track.kind==="audio"?(this.audio.setUserStream(e.user.userID,e.user.userName,null),this.dispatchEvent(new In(e.user,e.stream))):e.track.kind==="video"&&this.dispatchEvent(new Hn(e.user,e.stream))}onUserLeft(e){e.dispose(),this.users.delete(e.userID),this.users.size===0&&this.remoteGainDecay.stop(),this.audio.removeUser(e.userID),this.dispatchEvent(new Ne(e))}async sendIce(e,o){await this.toUser("sendIce",e,JSON.stringify(o))}async sendOffer(e,o){await this.toUser("sendOffer",e,JSON.stringify(o))}async sendAnswer(e,o){await this.toUser("sendAnswer",e,JSON.stringify(o))}async setLocalPose(e,o,r,i,a,s,u,c,l,F){this.autoSetPosition&&this.audio.setUserPose(this.localUserID,e,o,r,i,a,s,u,c,l),this.conferenceState==="Connected"&&await Promise.all(Array.from(this.users.values()).map(h=>h.sendPose(e,o,r,i,a,s,u,c,l,F)))}async setLocalPointer(e,o,r,i,a,s,u,c,l,F){this.conferenceState==="Connected"&&await Promise.all(Array.from(this.users.values()).map(h=>h.sendPointer(e,o,r,i,a,s,u,c,l,F)))}onRemoteUserPosed(e){let o=this.audio.getUserOffset(e.user.userID);o&&e.pose.setOffset(o[0],o[1],o[2])}chat(e){this.conferenceState==="Connected"&&this.toRoom("chat",e)}userExists(e){return this.users.has(e)}getUserNames(){return Array.from(this.users.values()).map(e=>[e.userID,e.userName])}async onAudioInputChanged(e){let o=e.audio&&e.audio.deviceId;await this.startStream(o,this.audio.useHeadphones)}async startStream(e,o){e?this.localStream=await navigator.mediaDevices.getUserMedia({audio:{deviceId:e,echoCancellation:!o,autoGainControl:!0,noiseSuppression:!0}}):this.localStream=null}async restartStream(){this.localStream=null,await this.startStream(this.audio.devices.preferredAudioOutputID,this.audio.useHeadphones)}get localStream(){return this.localStreamIn&&this.localStreamIn.mediaStream||null}set localStream(e){e!==this.localStream&&(this.localStreamIn&&(Gt(this.localStreamIn),this.localStreamIn=null),this.audio.devices.currentStream=e,e&&(this.localStreamIn=Ui("local-mic",this.audio.audioCtx,e,this.audio)))}isMediaMuted(e){for(let o of this.audio.output.stream.getTracks())if(o.kind===e)return!o.enabled;return!0}setMediaMuted(e,o){for(let r of this.audio.output.stream.getTracks())r.kind===e&&(r.enabled=!o)}get audioMuted(){return this.isMediaMuted("audio")}set audioMuted(e){this.setMediaMuted("audio",e)}get videoMuted(){return this.isMediaMuted("video")}set videoMuted(e){this.setMediaMuted("video",e)}};function sa(){return"ui-monospace, 'Droid Sans Mono', 'Cascadia Mono', 'Segoe UI Mono', 'Ubuntu Mono', 'Roboto Mono', Menlo, Monaco, Consolas, monospace"}var ze=class{constructor(t,e,o=null){this.value=t;this.desc=e;p(this,"props");this.value=t,this.desc=e,this.props=o||{}}contains(t){return t instanceof ze?this.contains(t.value):this.value.indexOf(t)>=0}};var ua=new ze("\u2B50","Star");var wt=new THREE.Vector3;function $n(n){return wt.copy(n),wt.y=0,wt.normalize(),wi(Math.atan2(wt.x,wt.z))}var Ve=new THREE.Vector3,ca=0,Ju=new THREE.Vector3,qn=new THREE.Vector3,la=new THREE.Vector3,Jn=new THREE.Quaternion,pa=0,Yu=0;function Qu(n,t){let e=n-t,o=e+2*Math.PI,r=e-2*Math.PI,i=Math.abs(e),a=Math.abs(o),s=Math.abs(r);return i<a&&i<s?e:a<s?o:r}var Yn=class extends THREE.Object3D{constructor(e,o,r,i,a=1){super();this.minDistance=o;this.heightOffset=i;this.speed=a;p(this,"lerp");p(this,"maxDistance");p(this,"minAngle");p(this,"maxAngle");this.name=e,this.lerp=this.minAngle>0||this.minDistance>0,this.maxDistance=this.minDistance*5,this.minAngle=Ao(r),this.maxAngle=Math.PI-this.minAngle,Object.seal(this)}copy(e,o=!0){return super.copy(e,o),this.name=e.name+ ++Yu,this.lerp=e.lerp,this.maxDistance=e.maxDistance,this.minAngle=e.minAngle,this.maxAngle=e.maxAngle,this}update(e,o,r,i){i*=.001,this.clampTo(this.lerp,e,o,this.minDistance,this.maxDistance,r,this.minAngle,this.maxAngle,i)}reset(e,o,r){this.clampTo(!1,e,o,0,0,r,0,0,0)}clampTo(e,o,r,i,a,s,u,c,l){Ve.copy(r),Ve.y-=this.heightOffset*o,ca=s,this.getWorldPosition(qn),this.getWorldDirection(la),pa=$n(la),Jn.identity();let F=!e,h=!e;if(e){let f=Ju.copy(Ve).sub(qn).length();i<f&&(f<a&&Ve.lerpVectors(qn,Ve,this.speed*l),F=!0);let x=Qu(ca,pa),w=Math.abs(x);u<w&&(w<c?Jn.setFromAxisAngle(this.up,x*this.speed*l):Jn.setFromAxisAngle(this.up,x),h=!0)}(F||h)&&(F&&this.position.add(Ve.sub(qn)),h&&this.quaternion.multiply(Jn))}};THREE.UniformsLib.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new THREE.Vector2(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}};THREE.ShaderLib.line={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>
		#include <clipping_planes_pars_vertex>

		uniform float linewidth;
		uniform vec2 resolution;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
				vUv = uv;

			#endif

			float aspect = resolution.x / resolution.y;

			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			#ifdef WORLD_UNITS

				worldStart = start.xyz;
				worldEnd = end.xyz;

			#else

				vUv = uv;

			#endif

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec3 ndcStart = clipStart.xyz / clipStart.w;
			vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

			// direction
			vec2 dir = ndcEnd.xy - ndcStart.xy;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			dir = normalize( dir );

			#ifdef WORLD_UNITS

				// get the offset direction as perpendicular to the view vector
				vec3 worldDir = normalize( end.xyz - start.xyz );
				vec3 offset;
				if ( position.y < 0.5 ) {

					offset = normalize( cross( start.xyz, worldDir ) );

				} else {

					offset = normalize( cross( end.xyz, worldDir ) );

				}

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

				// don't extend the line if we're rendering dashes because we
				// won't be rendering the endcaps
				#ifndef USE_DASH

					// extend the line bounds to encompass  endcaps
					start.xyz += - worldDir * linewidth * 0.5;
					end.xyz += worldDir * linewidth * 0.5;

					// shift the position of the quad so it hugs the forward edge of the line
					offset.xy -= dir * forwardOffset;
					offset.z += 0.5;

				#endif

				// endcaps
				if ( position.y > 1.0 || position.y < 0.0 ) {

					offset.xy += dir * 2.0 * forwardOffset;

				}

				// adjust for linewidth
				offset *= linewidth * 0.5;

				// set the world position
				worldPos = ( position.y < 0.5 ) ? start : end;
				worldPos.xyz += offset;

				// project the worldpos
				vec4 clip = projectionMatrix * worldPos;

				// shift the depth of the projected points so the line
				// segements overlap neatly
				vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
				clip.z = clipPose.z * clip.w;

			#else

				vec2 offset = vec2( dir.y, - dir.x );
				// undo aspect ratio adjustment
				dir.x /= aspect;
				offset.x /= aspect;

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				// endcaps
				if ( position.y < 0.0 ) {

					offset += - dir;

				} else if ( position.y > 1.0 ) {

					offset += dir;

				}

				// adjust for linewidth
				offset *= linewidth;

				// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
				offset /= resolution.y;

				// select end
				vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

				// back to clip space
				offset *= clip.w;

				clip.xy += offset;

			#endif

			gl_Position = clip;

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

			#include <logdepthbuf_vertex>
			#include <clipping_planes_vertex>
			#include <fog_vertex>

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform float linewidth;

		#ifdef USE_DASH

			uniform float dashOffset;
			uniform float dashSize;
			uniform float gapSize;

		#endif

		varying float vLineDistance;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#include <common>
		#include <color_pars_fragment>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>
		#include <clipping_planes_pars_fragment>

		vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

			float mua;
			float mub;

			vec3 p13 = p1 - p3;
			vec3 p43 = p4 - p3;

			vec3 p21 = p2 - p1;

			float d1343 = dot( p13, p43 );
			float d4321 = dot( p43, p21 );
			float d1321 = dot( p13, p21 );
			float d4343 = dot( p43, p43 );
			float d2121 = dot( p21, p21 );

			float denom = d2121 * d4343 - d4321 * d4321;

			float numer = d1343 * d4321 - d1321 * d4343;

			mua = numer / denom;
			mua = clamp( mua, 0.0, 1.0 );
			mub = ( d1343 + d4321 * ( mua ) ) / d4343;
			mub = clamp( mub, 0.0, 1.0 );

			return vec2( mua, mub );

		}

		void main() {

			#include <clipping_planes_fragment>

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			float alpha = opacity;

			#ifdef WORLD_UNITS

				// Find the closest points on the view ray and the line segment
				vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
				vec3 lineDir = worldEnd - worldStart;
				vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

				vec3 p1 = worldStart + lineDir * params.x;
				vec3 p2 = rayEnd * params.y;
				vec3 delta = p1 - p2;
				float len = length( delta );
				float norm = len / linewidth;

				#ifndef USE_DASH

					#ifdef USE_ALPHA_TO_COVERAGE

						float dnorm = fwidth( norm );
						alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

					#else

						if ( norm > 0.5 ) {

							discard;

						}

					#endif

				#endif

			#else

				#ifdef USE_ALPHA_TO_COVERAGE

					// artifacts appear on some hardware if a derivative is taken within a conditional
					float a = vUv.x;
					float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
					float len2 = a * a + b * b;
					float dlen = fwidth( len2 );

					if ( abs( vUv.y ) > 1.0 ) {

						alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

					}

				#else

					if ( abs( vUv.y ) > 1.0 ) {

						float a = vUv.x;
						float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
						float len2 = a * a + b * b;

						if ( len2 > 1.0 ) discard;

					}

				#endif

			#endif

			vec4 diffuseColor = vec4( diffuse, alpha );

			#include <logdepthbuf_fragment>
			#include <color_fragment>

			gl_FragColor = vec4( diffuseColor.rgb, alpha );

			#include <tonemapping_fragment>
			#include <encodings_fragment>
			#include <fog_fragment>
			#include <premultiplied_alpha_fragment>

		}
		`};var Fe=class extends THREE.ShaderMaterial{constructor(t){super({type:"LineMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.line.uniforms),vertexShader:THREE.ShaderLib.line.vertexShader,fragmentShader:THREE.ShaderLib.line.fragmentShader,clipping:!0}),Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(e){e===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},dashed:{enumerable:!0,get:function(){return Boolean("USE_DASH"in this.defines)},set(e){Boolean(e)!==Boolean("USE_DASH"in this.defines)&&(this.needsUpdate=!0),e===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},alphaToCoverage:{enumerable:!0,get:function(){return Boolean("USE_ALPHA_TO_COVERAGE"in this.defines)},set:function(e){Boolean(e)!==Boolean("USE_ALPHA_TO_COVERAGE"in this.defines)&&(this.needsUpdate=!0),e===!0?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(t)}};Fe.prototype.isLineMaterial=!0;var Or=new Map;function Xu(n,t){t in n&&delete n[t]}function Ge(n,t,e){let o=`${n}_${Object.keys(e).map(r=>`${r}:${e[r]}`).join(",")}`;return Or.has(o)||(Xu(e,"name"),Or.set(o,new t(e))),Or.get(o)}function Zu(n){return Object.assign(n,{transparent:!0})}function X(n){return Ge("solid",THREE.MeshBasicMaterial,n)}function Fa(n){return Ge("solidTransparent",THREE.MeshBasicMaterial,Zu(n))}function J(n){return Ge("lit",THREE.MeshStandardMaterial,n)}function me(n){return Ge("line",THREE.LineBasicMaterial,n)}function ma(n){return Ge("line2",Fe,n)}function de(n){return Ge("sprite",THREE.SpriteMaterial,n)}var Qn=0,Xn=255,je=65280,Zn=65535,eo=16711680,to=16711935,Ke=16776960,no=12632256,oo=16777215,rx=X({color:Qn}),da=X({color:Xn}),ha=X({color:je}),ix=X({color:Zn}),ga=X({color:eo}),ax=X({color:to}),sx=X({color:Ke}),ux=X({color:no}),cx=X({color:oo});var lx=J({color:Qn}),px=J({color:Xn}),Fx=J({color:je}),mx=J({color:Zn}),dx=J({color:eo}),hx=J({color:to}),gx=J({color:Ke}),Nr=J({color:no}),fx=J({color:oo});var xx=me({color:Qn}),Sx=me({color:Xn}),wx=me({color:je}),Tx=me({color:Zn}),kx=me({color:eo}),Ex=me({color:to}),Mx=me({color:Ke}),bx=me({color:no}),Cx=me({color:oo});var Dx=de({color:Qn}),yx=de({color:Xn}),vx=de({color:je}),Lx=de({color:Zn}),Bx=de({color:eo}),Rx=de({color:to}),Px=de({color:Ke}),_x=de({color:no}),Ix=de({color:oo});function fa(n){let t=n.attributes.position,e=n.attributes.normal,o=n.attributes.uv;for(let r=0;r<e.count;++r){let i=r*e.itemSize,a=r*e.itemSize+1,s=r*e.itemSize+2,u=e.array[i],c=e.array[a],l=e.array[s],F=Math.abs(u),h=Math.abs(c),f=Math.abs(l),x=t.array[i],w=t.array[a],C=t.array[s],U=Math.abs(x),P=Math.abs(w),S=Math.abs(C),z=r*o.itemSize,Re=r*o.itemSize+1,R=o.array[z],v=o.array[Re],Z=0,Q=F,D=U;h>Q&&(Z=1,Q=h,D=P),f>Q&&(Z=2,Q=f,D=S),Z===0?x<0?(R=-C,v=w):(R=C,v=w):Z===1?w<0?(R=x,v=-C):(R=x,v=C):C<0?(R=x,v=w):(R=-x,v=w),R=(R/D+1)/8,v=(v/D+1)/6,Z===0?x<0?(R+=0,v+=1/3):(R+=.5,v+=1/3):Z===1?w<0?(R+=.25,v+=0):(R+=.25,v+=2/3):C<0?(R+=.25,v+=1/3):(R+=.75,v+=1/3);let V=o.array;V[z]=R,V[Re]=v}}var zr=new THREE.BoxBufferGeometry(1,1,1,1,1,1);zr.name="CubeGeom";var xa=zr.clone();xa.name="InvertedCubeGeom";fa(xa);var Ur=class extends THREE.Mesh{constructor(e,o,r,i,a){super(zr,i);this.isCollider=a;this.scale.set(e,o,r)}},G=class extends Ur{constructor(e,o,r,i){super(e,o,r,i,!1);p(this,"isDraggable",!1)}};var $e=class{constructor(t,e,o,...r){this.key=t;this.value=e;this.bySetAttribute=o;p(this,"tags");this.tags=r.map(i=>i.toLocaleUpperCase()),Object.freeze(this)}applyToElement(t){let e=this.key.startsWith("data-");if(!(this.tags.length===0||this.tags.indexOf(t.tagName)>-1||e))console.warn(`Element ${t.tagName} does not support Attribute ${this.key}`);else if(e){let r=this.key.substring(5);t.dataset[r]=this.value}else this.key==="style"?Object.assign(t.style,this.value):this.key==="classList"?this.value.forEach(r=>t.classList.add(r)):this.bySetAttribute?t.setAttribute(this.key,this.value):this.key in t?t[this.key]=this.value:this.value===!1?t.removeAttribute(this.key):this.value===!0?t.setAttribute(this.key,""):t.setAttribute(this.key,this.value)}};function Sa(n){return new $e("height",n,!1,"canvas","embed","iframe","img","input","object","video")}function wa(n){return new $e("width",n,!1,"canvas","embed","iframe","img","input","object","video")}function Ta(n){return ge(n)?n.element instanceof Node:!1}function tc(n){return ge(n)&&"elements"in n&&n.elements instanceof Array}function Vr(n){return Ta(n)?n.element:n}function nc(n){return ge(n)&&"applyToElement"in n&&W(n.applyToElement)}function oc(n,...t){n=Vr(n);for(let e of t)d(e)&&(e instanceof Node?n.append(e):Ta(e)?n.append(Vr(e)):tc(e)?n.append(...e.elements.map(Vr)):nc(e)?e.applyToElement(n):n.append(document.createTextNode(e.toLocaleString())));return n}function rc(n,...t){let e=null;for(let o of t)if(o instanceof $e&&o.key==="id"){e=document.getElementById(o.value);break}return e==null&&(e=document.createElement(n)),oc(e,...t),e}function ka(...n){return rc("canvas",...n)}function Ea(n){return d(n)&&n.isMesh}function ic(n){return d(n)&&n.isMaterial}function Ma(n){return ic(n)&&n.type==="MeshBasicMaterial"}function Tt(n){return d(n)&&n.isObject3D}function ac(n){return d(n)&&Tt(n.object)}function kt(n){return ac(n)?n.object:n}function ro(n,t){return n=kt(n),n.visible=t,t}function ba(n){return n=kt(n),n.visible}function Ca(n){for(n=kt(n);n;){if(!n.visible)return!1;n=n.parent}return!0}function qe(n,...t){let e=t.filter(d).map(kt);return e.length>0&&kt(n).add(...e),n}function Da(n,...t){let e=new THREE.Object3D;return e.name=n,qe(e,...t),e}var Je=new THREE.Vector3;function io(n,t,e,o){Je.crossVectors(t,n),n.crossVectors(Je,t),Je.normalize(),n.normalize(),t.normalize(),o.set(Je.x,n.x,-t.x,e.x,Je.y,n.y,-t.y,e.y,Je.z,n.z,-t.z,e.z,0,0,0,1)}var Et=class{constructor(){this.buttons=0;this.moveDistance=0;this.dragDistance=0;this.x=0;this.y=0;this.dx=0;this.dy=0;this.dz=0;this.u=0;this.v=0;this.du=0;this.dv=0;this.canClick=!1;this.dragging=!1;this.ctrl=!1;this.alt=!1;this.shift=!1;this.meta=!1;Object.seal(this)}copy(t){this.buttons=t.buttons,this.moveDistance=t.moveDistance,this.dragDistance=t.dragDistance,this.x=t.x,this.y=t.y,this.dx=t.dx,this.dy=t.dy,this.dz=t.dz,this.u=t.u,this.v=t.v,this.du=t.du,this.dv=t.dv,this.canClick=t.canClick,this.dragging=t.dragging,this.ctrl=t.ctrl,this.alt=t.alt,this.shift=t.shift,this.meta=t.meta}read(t){this.buttons=t.buttons,this.x=t.offsetX,this.y=t.offsetY,this.dx=t.movementX,this.dy=t.movementY,this.dz=0,this.ctrl=t.ctrlKey,this.alt=t.altKey,this.shift=t.shiftKey,this.meta=t.metaKey}};function ao(n){return Tt(n)&&O(n.isCollider)&&d(n.parent)}function Gr(n){return d(n)&&ao(n.object)}function jr(n){return Tt(n)&&(O(n.disabled)||O(n.isDraggable)||O(n.isClickable))}function ya(n){return jr(n)&&n.isClickable&&!n.disabled}function so(n){return Gr(n)&&ao(n.object)&&(ya(n.object)||ya(n.object.parent))}function va(n){return jr(n)&&n.isDraggable&&!n.disabled}function Mt(n){return Gr(n)&&ao(n.object)&&(va(n.object)||va(n.object.parent))}function La(n){return jr(n)&&n.disabled}function Ba(n){return Gr(n)&&ao(n.object)&&(La(n.object)||La(n.object.parent))}var Kr=new THREE.Vector3,bt=new THREE.Vector3,Ra=new THREE.Quaternion,ke=class{constructor(){p(this,"_object",null);p(this,"_visible",!0);p(this,"_style","default")}get object(){return this._object}set object(t){this._object=t}get style(){return this._style}set style(t){this._style=t}get visible(){return this._visible}set visible(t){this._visible=t}update(t,e,o,r,i,a,s){e&&e.face?(this.position.copy(e.point),e.object.getWorldQuaternion(Ra),Kr.copy(e.face.normal).applyQuaternion(Ra),bt.copy(Kr).multiplyScalar(.02),this.position.add(bt),bt.copy(Kr).multiplyScalar(10).add(this.position)):(this.position.copy(s).multiplyScalar(o).add(a),bt.copy(t)),this.object.parent.worldToLocal(this.position),this.lookAt(bt),this.style=e?Ba(e)?"not-allowed":Mt(e)?i.dragging?"grabbing":"move":so(e)?"pointer":"default":r?i.buttons===1?"grabbing":"grab":"default"}lookAt(t){}};var Ye=class extends ke{constructor(){super();p(this,"_currentStyle");p(this,"material");this.material=X({name:"CursorMat",color:16776960}),this.object=new G(.01,.01,.01,this.material)}get position(){return this.object.position}get style(){return this._currentStyle}set style(e){if(this._currentStyle=e,Ea(this.object)&&!Me(this.object.material))switch(this._currentStyle){case"pointer":this.material.color=new THREE.Color(65280),this.material.needsUpdate=!0;break;case"not-allowed":this.material.color=new THREE.Color(16711680),this.material.needsUpdate=!0;break;case"move":this.material.color=new THREE.Color(255),this.material.needsUpdate=!0;break;case"grab":this.material.color=new THREE.Color(16711935),this.material.needsUpdate=!0;break;case"grabbing":this.material.color=new THREE.Color(65535),this.material.needsUpdate=!0;break;default:this._currentStyle="default",this.material.color=new THREE.Color(16776960),this.material.needsUpdate=!0;break}}get visible(){return ba(this)}set visible(e){ro(this,e)}};var uo=class extends ke{constructor(e){super();this.element=e;p(this,"_hidden",!1);this.visible=!0,this.style="default",document.addEventListener("pointerlockchange",()=>{this._hidden=!!document.pointerLockElement,this.refresh()})}get position(){throw new Error("BaseCursor::get_Position(): Method not implemented.")}get style(){return super.style}set style(e){super.style=e,this.refresh()}get visible(){return super.visible&&!this._hidden}set visible(e){super.visible=e,this.refresh()}refresh(){this.element.style.cursor=this.visible?this.style:"none"}};var co=class extends ke{constructor(e){super();this.renderer=e;p(this,"system");p(this,"xr",new Ye);this.system=new uo(this.renderer.domElement),this.visible=!1}get object(){return this.xr.object}get cursor(){return this.xr}set cursor(e){this.xr=e,this._refresh()}get position(){return this.object.position}get style(){return this.system.style}get visible(){return this.renderer.xr.isPresenting&&this.xr.visible||!this.renderer.xr.isPresenting&&this.system.visible}set visible(e){super.visible=e,this._refresh()}set style(e){this.system.style=e,this.xr.style=e,this._refresh()}_refresh(){ro(this.xr,this.visible&&(this.renderer.xr.isPresenting||document.pointerLockElement!=null))}lookAt(e){this.xr.lookAt(e)}};var uc=5,lo=class{constructor(t,e,o,r){this.type=t;this.name=e;this.evtSys=o;p(this,"_cursor");p(this,"_canMoveView",!1);p(this,"_enabled",!1);p(this,"isActive",!1);p(this,"movementDragThreshold",uc);p(this,"state",new Et);p(this,"lastState",null);p(this,"origin",new THREE.Vector3);p(this,"direction",new THREE.Vector3);p(this,"curHit",null);p(this,"hoveredHit",null);p(this,"_pressedHit",null);p(this,"draggedHit",null);this._cursor=r,this.enabled=!1,this.canMoveView=!1}get pressedHit(){return this._pressedHit}set pressedHit(t){this._pressedHit=t,Mt(t)&&!so(t)&&this.onDragStart()}get canMoveView(){return this._canMoveView}set canMoveView(t){this._canMoveView=t}vibrate(){}get cursor(){return this._cursor}set cursor(t){if(t!==this.cursor){let e=this.cursor,o=this.cursor&&this.cursor.object&&this.cursor.object.name||"cursor",r=e&&e.object&&e.object.parent;r&&(qe,r.remove(e.object)),t&&(t.object.name=o,e instanceof co?(e.cursor=t,r&&r.add(e.object)):(this._cursor=t,e&&(r&&r.add(t.object),t.style=e.style,t.visible=e.visible)))}}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this.cursor&&(this.cursor.visible=t)}get needsUpdate(){return this.enabled&&this.isActive}recheck(){}setEventState(t){this.evtSys.checkPointer(this,t)}updateCursor(t,e,o){this.cursor&&this.cursor.update(t,e,o,this.canMoveView,this.state,this.origin,this.direction)}lastStateUpdate(t){this.lastState?(this.lastState.copy(this.state),t(),this.state.dragDistance=this.lastState.dragDistance):(t(),this.lastState=new Et,this.lastState.copy(this.state))}onZoom(t){this.lastStateUpdate(()=>this.state.dz=t),this.setEventState("move")}onPointerDown(){this.state.dragging=!1,this.state.canClick=!0,this.setEventState("down")}onPointerMove(){this.setEventState("move"),this.state.buttons!==0&&(T(this.pressedHit)||Mt(this.pressedHit))&&(this.lastState.buttons===this.state.buttons?(this.state.dragDistance+=this.state.moveDistance,this.state.dragDistance>this.movementDragThreshold&&this.onDragStart()):this.state.dragging&&(this.state.dragging=!1,this.setEventState("dragcancel")))}onDragStart(){let t=this.state.dragging;this.state.dragging=!0,t||this.setEventState("dragstart"),this.state.canClick=!1,this.setEventState("drag")}onPointerUp(){if(this.state.canClick){let e=this.state.buttons;this.state.buttons=this.lastState.buttons,this.setEventState("click"),this.state.buttons=e}this.setEventState("up"),this.state.dragDistance=0;let t=this.state.dragging;this.state.dragging=!1,t&&this.setEventState("dragend")}};var Pa=new THREE.Box3,po=new THREE.Vector3,ve=class extends THREE.InstancedBufferGeometry{constructor(){super(),this.type="LineSegmentsGeometry";let t=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],e=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],o=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(o),this.setAttribute("position",new THREE.Float32BufferAttribute(t,3)),this.setAttribute("uv",new THREE.Float32BufferAttribute(e,2))}applyMatrix4(t){let e=this.attributes.instanceStart,o=this.attributes.instanceEnd;return e!==void 0&&(e.applyMatrix4(t),o.applyMatrix4(t),e.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(t){let e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));let o=new THREE.InstancedInterleavedBuffer(e,6,1);return this.setAttribute("instanceStart",new THREE.InterleavedBufferAttribute(o,3,0)),this.setAttribute("instanceEnd",new THREE.InterleavedBufferAttribute(o,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){let e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));let o=new THREE.InstancedInterleavedBuffer(e,6,1);return this.setAttribute("instanceColorStart",new THREE.InterleavedBufferAttribute(o,3,0)),this.setAttribute("instanceColorEnd",new THREE.InterleavedBufferAttribute(o,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new THREE.WireframeGeometry(t.geometry)),this}fromLineSegments(t){let e=t.geometry;if(e.isGeometry){console.error("THREE.LineSegmentsGeometry no longer supports Geometry. Use THREE.BufferGeometry instead.");return}else e.isBufferGeometry&&this.setPositions(e.attributes.position.array);return this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new THREE.Box3);let t=this.attributes.instanceStart,e=this.attributes.instanceEnd;t!==void 0&&e!==void 0&&(this.boundingBox.setFromBufferAttribute(t),Pa.setFromBufferAttribute(e),this.boundingBox.union(Pa))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new THREE.Sphere),this.boundingBox===null&&this.computeBoundingBox();let t=this.attributes.instanceStart,e=this.attributes.instanceEnd;if(t!==void 0&&e!==void 0){let o=this.boundingSphere.center;this.boundingBox.getCenter(o);let r=0;for(let i=0,a=t.count;i<a;i++)po.fromBufferAttribute(t,i),r=Math.max(r,o.distanceToSquared(po)),po.fromBufferAttribute(e,i),r=Math.max(r,o.distanceToSquared(po));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(t){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(t)}};ve.prototype.isLineSegmentsGeometry=!0;var _a=new THREE.Vector3,Ia=new THREE.Vector3,A=new THREE.Vector4,H=new THREE.Vector4,ie=new THREE.Vector4,$r=new THREE.Vector3,qr=new THREE.Matrix4,Y=new THREE.Line3,Aa=new THREE.Vector3,he=new THREE.Box3,Fo=new THREE.Sphere,ae=new THREE.Vector4;function Ha(n,t,e,o){return ae.set(0,0,-t,1).applyMatrix4(n.projectionMatrix),ae.multiplyScalar(1/ae.w),ae.x=e/o.width,ae.y=e/o.height,ae.applyMatrix4(n.projectionMatrixInverse),ae.multiplyScalar(1/ae.w),Math.abs(Math.max(ae.x,ae.y))}var Ct=class extends THREE.Mesh{constructor(t=new ve,e=new Fe({color:Math.random()*16777215})){super(t,e),this.type="LineSegments2"}computeLineDistances(){let t=this.geometry,e=t.attributes.instanceStart,o=t.attributes.instanceEnd,r=new Float32Array(2*e.count);for(let a=0,s=0,u=e.count;a<u;a++,s+=2)_a.fromBufferAttribute(e,a),Ia.fromBufferAttribute(o,a),r[s]=s===0?0:r[s-1],r[s+1]=r[s]+_a.distanceTo(Ia);let i=new THREE.InstancedInterleavedBuffer(r,2,1);return t.setAttribute("instanceDistanceStart",new THREE.InterleavedBufferAttribute(i,1,0)),t.setAttribute("instanceDistanceEnd",new THREE.InterleavedBufferAttribute(i,1,1)),this}raycast(t,e){t.camera===null&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2.');let o=t.params.Line2!==void 0&&t.params.Line2.threshold||0,r=t.ray,i=t.camera,a=i.projectionMatrix,s=this.matrixWorld,u=this.geometry,c=this.material,l=c.resolution,F=c.linewidth+o,h=u.attributes.instanceStart,f=u.attributes.instanceEnd,x=-i.near;u.boundingSphere===null&&u.computeBoundingSphere(),Fo.copy(u.boundingSphere).applyMatrix4(s);let w=Math.max(i.near,Fo.distanceToPoint(r.origin)),C=Ha(i,w,F,l);if(Fo.radius+=C,t.ray.intersectsSphere(Fo)===!1)return;u.boundingBox===null&&u.computeBoundingBox(),he.copy(u.boundingBox).applyMatrix4(s);let U=Math.max(i.near,he.distanceToPoint(r.origin)),P=Ha(i,U,F,l);if(he.max.x+=P,he.max.y+=P,he.max.z+=P,he.min.x-=P,he.min.y-=P,he.min.z-=P,t.ray.intersectsBox(he)!==!1){r.at(1,ie),ie.w=1,ie.applyMatrix4(i.matrixWorldInverse),ie.applyMatrix4(a),ie.multiplyScalar(1/ie.w),ie.x*=l.x/2,ie.y*=l.y/2,ie.z=0,$r.copy(ie),qr.multiplyMatrices(i.matrixWorldInverse,s);for(let z=0,Re=h.count;z<Re;z++){A.fromBufferAttribute(h,z),H.fromBufferAttribute(f,z),A.w=1,H.w=1,A.applyMatrix4(qr),H.applyMatrix4(qr);var S=A.z>x&&H.z>x;if(S)continue;if(A.z>x){let D=A.z-H.z,V=(A.z-x)/D;A.lerp(H,V)}else if(H.z>x){let D=H.z-A.z,V=(H.z-x)/D;H.lerp(A,V)}A.applyMatrix4(a),H.applyMatrix4(a),A.multiplyScalar(1/A.w),H.multiplyScalar(1/H.w),A.x*=l.x/2,A.y*=l.y/2,H.x*=l.x/2,H.y*=l.y/2,Y.start.copy(A),Y.start.z=0,Y.end.copy(H),Y.end.z=0;let R=Y.closestPointToPointParameter($r,!0);Y.at(R,Aa);let v=THREE.MathUtils.lerp(A.z,H.z,R),Z=v>=-1&&v<=1,Q=$r.distanceTo(Aa)<F*.5;if(Z&&Q){Y.start.fromBufferAttribute(h,z),Y.end.fromBufferAttribute(f,z),Y.start.applyMatrix4(s),Y.end.applyMatrix4(s);let D=new THREE.Vector3,V=new THREE.Vector3;r.distanceSqToSegment(Y.start,Y.end,V,D),e.push({point:V,pointOnLine:D,distance:r.origin.distanceTo(V),object:this,face:null,faceIndex:z,uv:null,uv2:null})}}}}};Ct.prototype.isLineSegments2=!0;var Le=class extends ve{constructor(){super(),this.type="LineGeometry"}setPositions(t){for(var e=t.length-3,o=new Float32Array(2*e),r=0;r<e;r+=3)o[2*r]=t[r],o[2*r+1]=t[r+1],o[2*r+2]=t[r+2],o[2*r+3]=t[r+3],o[2*r+4]=t[r+4],o[2*r+5]=t[r+5];return super.setPositions(o),this}setColors(t){for(var e=t.length-3,o=new Float32Array(2*e),r=0;r<e;r+=3)o[2*r]=t[r],o[2*r+1]=t[r+1],o[2*r+2]=t[r+2],o[2*r+3]=t[r+3],o[2*r+4]=t[r+4],o[2*r+5]=t[r+5];return super.setColors(o),this}fromLine(t){var e=t.geometry;if(e.isGeometry){console.error("THREE.LineGeometry no longer supports Geometry. Use THREE.BufferGeometry instead.");return}else e.isBufferGeometry&&this.setPositions(e.attributes.position.array);return this}};Le.prototype.isLineGeometry=!0;var Dt=class extends Ct{constructor(t=new Le,e=new Fe({color:Math.random()*16777215})){super(t,e),this.type="Line2"}};Dt.prototype.isLine2=!0;var Wa=new Le;Wa.setPositions([0,0,0,0,0,-1]);var mo=class extends THREE.Object3D{constructor(e,o=1){super();p(this,"line");p(this,"_length",1);this.line=new Dt(Wa,ma({color:e,linewidth:o})),this.line.computeLineDistances(),this.add(this.line)}get length(){return this._length}set length(e){this._length=e,this.line.scale.set(1,1,e)}};var ho=class extends lo{constructor(e,o,r,i,a){super("remote",18,e,a||new Ye);p(this,"object");p(this,"laser");p(this,"pTarget",new THREE.Vector3);p(this,"qTarget",new THREE.Quaternion().identity());this.laser=new mo(r?je:Ke,.002),this.laser.length=30;let s=new G(.05,.05,.05,Nr);s.add(this.laser);let u=new G(.05,.05,.05,Nr);this.object=Da(`${o}-arm`,s,u),i===1?s.position.set(0,0,-.2):(i===15||i===16||i===17)&&u.position.set(0,0,.2),this.object.name=`remote:${o}:${Oe[i]}`,this.cursor.object.name=`${this.object.name}:cursor`}setState(e,o,r,i,a){this.origin.copy(o),this.direction.copy(r),this.cursor.visible=!0,this.evtSys.fireRay(this),this.updateCursor(e,this.curHit,3),o.add(a),this.curHit&&r.copy(this.curHit.point).sub(o).normalize(),io(i,r,o,Oa),lc.copy(this.object.parent.matrixWorld).invert().multiply(Oa).decompose(this.pTarget,this.qTarget,cc)}animate(e){this.object.position.lerp(this.pTarget,e*.01),this.object.quaternion.slerp(this.qTarget,e*.01)}update(){}isPressed(e){return!1}},cc=new THREE.Vector3,lc=new THREE.Matrix4,Oa=new THREE.Matrix4;var go="HTMLCanvasElement"in globalThis,ES="HTMLImageElement"in globalThis,Na=!1,fo=!Na&&"OffscreenCanvas"in globalThis,Ua=!Na&&"createImageBitmap"in globalThis;function za(n){return go&&n instanceof HTMLCanvasElement}function Va(n){return fo&&n instanceof OffscreenCanvas}function Ga(n){return Ua&&n instanceof ImageBitmap}function pc(n,t){let e=n.getContext("2d");if(T(e))throw new Error("Could not create 2d context for canvas");e.drawImage(t,0,0)}function Fc(){try{return new OffscreenCanvas(1,1).getContext("2d")!=null}catch{return!1}}var mc=fo&&Fc(),xo=mc&&gc||go&&Jr||null,ja=go?Jr:xo;function dc(){try{return new OffscreenCanvas(1,1).getContext("webgl2")!=null}catch{return!1}}var MS=fo&&dc();function hc(){if(!go&&!fo)return!1;try{return xo(1,1).getContext("bitmaprenderer")!=null}catch{return!1}}var bS=Ua&&hc();function gc(n,t){return new OffscreenCanvas(n,t)}function Jr(n,t){return ka(wa(n),Sa(t))}function Ka(n){let t=Jr(n.width,n.height);return pc(t,n),t}function $a(n,t,e,o=1){return t=Math.floor(t*o),e=Math.floor(e*o),n.width!=t||n.height!=e?(n.width=t,n.height=e,!0):!1}function fc(n){return d(n.textBaseline)}function xc(n,t,e,o=1){let r=n.imageSmoothingEnabled,i=n.textBaseline,a=n.textAlign,s=n.font,u=$a(n.canvas,t,e,o);return u&&(n.imageSmoothingEnabled=r,n.textBaseline=i,n.textAlign=a,n.font=s),u}function Yr(n,t,e,o=1){return fc(n)?xc(n,t,e,o):$a(n.canvas,t,e,o)}var yS=le("juniper::loadedFonts",()=>[]);function qa(n){let t=[];return n.fontStyle&&n.fontStyle!=="normal"&&t.push(n.fontStyle),n.fontVariant&&n.fontVariant!=="normal"&&t.push(n.fontVariant),n.fontWeight&&n.fontWeight!=="normal"&&t.push(n.fontWeight),t.push(`${n.fontSize}px`),t.push(n.fontFamily),t.join(" ")}var So=class extends j{constructor(e,o,r){super();p(this,"_canvas");p(this,"_scale",250);p(this,"_g");p(this,"_visible",!0);p(this,"wasVisible",null);p(this,"redrawnEvt",new Ee("redrawn"));p(this,"element",null);d(r)&&d(r.scale)&&(this._scale=r.scale),this._canvas=ja(e,o),this._g=this.canvas.getContext("2d"),za(this._canvas)&&(this.element=this._canvas)}fillRect(e,o,r,i,a,s){this.g.fillStyle=e,this.g.fillRect(o+s,r+s,i-2*s,a-2*s)}drawText(e,o,r,i){this.g.textAlign=i,this.g.strokeText(e,o,r),this.g.fillText(e,o,r)}redraw(){(this.visible||this.wasVisible)&&this.onRedraw()&&(this.wasVisible=this.visible,this.dispatchEvent(this.redrawnEvt))}get canvas(){return this._canvas}get g(){return this._g}get imageWidth(){return this.canvas.width}get imageHeight(){return this.canvas.height}get aspectRatio(){return this.imageWidth/this.imageHeight}get width(){return this.imageWidth/this.scale}get height(){return this.imageHeight/this.scale}get scale(){return this._scale}set scale(e){this.scale!==e&&(this._scale=e,this.redraw())}get visible(){return this._visible}set visible(e){this.visible!==e&&(this.wasVisible=this._visible,this._visible=e,this.redraw())}};var wo=class extends So{constructor(e){super(10,10,e);this.trueWidth=null;this.trueHeight=null;this.trueFontSize=null;this.dx=null;this._minWidth=null;this._maxWidth=null;this._minHeight=null;this._maxHeight=null;this._freezeDimensions=!1;this._dimensionsFrozen=!1;this._bgFillColor=null;this._bgStrokeColor=null;this._bgStrokeSize=null;this._textStrokeColor=null;this._textStrokeSize=null;this._textFillColor="black";this._textDirection="horizontal";this._wrapWords=!0;this._fontStyle="normal";this._fontVariant="normal";this._fontWeight="normal";this._fontFamily="sans-serif";this._fontSize=20;this._value=null;d(e)&&(d(e.minWidth)&&(this._minWidth=e.minWidth),d(e.maxWidth)&&(this._maxWidth=e.maxWidth),d(e.minHeight)&&(this._minHeight=e.minHeight),d(e.maxHeight)&&(this._maxHeight=e.maxHeight),d(e.freezeDimensions)&&(this._freezeDimensions=e.freezeDimensions),d(e.textStrokeColor)&&(this._textStrokeColor=e.textStrokeColor),d(e.textStrokeSize)&&(this._textStrokeSize=e.textStrokeSize),d(e.bgFillColor)&&(this._bgFillColor=e.bgFillColor),d(e.bgStrokeColor)&&(this._bgStrokeColor=e.bgStrokeColor),d(e.bgStrokeSize)&&(this._bgStrokeSize=e.bgStrokeSize),d(e.value)&&(this._value=e.value),d(e.textFillColor)&&(this._textFillColor=e.textFillColor),d(e.textDirection)&&(this._textDirection=e.textDirection),d(e.wrapWords)&&(this._wrapWords=e.wrapWords),d(e.fontStyle)&&(this._fontStyle=e.fontStyle),d(e.fontVariant)&&(this._fontVariant=e.fontVariant),d(e.fontWeight)&&(this._fontWeight=e.fontWeight),d(e.fontFamily)&&(this._fontFamily=e.fontFamily),d(e.fontSize)&&(this._fontSize=e.fontSize),d(e.padding)&&(N(e.padding)?this._padding={left:e.padding,right:e.padding,top:e.padding,bottom:e.padding}:this._padding=e.padding)),T(this._padding)&&(this._padding={top:0,right:0,bottom:0,left:0}),this.redraw()}get minWidth(){return this._minWidth}set minWidth(e){this.minWidth!==e&&(this._minWidth=e,this.redraw())}get maxWidth(){return this._maxWidth}set maxWidth(e){this.maxWidth!==e&&(this._maxWidth=e,this.redraw())}get minHeight(){return this._minHeight}set minHeight(e){this.minHeight!==e&&(this._minHeight=e,this.redraw())}get maxHeight(){return this._maxHeight}set maxHeight(e){this.maxHeight!==e&&(this._maxHeight=e,this.redraw())}get padding(){return this._padding}set padding(e){if(e instanceof Array)throw new Error("Invalid padding");(this.padding.top!==e.top||this.padding.right!=e.right||this.padding.bottom!=e.bottom||this.padding.left!=e.left)&&(this._padding=e,this.redraw())}get wrapWords(){return this._wrapWords}set wrapWords(e){this.wrapWords!==e&&(this._wrapWords=e,this.redraw())}get textDirection(){return this._textDirection}set textDirection(e){this.textDirection!==e&&(this._textDirection=e,this.redraw())}get fontStyle(){return this._fontStyle}set fontStyle(e){this.fontStyle!==e&&(this._fontStyle=e,this.redraw())}get fontVariant(){return this._fontVariant}set fontVariant(e){this.fontVariant!==e&&(this._fontVariant=e,this.redraw())}get fontWeight(){return this._fontWeight}set fontWeight(e){this.fontWeight!==e&&(this._fontWeight=e,this.redraw())}get fontSize(){return this._fontSize}set fontSize(e){this.fontSize!==e&&(this._fontSize=e,this.redraw())}get fontFamily(){return this._fontFamily}set fontFamily(e){this.fontFamily!==e&&(this._fontFamily=e,this.redraw())}get textFillColor(){return this._textFillColor}set textFillColor(e){this.textFillColor!==e&&(this._textFillColor=e,this.redraw())}get textStrokeColor(){return this._textStrokeColor}set textStrokeColor(e){this.textStrokeColor!==e&&(this._textStrokeColor=e,this.redraw())}get textStrokeSize(){return this._textStrokeSize}set textStrokeSize(e){this.textStrokeSize!==e&&(this._textStrokeSize=e,this.redraw())}get bgFillColor(){return this._bgFillColor}set bgFillColor(e){this.bgFillColor!==e&&(this._bgFillColor=e,this.redraw())}get bgStrokeColor(){return this._bgStrokeColor}set bgStrokeColor(e){this.bgStrokeColor!==e&&(this._bgStrokeColor=e,this.redraw())}get bgStrokeSize(){return this._bgStrokeSize}set bgStrokeSize(e){this.bgStrokeSize!==e&&(this._bgStrokeSize=e,this.redraw())}get value(){return this._value}set value(e){this.value!==e&&(this._value=e,this.redraw())}draw(e,o,r){this.canvas.width>0&&this.canvas.height>0&&e.drawImage(this.canvas,o,r,this.width,this.height)}split(e){return this.wrapWords?e.split(" ").join(`
`).replace(/\r\n/,`
`).split(`
`):e.replace(/\r\n/,`
`).split(`
`)}unfreeze(){this._dimensionsFrozen=!1}onRedraw(){if(this.g.clearRect(0,0,this.canvas.width,this.canvas.height),this.visible&&this.fontFamily&&this.fontSize&&(this.textFillColor||this.textStrokeColor&&this.textStrokeSize)&&this.value){let e=this.split(this.value),o=this.textDirection&&this.textDirection.indexOf("vertical")===0;if(this.trueWidth===null||this.trueHeight===null||this.dx===null||this.trueFontSize===null||!this._dimensionsFrozen){this._dimensionsFrozen=this._freezeDimensions;let i=this.minWidth!=null||this.maxWidth!=null||this.minHeight!=null||this.maxHeight!=null,a=((this.minWidth||0)-this.padding.right-this.padding.left)*this.scale,s=((this.maxWidth||4096)-this.padding.right-this.padding.left)*this.scale,u=((this.minHeight||0)-this.padding.top-this.padding.bottom)*this.scale,c=((this.maxHeight||4096)-this.padding.top-this.padding.bottom)*this.scale,l=o?u:a,F=o?c:s,h=o?a:u,f=o?s:c,x=[];this.trueWidth=0,this.trueHeight=0,this.dx=0;let w=!1,C=!1,U=1e4,P=0;this.trueFontSize=Wo(this.fontSize*this.scale,P,U);let S=null,z=Number.MAX_VALUE;do{let v=this.fontSize;this._fontSize=this.trueFontSize;let Z=qa(this);this._fontSize=v,this.g.textAlign="center",this.g.textBaseline="middle",this.g.font=Z,this.trueWidth=0,this.trueHeight=0;for(let Q of e){let D=this.g.measureText(Q);this.trueWidth=Math.max(this.trueWidth,D.width),this.trueHeight+=this.trueFontSize,N(D.actualBoundingBoxLeft)&&N(D.actualBoundingBoxRight)&&N(D.actualBoundingBoxAscent)&&N(D.actualBoundingBoxDescent)&&(i||(this.trueWidth=D.actualBoundingBoxLeft+D.actualBoundingBoxRight,this.trueHeight=D.actualBoundingBoxAscent+D.actualBoundingBoxDescent,this.dx=(D.actualBoundingBoxLeft-this.trueWidth/2)/2))}if(i){let Q=this.trueWidth-l,D=this.trueWidth-F,V=this.trueHeight-h,Xr=this.trueHeight-f,es=Math.abs(Q),ts=Math.abs(D),ns=Math.abs(V),os=Math.abs(Xr);w=D>1||Xr>1,C=Q<-1&&V<-1;let Zr=Math.min(es,Math.min(ts,Math.min(ns,os)));Zr<z&&(z=Zr,S=this.g.font),(w||C)&&x.indexOf(this.g.font)>-1&&S&&(this.g.font=S,w=!1,C=!1),w?(U=this.trueFontSize,this.trueFontSize=(P+this.trueFontSize)/2):C&&(P=this.trueFontSize,this.trueFontSize=(this.trueFontSize+U)/2)}x.push(this.g.font)}while(w||C);i&&(this.trueWidth<l?this.trueWidth=l:this.trueWidth>F&&(this.trueWidth=F),this.trueHeight<h?this.trueHeight=h:this.trueHeight>f&&(this.trueHeight=f));let Re=this.trueWidth+this.scale*(this.padding.right+this.padding.left),R=this.trueHeight+this.scale*(this.padding.top+this.padding.bottom);try{Yr(this.g,Re,R)}catch(v){throw console.error(v),v}}this.bgFillColor?(this.g.fillStyle=this.bgFillColor,this.g.fillRect(0,0,this.canvas.width,this.canvas.height)):this.g.clearRect(0,0,this.canvas.width,this.canvas.height),this.textStrokeColor&&this.textStrokeSize&&(this.g.lineWidth=this.textStrokeSize*this.scale,this.g.strokeStyle=this.textStrokeColor),this.textFillColor&&(this.g.fillStyle=this.textFillColor);let r=.5*(e.length-1);for(let i=0;i<e.length;++i){let a=e[i],s=(i-r)*this.trueFontSize,u=this.dx+this.trueWidth/2+this.scale*this.padding.left,c=s+this.trueHeight/2+this.scale*this.padding.top;this.textStrokeColor&&this.textStrokeSize&&this.g.strokeText(a,u,c),this.textFillColor&&this.g.fillText(a,u,c)}if(this.bgStrokeColor&&this.bgStrokeSize){this.g.strokeStyle=this.bgStrokeColor,this.g.lineWidth=this.bgStrokeSize*this.scale;let i=this.bgStrokeSize/2;this.g.strokeRect(i,i,this.canvas.width-this.bgStrokeSize,this.canvas.height-this.bgStrokeSize)}if(o){let i=xo(this.canvas.height,this.canvas.width),a=i.getContext("2d");a?(a.translate(i.width/2,i.height/2),this.textDirection==="vertical"||this.textDirection==="vertical-left"?a.rotate(Math.PI/2):this.textDirection==="vertical-right"&&a.rotate(-Math.PI/2),a.translate(-this.canvas.width/2,-this.canvas.height/2),a.drawImage(this.canvas,0,0),Yr(this.g,i.width,i.height)):console.warn("Couldn't rotate the TextImage"),this.g.drawImage(i,0,0)}return!0}else return!1}};var Ja=le("Juniper:ScaledItems",()=>new Map);function Ya(n){let t=Ja.get(n);t&&(Ja.delete(n),t.dispose())}function yt(n){let t=new Array,e=new Set;for(t.push(n);t.length>0;){let o=t.shift();o&&!e.has(o)&&(e.add(o),o.isMesh&&t.push(o.material,o.geometry),o.isMaterial&&t.push(...Object.values(o)),o.isObject3D&&(t.push(...o.children),o.clear(),Ya(o)),Me(o)&&t.push(...o),Bi(o))}e.clear()}var Sc=new THREE.Matrix4,To=new THREE.Vector3;function Qr(n,t,e,o,r){Sc.copy(n.matrixWorld).invert().multiply(t.matrixWorld).decompose(To,o,r),e.set(To.x,To.y,To.z,1)}var ko=new THREE.PlaneBufferGeometry(1,1,1,1);ko.name="PlaneGeom";var Qa=class extends THREE.Mesh{constructor(e,o,r,i){super(ko,r);this.isCollider=i;this.scale.set(e,o,1)}};var Xa=39.3701,Qe=class extends THREE.Mesh{constructor(e,o){super(e,o);p(this,"_imageWidth",0);p(this,"_imageHeight",0)}copy(e,o=!0){return super.copy(e,o),this._imageWidth=e.imageWidth,this._imageHeight=e.imageHeight,this}get imageWidth(){return this._imageWidth}get imageHeight(){return this._imageHeight}get imageAspectRatio(){return this.imageWidth/this.imageHeight}get objectWidth(){return this.scale.x}set objectWidth(e){this.scale.x=e,this.scale.y=e/this.imageAspectRatio}get objectHeight(){return this.scale.y}set objectHeight(e){this.scale.x=this.imageAspectRatio*e,this.scale.y=e}get pixelDensity(){return this.imageWidth/this.objectWidth/Xa}set pixelDensity(e){let o=e*Xa;this.objectWidth=this.imageWidth/o}setImage(e){return Ga(e)&&(e=Ka(e)),Va(e)&&(e=e),e instanceof HTMLVideoElement?(this.material.map=new THREE.VideoTexture(e),this._imageWidth=e.videoWidth,this._imageHeight=e.videoHeight):(this.material.map=new THREE.Texture(e),this._imageWidth=e.width,this._imageHeight=e.height,this.material.map.needsUpdate=!0),this.material.needsUpdate=!0,this.material.map}async loadImage(e,o,r){let{content:i}=await e.get(o).progress(r).image(),a=this.setImage(i);a.name=o}updateTexture(){let e=this.material.map.image;N(e.width)&&N(e.height)&&(this.imageWidth!==e.width||this.imageHeight!==e.height)&&(this._imageWidth=e.width,this._imageHeight=e.height,this.material.map.dispose(),this.material.map=new THREE.Texture(e),this.material.needsUpdate=!0),this.material.map.needsUpdate=!0}};var Eo=new THREE.Vector4,Mo=new THREE.Quaternion,Xe=new THREE.Vector3,wc=0,Ze=class extends THREE.Object3D{constructor(e,o,r,i=null){super();this.isStatic=r;p(this,"lastMatrixWorld",new THREE.Matrix4);p(this,"layer",null);p(this,"tryWebXRLayers",!0);p(this,"wasUsingLayer",!1);p(this,"lastImage",null);p(this,"lastWidth",null);p(this,"lastHeight",null);p(this,"stereoLayoutName","mono");p(this,"env",null);p(this,"mesh",null);p(this,"webXRLayersEnabled",!0);if(e){this.setEnvAndName(e,o);let a=Ma(i)?i:Fa(Object.assign({},i,{name:this.name}));this.mesh=new Qe(ko,a),this.add(this.mesh)}}dispose(){yt(this.layer)}setEnvAndName(e,o){this.env=e,this.name=o,this.tryWebXRLayers&&(this.tryWebXRLayers=this.env&&this.env.hasXRCompositionLayers)}copy(e,o=!0){super.copy(e,o),this.setEnvAndName(e.env,e.name+ ++wc);for(let r=this.children.length-1;r>=0;--r){let i=this.children[r];i.parent instanceof Ze&&i instanceof Qe&&(i.removeFromParent(),this.mesh=new Qe(i.geometry,i.material))}return T(this.mesh)&&(this.mesh=e.mesh.clone(),this.add(this.mesh)),this}get needsLayer(){if(!Ca(this)||T(this.mesh.material.map)||T(this.mesh.material.map.image))return!1;let e=this.mesh.material.map.image;return e instanceof HTMLVideoElement?!e.paused||e.currentTime>0:!0}removeWebXRLayer(){if(d(this.layer)){this.wasUsingLayer=!1,this.env.removeWebXRLayer(this.layer);let e=this.layer;this.layer=null,setTimeout(()=>{e.destroy(),this.mesh.visible=!0},100)}}update(e,o){if(this.mesh.material.map&&this.mesh.material.map.image){let r=this.mesh.material.map instanceof THREE.VideoTexture,a=this.tryWebXRLayers&&this.webXRLayersEnabled&&d(o)&&(r&&d(this.env.xrMediaBinding)||!r&&d(this.env.xrBinding))&&this.needsLayer,s=a!==this.wasUsingLayer,u=this.mesh.material.map.image!==this.lastImage||this.mesh.material.needsUpdate||this.mesh.material.map.needsUpdate,c=this.mesh.imageWidth!==this.lastWidth||this.mesh.imageHeight!==this.lastHeight;if(this.wasUsingLayer=a,this.lastImage=this.mesh.material.map.image,this.lastWidth=this.mesh.imageWidth,this.lastHeight=this.mesh.imageHeight,(s||c)&&((!a||c)&&this.layer&&this.removeWebXRLayer(),a)){let l=this.env.referenceSpace;Qr(this.env.stage,this.mesh,Eo,Mo,Xe),this.lastMatrixWorld.copy(this.matrixWorld);let F=new XRRigidTransform(Eo,Mo),h=Xe.x/2,f=Xe.y/2,x=this.stereoLayoutName==="mono"?"mono":this.stereoLayoutName==="left-right"||this.stereoLayoutName==="right-left"?"stereo-left-right":"stereo-top-bottom";if(r){let w=this.stereoLayoutName==="right-left"||this.stereoLayoutName==="bottom-top";this.layer=this.env.xrMediaBinding.createQuadLayer(this.mesh.material.map.image,{space:l,layout:x,invertStereo:w,transform:F,width:h,height:f})}else this.layer=this.env.xrBinding.createQuadLayer({space:l,layout:x,textureType:"texture",isStatic:this.isStatic,viewPixelWidth:this.mesh.imageWidth,viewPixelHeight:this.mesh.imageHeight,transform:F,width:h,height:f});this.env.addWebXRLayer(this.layer,500),this.mesh.visible=!1}if(this.layer){if(u||this.layer.needsRedraw){let l=this.env.gl,F=this.env.xrBinding.getSubImage(this.layer,o);l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!0),l.bindTexture(l.TEXTURE_2D,F.colorTexture),l.texSubImage2D(l.TEXTURE_2D,0,0,0,l.RGBA,l.UNSIGNED_BYTE,this.mesh.material.map.image),l.generateMipmap(l.TEXTURE_2D),l.bindTexture(l.TEXTURE_2D,null)}ai(this.matrixWorld.elements,this.lastMatrixWorld.elements)>=0&&(Qr(this.env.stage,this.mesh,Eo,Mo,Xe),this.lastMatrixWorld.copy(this.matrixWorld),this.layer.transform=new XRRigidTransform(Eo,Mo),this.layer.width=Xe.x/2,this.layer.height=Xe.y/2)}}}};var Tc={type:"redrawn"},bo=class extends Ze{constructor(e,o,r){super(e,o,!1,r);p(this,"_textImage",null);p(this,"_onRedrawn");this._onRedrawn=this.onRedrawn.bind(this)}onRedrawn(){this.mesh.updateTexture(),this.scale.set(this._textImage.width,this._textImage.height,.01),this.dispatchEvent(Tc)}get textImage(){return this._textImage}set textImage(e){e!==this.textImage&&(this.textImage&&this.textImage.clearEventListeners(),this._textImage=e,this.textImage&&(this.textImage.addEventListener("redrawn",this._onRedrawn),this.mesh.setImage(this.textImage.canvas),this._onRedrawn()))}createTextImage(e){this.textImage=new wo(e)}get wrapWords(){return this._textImage.wrapWords}set wrapWords(e){this._textImage.wrapWords=e}get minWidth(){return this._textImage.minWidth}set minWidth(e){this._textImage.minWidth=e}get maxWidth(){return this._textImage.maxWidth}set maxWidth(e){this._textImage.maxWidth=e}get minHeight(){return this._textImage.minHeight}set minHeight(e){this._textImage.minHeight=e}get maxHeight(){return this._textImage.maxHeight}set maxHeight(e){this._textImage.maxHeight=e}get textDirection(){return this._textImage.textDirection}set textDirection(e){this._textImage.textDirection=e}get textScale(){return this._textImage.scale}set textScale(e){this._textImage.scale=e}get textWidth(){return this._textImage.width}get textHeight(){return this._textImage.height}get textPadding(){return this._textImage.padding}set textPadding(e){this._textImage.padding=e}get fontStyle(){return this._textImage.fontStyle}set fontStyle(e){this._textImage.fontStyle=e}get fontVariant(){return this._textImage.fontVariant}set fontVariant(e){this._textImage.fontVariant=e}get fontWeight(){return this._textImage.fontWeight}set fontWeight(e){this._textImage.fontWeight=e}get fontSize(){return this._textImage.fontSize}set fontSize(e){this._textImage.fontSize=e}get fontFamily(){return this._textImage.fontFamily}set fontFamily(e){this._textImage.fontFamily=e}get textFillColor(){return this._textImage.textFillColor}set textFillColor(e){this._textImage.textFillColor=e}get textStrokeColor(){return this._textImage.textStrokeColor}set textStrokeColor(e){this._textImage.textStrokeColor=e}get textStrokeSize(){return this._textImage.textStrokeSize}set textStrokeSize(e){this._textImage.textStrokeSize=e}get textBgColor(){return this._textImage.bgFillColor}set textBgColor(e){this._textImage.bgFillColor=e}get value(){return this._textImage.value}set value(e){this._textImage.value=e}};var Be=new THREE.Vector3,se=new THREE.Vector3,Co=new THREE.Vector3,vt=new THREE.Vector3,Do=new THREE.Vector3,Za=new THREE.Matrix4,kc=Math.PI/2,Ec={fontFamily:sa(),fontSize:20,fontWeight:"bold",textFillColor:"#ffffff",textStrokeColor:"#000000",textStrokeSize:.01,wrapWords:!1,padding:{top:.025,right:.05,bottom:.025,left:.05},maxHeight:.2},yo=class extends THREE.Object3D{constructor(e,o,r,i,a){super();this.env=e;this.defaultAvatarHeight=a;p(this,"avatar",null);p(this,"isInstructor",!1);p(this,"pointers",new Map);p(this,"head",null);p(this,"body",null);p(this,"height");p(this,"nameTag");p(this,"activity");p(this,"pTarget",new THREE.Vector3);p(this,"pEnd",new THREE.Vector3);p(this,"qTarget",new THREE.Quaternion().identity());p(this,"qEnd",new THREE.Quaternion().identity());p(this,"headFollower",null);p(this,"_headSize",1);p(this,"_headPulse",1);this.height=this.defaultAvatarHeight,this.name=o.userName,this.nameTag=new bo(this.env,`nameTag-${o.userName}-${o.userID}`),this.nameTag.createTextImage(Object.assign({},Ec,i)),this.nameTag.position.y=.25,this.userName=o.userName,this.add(this.nameTag),o.addEventListener("userPosed",s=>this.setPose(s.pose,s.height)),o.addEventListener("userPointer",s=>{this.setPointer(this.env.avatar.worldPos,s.name,s.pose)}),this.activity=new Ue(`remote-user-activity-${o.userName}-${o.userID}`,this.env.audio.audioCtx),r.addEventListener("sourceadded",s=>{ut(s.source,this.activity)})}dispose(){for(let e of this.pointers.keys())this.removeArm(e);this.activity.dispose()}get headSize(){return this._headSize}set headSize(e){this._headSize=e,this.refreshHead()}get headPulse(){return this._headPulse}set headPulse(e){this._headPulse=e,this.refreshHead()}refreshHead(){this.head&&this.head.scale.setScalar(this.headSize*this.headPulse)}get userName(){return this.nameTag.value}set userName(e){if(e){let o=e.match(/^(?:((?:student|instructor))_)?([^<>{}"]+)$/i);o&&(o.length===2?this.nameTag.value=o[1]:o.length===3?(this.isInstructor=o[1]&&o[1].toLocaleLowerCase()==="instructor",this.isInstructor?this.nameTag.value=ua.value+o[2]:this.nameTag.value=o[2]):this.nameTag.value="???")}}setAvatar(e){this.avatar&&(this.remove(this.avatar),this.head=null,this.body=null),e&&(this.avatar=e,this.avatar.traverse(o=>{o.name==="Head"?this.head=o:o.name==="Body"&&(this.body=o)}),this.head&&this.body&&(this.headFollower=new Yn("AvatarBody",.05,kc,0,5),this.body.parent.add(this.headFollower),this.body.add(this.nameTag),this.headFollower.add(this.body)),this.add(this.avatar))}removeArm(e){let o=this.pointers.get(e);o&&(this.body.remove(o.object),this.pointers.delete(e),o.cursor&&this.env.stage.remove(o.cursor.object))}refreshCursors(){for(let e of this.pointers.values())e.cursor&&(e.cursor=this.env.cursor3D.clone())}update(e){if(this.headPulse=.2*this.activity.level+1,this.pEnd.lerp(this.pTarget,e*.01),this.qEnd.slerp(this.qTarget,e*.01),this.head&&this.body){this.head.position.copy(this.pEnd),this.head.quaternion.copy(this.qEnd),this.head.getWorldPosition(Be),this.head.getWorldDirection(se);let o=$n(se);this.headFollower.update(Be.y-this.parent.position.y,Be,o,e);let r=this.height/this.defaultAvatarHeight;this.headSize=r,this.body.scale.setScalar(r),se.copy(this.env.avatar.worldPos),this.body.worldToLocal(se),se.sub(this.body.position).normalize().multiplyScalar(.25),this.nameTag.position.set(0,-.25,0).add(se)}else this.position.copy(this.pEnd),this.quaternion.copy(this.qEnd);for(let o of this.pointers.values())o.animate(e);this.nameTag.lookAt(this.env.avatar.worldPos)}setPose(e,o){vt.fromArray(e.o),Be.fromArray(e.p).add(vt),se.fromArray(e.f),Co.fromArray(e.u),io(Co,se,Be,Za),Za.decompose(this.pTarget,this.qTarget,this.scale),this.height=o}setPointer(e,o,r){let i=this.pointers.get(o);i||(i=new ho(this.env.eventSystem,this.userName,this.isInstructor,o,this.env.cursor3D&&this.env.cursor3D.clone()),this.pointers.set(o,i),qe(this.body,i),i.cursor&&qe(this.env.stage,i.cursor),o===1?(this.removeArm(15),this.removeArm(16),this.removeArm(17)):(o===15||o===16||o===17)&&(this.removeArm(1),this.removeArm(2),this.removeArm(3),this.removeArm(4),this.removeArm(5),this.removeArm(6),this.removeArm(7),this.removeArm(8),this.removeArm(9),this.removeArm(10),this.removeArm(11),this.removeArm(12),this.removeArm(13),this.removeArm(14))),Be.fromArray(r.p),se.fromArray(r.f),Co.fromArray(r.u),vt.fromArray(r.o),o===1&&this.body?Do.set(.2,-.6,0).applyQuaternion(this.body.quaternion):Oe[o].startsWith("Touch")&&this.body?Do.set(0,-.5,0).applyQuaternion(this.body.quaternion):Do.set(0,0,0),vt.add(Do),i.setState(e,Be,se,Co,vt)}};var vo=class extends THREE.Object3D{constructor(e){super();this.color=e;p(this,"center",null);p(this,"xp");p(this,"yp");p(this,"zn");d(this.color)&&(this.center=new G(.5,.5,.5,J({color:this.color})),this.add(this.center)),this.xp=new G(1,.1,.1,ga),this.yp=new G(.1,1,.1,ha),this.zn=new G(.1,.1,1,da),this.xp.position.x=1,this.yp.position.y=1,this.zn.position.z=-1,this.add(this.xp,this.yp,this.zn)}copy(e,o=!0){return super.copy(e,o),this.color=e.color,this.center=new G(.5,.5,.5,J({color:e.color})),this}get size(){return this.xp.scale.x}set size(e){d(this.center)&&this.center.scale.setScalar(e),this.xp.scale.setScalar(.1*e),this.yp.scale.setScalar(.1*e),this.zn.scale.setScalar(.1*e),this.xp.scale.x=this.yp.scale.y=this.zn.scale.z=e,this.xp.position.x=this.yp.position.y=e,this.zn.position.z=-e}};var Lo=class extends j{constructor(e){super();this.env=e}};var Bo=class extends Lo{constructor(e){super(e);this.users=new Map;this.remoteUsers=new THREE.Object3D;this.conference=null;this.defaultAvatarHeight=1.75;this.avatarModel=null;this.avatarNameTagFont=null;this.hubName=null;this.userType=null;this.userName=null;this.meetingID=null;this.roomName=null}get ready(){return this.conference&&this.conference.ready}async init(e){if(this.defaultAvatarHeight=e.get("defaultAvatarHeight"),!this.defaultAvatarHeight)throw new Error("Missing defaultAvatarHeight parameter");if(this.hubName=e.get("hub"),!this.hubName)throw new Error("Missing hub parameter");if(this.avatarNameTagFont=e.get("nameTagFont"),!this.avatarNameTagFont)throw new Error("Missing nameTagFont parameter");this.env.avatar.addEventListener("avatarmoved",r=>this.conference.setLocalPose(r.px,r.py,r.pz,r.fx,r.fy,r.fz,r.ux,r.uy,r.uz,r.height)),this.env.eventSystem.addEventListener("objectMoved",r=>{this.conference.setLocalPointer(r.name,r.px,r.py,r.pz,r.fx,r.fy,r.fz,r.ux,r.uy,r.uz)}),this.env.addEventListener("newcursorloaded",()=>{for(let r of this.users.values())r.refreshCursors()}),this.env.addEventListener("roomjoined",r=>this.join(r.roomName)),this.env.addEventListener("sceneclearing",()=>this.env.foreground.remove(this.remoteUsers)),this.env.addEventListener("scenecleared",()=>this.env.foreground.add(this.remoteUsers)),this.env.muteMicButton.visible=!0,this.env.muteMicButton.addEventListener("click",async()=>{this.conference.audioMuted=this.env.muteMicButton.active=!this.conference.audioMuted}),this.remoteUsers.name="Remote Users",this.env.audio.offsetRadius=1.25,this.conference=new jn(this.env.audio,this.hubName,!1);let o=r=>{this.env.avatar.name=r.userID};this.conference.addEventListener("roomJoined",o),this.conference.addEventListener("roomLeft",o),this.conference.addEventListener("userJoined",r=>{let i=new yo(this.env,r.user,r.source,this.avatarNameTagFont,this.defaultAvatarHeight),a=this.avatarModel?this.avatarModel.clone():new vo(16776960);i.setAvatar(a),i.userName=r.user.userName,this.users.set(r.user.userID,i),this.remoteUsers.add(i),this.env.audio.playClip("join")}),this.conference.addEventListener("userNameChanged",r=>{let i=this.users.get(r.user.userID);i&&(i.userName=r.newUserName)}),this.conference.addEventListener("userLeft",r=>{let i=this.users.get(r.user.userID);i&&(this.remoteUsers.remove(i),this.users.delete(r.user.userID),yt(i),this.env.audio.playClip("leave"))})}async show(e){this.env.foreground.add(this.remoteUsers),d(this.env.currentRoom)&&await this.join(this.env.currentRoom)}dispose(){this.env.foreground.remove(this.remoteUsers)}async loadAvatar(e,o){this.avatarModel=await this.env.loadModel(e,o),this.avatarModel=this.avatarModel.children[0];for(let r of this.users.keys()){let i=this.users.get(r),a=i.avatar;i.setAvatar(this.avatarModel.clone()),yt(a)}}async setConferenceInfo(e,o,r){this.userType=e,this.userName=o,this.meetingID=r,await this.checkConference()}async join(e){this.roomName=e,await this.checkConference()}async checkConference(){if(d(this.userType)&&d(this.userName)&&d(this.meetingID)&&d(this.roomName)){let e=`${this.roomName}_${this.meetingID}`.toLocaleLowerCase(),o=`${this.userType}_${this.userName}`;this.conference.roomName!==e&&(await this.conference.connect(),await this.conference.identify(o),await this.conference.join(e))}}async load(e){await ki(e,o=>this.env.audio.loadBasicClip("join","/audio/door_open.mp3",.25,o),o=>this.env.audio.loadBasicClip("leave","/audio/door_close.mp3",.25,o),o=>this.loadAvatar("/models/Avatar.glb",o))}update(e){for(let o of this.users.values())o.update(e.dt)}};var Kw=Bo;export{Kw as default};
//# sourceMappingURL=index.min.js.map
